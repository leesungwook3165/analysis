<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Investment Portfolio Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f4f6f9;
  margin: 0;
  padding: 20px;
}

h1, h2, h3 {
  margin: 10px 0;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.tabs button {
  margin-right: 6px;
  padding: 8px 14px;
  border: none;
  background: #ddd;
  cursor: pointer;
  border-radius: 4px;
}

.tabs button.active {
  background: #2c3e50;
  color: #fff;
}

.panel {
  display: none;
  background: #fff;
  padding: 20px;
  margin-top: 15px;
  border-radius: 6px;
}

.panel.active {
  display: block;
}

label {
  display: block;
  margin-top: 10px;
  font-size: 13px;
  color: #555;
}

input, select {
  width: 220px;
  padding: 6px;
}

button {
  margin-top: 15px;
  padding: 10px 16px;
  border: none;
  background: #34495e;
  color: white;
  cursor: pointer;
  border-radius: 4px;
}

.kpi {
  display: flex;
  gap: 12px;
  margin-top: 15px;
}

.card {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  width: 160px;
  text-align: center;
}

.note {
  color: #888;
  font-size: 13px;
  margin-top: 10px;
}
/* ê¸€ë¨í•‘ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
table.grid {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
table.grid th, table.grid td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}
table.grid input {
  width: 80%;
  padding: 4px;
  text-align: right;
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 14px;
}

.table-large-container {
  margin-top: 12px;
  overflow: auto;
  max-width: 100%;
  border: 1px solid #eee;
  padding: 8px;
  background: #fafafa;
  min-height: 180px;
}

.table-large-container .empty {
  color: #666;
  text-align: center;
  padding: 24px 8px;
}

/* ë¼ë””ì˜¤ë¥¼ ê°€ë¡œë¡œ ì •ë ¬ */
.scenario { 
  margin-top: 12px; 
  display: flex;
  gap: 8px;
}
.scenario label { 
  display: inline-flex;
  align-items: center;
  padding: 10px 18px;
  background: #f5f5f5;
  border: 2px solid #ddd;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
  font-size: 14px;
}
.scenario label:hover {
  background: #e8e8e8;
  border-color: #bbb;
}
.scenario input[type="radio"] {
  margin-right: 8px;
  width: 18px;
  height: 18px;
  cursor: pointer;
}
.scenario input[type="radio"]:checked + span,
.scenario label:has(input[type="radio"]:checked) {
  background: #2c3e50;
  color: white;
  border-color: #2c3e50;
}

table.large {
  border-collapse: collapse;
  width: 100%;
}

table.large th, table.large td {
  border: 1px solid #ddd;
  padding: 6px;
  min-width: 60px;
  text-align: center;
}

/* Toast notifications */
#toastContainer{position:fixed;top:20px;right:20px;z-index:9999;}
.toast{background:#333;color:#fff;padding:10px 14px;border-radius:6px;margin-top:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);opacity:0.95}
.toast.error{background:#b00020}
.toast.success{background:#2e7d32}

/* occupancy settings small tweaks */
#occSettings input[type="number"]{width:70px;text-align:right;padding-right:6px}

/* Collapsible section styling */
.collapsible-section {
  margin: 20px 0;
  border: 2px solid #3498db;
  border-radius: 10px;
  overflow: hidden;
  background: #fff;
}

.collapsible-section summary {
  cursor: pointer;
  padding: 18px 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 18px;
  font-weight: 700;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.collapsible-section summary:hover {
  background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.collapsible-section summary::before {
  content: 'â–¼';
  font-size: 14px;
  transition: transform 0.3s ease;
  display: inline-block;
}

.collapsible-section[open] summary::before {
  transform: rotate(180deg);
}

.collapsible-section summary::marker {
  display: none;
}

.collapsible-section summary::-webkit-details-marker {
  display: none;
}

.collapsible-content {
  padding: 20px;
  background: #f8f9fa;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* KPI Cards styling */
.kpi-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  text-align: center;
  color: white;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.kpi-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* ê° KPI ì¹´ë“œì˜ ê³ ìœ í•œ ìƒ‰ìƒ */
.kpi-card-1 {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.kpi-card-2 {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.kpi-card-3 {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.kpi-card-4 {
  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.kpi-card-5 {
  background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.kpi-card-6 {
  background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
}

.kpi-card-7 {
  background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
  color: #333;
}

.kpi-card-8 {
  background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%);
}

.kpi-label {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 10px;
  opacity: 0.9;
}

.kpi-value {
  font-size: 32px;
  font-weight: 700;
  margin: 10px 0;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.kpi-unit {
  font-size: 13px;
  opacity: 0.8;
  font-weight: 500;
}

/* Financial tables styling */
.financial-section {
  margin: 20px 0;
  padding: 15px;
  background: #fafafa;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}
.financial-section h3 {
  margin: 0 0 12px 0;
  color: #2c3e50;
  font-size: 16px;
  border-bottom: 2px solid #3498db;
  padding-bottom: 6px;
}
.financial-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 8px;
  font-size: 13px;
}
.financial-table th {
  background: #e8f4f8;
  padding: 8px;
  text-align: left;
  font-weight: 600;
  border: 1px solid #d0d0d0;
}
.financial-table td {
  padding: 6px 8px;
  border: 1px solid #d0d0d0;
}
.financial-table input[type="text"],
.financial-table input[type="number"] {
  width: 95%;
  padding: 4px 6px;
  border: 1px solid #ccc;
  border-radius: 3px;
}
.financial-table input[type="text"]:focus,
.financial-table input[type="number"]:focus {
  border-color: #3498db;
  outline: none;
}
.financial-table .item-name {
  width: 45%;
}
.financial-table .item-value {
  width: 45%;
}
.financial-table .item-actions {
  width: 10%;
  text-align: center;
}
.btn-small {
  padding: 4px 8px;
  font-size: 12px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  margin: 2px;
}
.btn-add {
  background: #27ae60;
  color: white;
}
.btn-add:hover {
  background: #229954;
}
.btn-delete {
  background: #e74c3c;
  color: white;
}
.btn-delete:hover {
  background: #c0392b;
}
.financial-summary {
  margin-top: 8px;
  padding: 8px 12px;
  background: #fff;
  border-radius: 4px;
  font-weight: 600;
  border-left: 4px solid #3498db;
}
</style>
</head>

<body>

<header>
  <h1>ì‚¬ì—… í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ì§€ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
  <div class="tabs">
    <button class="active" data-tab="glamping">ê¸€ë¨í•‘</button>
    <button data-tab="venture">ì‹ ê·œ ë²¤ì²˜</button>
    <button data-tab="ferry">ì—¬ê°ì„ </button>
    <button data-tab="total">í†µí•© ë¶„ì„</button>
  </div>
</header>

<!-- Toast container for user messages -->
<div id="toastContainer"></div>

<!-- KPI -->
<div class="kpi">
  <div class="card">ë§¤ì¶œ<br><strong id="kRevenue">-</strong></div>
  <div class="card">EBITDA<br><strong id="kEbitda">-</strong></div>
  <div class="card">IRR<br><strong id="kIrr">-</strong></div>
</div>

<!-- ì—¬ê°ì„  -->
<section id="ferry" class="panel">
<h2>ì—¬ê°ì„  ì‚¬ì—… (ì‹ ì¡° í¬í•¨)</h2>

<label>ì„ ê°€ (ì–µì›)</label>
<input id="shipPrice" type="number" value="300">

<label>ë³´ì¡°ê¸ˆ (ì–µì›)</label>
<input id="subsidy" type="number" value="60">

<label>ì—°ê°„ ìš´í•­ì¼ìˆ˜</label>
<input id="days" type="number" value="330">

<label>ì¼ í‰ê·  ìŠ¹ê°ìˆ˜</label>
<input id="passengers" type="number" value="800">

<label>ê°ë‹¨ê°€ (ì›)</label>
<input id="fare" type="number" value="50000">

<label>ì—°ê°„ ìš´ì˜ë¹„ (ì–µì›)</label>
<input id="opex" type="number" value="120">

<h3>ì‹œë‚˜ë¦¬ì˜¤</h3>
<label>ê°ë‹¨ê°€ ì¡°ì •</label>
<input id="fareSlider" type="range" min="0.8" max="1.2" step="0.05" value="1">
<span id="fareRate">100%</span>

<label>ë³´ì¡°ê¸ˆ ì ìš©</label>
<select id="subsidyToggle">
  <option value="on">ON</option>
  <option value="off">OFF</option>
</select>

<button id="ferryAnalyze">ì—¬ê°ì„  ë¶„ì„ ì‹¤í–‰</button>
<div id="ferrySummary" class="note">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</section>

<!-- ê¸€ë¨í•‘ -->
<section id="glamping" class="panel active">
<h2>ê¸€ë¨í•‘ ì‚¬ì—…</h2>

<!-- ì €ì¥ ë²„íŠ¼ -->
<div style="margin-bottom:20px; padding:15px; background:#f0f8ff; border-radius:8px; border:2px solid #3498db">
  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px">
    <button onclick="saveAllFinancialData()" style="background:#27ae60; padding:10px 20px; font-weight:600">ğŸ’¾ ë¸Œë¼ìš°ì €ì— ì €ì¥</button>
    <button onclick="downloadHTMLFile()" style="background:#3498db; padding:10px 20px; font-weight:600">ğŸ“„ HTML íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ</button>
    <button onclick="resetAllFinancialData()" style="background:#e67e22; padding:10px 20px; font-weight:600">ğŸ”„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”</button>
  </div>
  <div style="color:#555; font-size:12px; line-height:1.6">
    <strong>âš ï¸ ì €ì¥ ë°©ë²•:</strong><br>
    â€¢ <strong>ë¸Œë¼ìš°ì € ì €ì¥</strong>: ìƒˆë¡œê³ ì¹¨ í›„ë„ ë°ì´í„° ìœ ì§€ (ê°™ì€ ë¸Œë¼ìš°ì €ì—ì„œë§Œ)<br>
    â€¢ <strong>HTML ë‹¤ìš´ë¡œë“œ</strong>: íŒŒì¼ë¡œ ì˜êµ¬ ì €ì¥ ë° ë°±ì—… (ë‹¤ë¥¸ ì»´í“¨í„°ì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥)
  </div>
</div>

<!-- ì¬ë¬´ ì…ë ¥ ì„¹ì…˜: ë¶„í• ëœ ì„¸ ê°œì˜ ì ‘ì´ì‹ ì˜ì—­ -->
<details class="collapsible-section" open>
  <summary>ğŸ‰ í•µì‹¬ ì¬ë¬´ ì„±ê³¼ ì§€í‘œ</summary>
  <div class="collapsible-content">

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 20px 0;">
  <div class="kpi-card kpi-card-1">
    <div class="kpi-label">ğŸ’µ ì´ ì´ˆê¸° íˆ¬ìë¹„</div>
    <div class="kpi-value" id="kpi_totalInvest">0</div>
    <div class="kpi-unit">ì–µì›</div>
  </div>
  
  <div class="kpi-card kpi-card-2">
    <div class="kpi-label">ğŸ“‰ ì—°ê°„ ìš´ì˜ë¹„</div>
    <div class="kpi-value" id="kpi_opex">0</div>
    <div class="kpi-unit">ì–µì›/ë…„</div>
  </div>
  
  <div class="kpi-card kpi-card-3">
    <div class="kpi-label">ğŸ“Š EBITDA</div>
    <div class="kpi-value" id="kpi_ebitda">0</div>
    <div class="kpi-unit">ì–µì›/ë…„</div>
  </div>
  
  <div class="kpi-card kpi-card-4">
    <div class="kpi-label">ğŸ’° ì˜ì—…ì´ìµ</div>
    <div class="kpi-value" id="kpi_operatingProfit">0</div>
    <div class="kpi-unit">ì–µì›/ë…„</div>
  </div>
  
  <div class="kpi-card kpi-card-5">
    <div class="kpi-label">âœ… ì„¸í›„ì´ìµ</div>
    <div class="kpi-value" id="kpi_netProfit">0</div>
    <div class="kpi-unit">ì–µì›/ë…„</div>
  </div>
  
  <div class="kpi-card kpi-card-6">
    <div class="kpi-label">ğŸ’¸ ì—°ê°„ ìˆœí˜„ê¸ˆíë¦„</div>
    <div class="kpi-value" id="kpi_cashFlow">0</div>
    <div class="kpi-unit">ì–µì›/ë…„</div>
  </div>
  
  <div class="kpi-card kpi-card-7">
    <div class="kpi-label">â±ï¸ íˆ¬ìíšŒìˆ˜ê¸°ê°„</div>
    <div class="kpi-value" id="kpi_payback">0</div>
    <div class="kpi-unit">ë…„</div>
  </div>
  
  <div class="kpi-card kpi-card-8">
    <div class="kpi-label">ğŸ”¥ IRR (10ë…„ ê¸°ì¤€)</div>
    <div class="kpi-value" id="kpi_irr">0</div>
    <div class="kpi-unit">%</div>
  </div>
</div>

<div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 6px;">
  <strong>ğŸ’¡ ì°¸ê³ ì‚¬í•­:</strong> ìœ„ ì§€í‘œëŠ” í˜„ì¬ ì„ íƒëœ ì‹œë‚˜ë¦¬ì˜¤(ê¸ì •ì•ˆ/ì¤‘ë¦½ì•ˆ/ë¶€ì •ì•ˆ)ì™€ ëŒ€ìˆ˜ ì„ íƒì— ë”°ë¼ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.
</div>

  </div>
</details>

<details class="collapsible-section">
  <summary>ğŸ“Š ì˜ˆìƒ ì´ˆê¸°ë¹„ìš© ë° ìš´ì˜ë¹„ìš© (1~5ë²ˆ í•­ëª©)</summary>
  <div class="collapsible-content">

<div class="financial-section">
  <h3>[1] ì´ˆê¸° íˆ¬ìë¹„ (CAPEX) - ë‹¨ìœ„: ë§Œì›</h3>
  <table class="financial-table" id="capexTable">
    <thead>
      <tr>
        <th class="item-name">í•­ëª©</th>
        <th class="item-value">ê¸ˆì•¡ (ë§Œì›)</th>
        <th class="item-actions">ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" value="í† ì§€ ë§¤ì…ë¹„/ì„ì°¨ë³´ì¦ê¸ˆ"></td>
        <td><input type="number" value="300000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ë¶€ì§€ ì¡°ì„±ë¹„(í† ëª©)"></td>
        <td><input type="number" value="150000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ê¸€ë¨í•‘ ì‹œì„¤ ì„¤ì¹˜ë¹„"></td>
        <td><input type="number" value="200000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ê³µìš©ì‹œì„¤(ê´€ë¦¬ë™, í™”ì¥ì‹¤ ë“±)"></td>
        <td><input type="number" value="80000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì„¤ê³„Â·ì¸í—ˆê°€ ë¹„ìš©"></td>
        <td><input type="number" value="20000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì§‘ê¸°Â·ë¹„í’ˆë¹„"></td>
        <td><input type="number" value="30000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì˜ˆë¹„ë¹„"></td>
        <td><input type="number" value="20000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
    </tbody>
  </table>
  <button class="btn-small btn-add" onclick="addFinancialRow('capexTable')">+ í•­ëª© ì¶”ê°€</button>
  <div class="financial-summary">í•©ê³„: <span id="capexSum">0</span> ë§Œì› (<span id="capexSumBillion">0</span> ì–µì›)</div>
</div>

<div class="financial-section">
  <h3>[2] ê°œì—… ì „ ë¹„ìš© (Pre-opening Cost) - ë‹¨ìœ„: ë§Œì›</h3>
  <table class="financial-table" id="preopeningTable">
    <thead>
      <tr>
        <th class="item-name">í•­ëª©</th>
        <th class="item-value">ê¸ˆì•¡ (ë§Œì›)</th>
        <th class="item-actions">ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" value="ì˜¤í”ˆ ì¤€ë¹„ ì¸ê±´ë¹„"></td>
        <td><input type="number" value="5000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì´ˆê¸° ë§ˆì¼€íŒ… ë¹„ìš©"></td>
        <td><input type="number" value="10000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì‹œìš´ì˜ ë¹„ìš©"></td>
        <td><input type="number" value="3000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="êµìœ¡ë¹„"></td>
        <td><input type="number" value="2000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì´ˆê¸° ì†Œëª¨í’ˆ ë¹„ìš©"></td>
        <td><input type="number" value="5000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
    </tbody>
  </table>
  <button class="btn-small btn-add" onclick="addFinancialRow('preopeningTable')">+ í•­ëª© ì¶”ê°€</button>
  <div class="financial-summary">í•©ê³„: <span id="preopeningSum">0</span> ë§Œì› (<span id="preopeningSumBillion">0</span> ì–µì›)</div>
</div>

<div class="financial-section">
  <h3>[3] ìš´ì˜ ê³ ì •ë¹„ (ì—°ê°„ ê¸°ì¤€) - ë‹¨ìœ„: ë§Œì›/ë…„</h3>
  <table class="financial-table" id="fixedCostTable">
    <thead>
      <tr>
        <th class="item-name">í•­ëª©</th>
        <th class="item-value">ê¸ˆì•¡ (ë§Œì›/ë…„)</th>
        <th class="item-actions">ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" value="ì¸ê±´ë¹„"></td>
        <td><input type="number" value="12000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì„ì°¨ë£Œ"></td>
        <td><input type="number" value="6000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ë³´í—˜ë£Œ"></td>
        <td><input type="number" value="3000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ê°ê°€ìƒê°ë¹„"></td>
        <td><input type="number" value="5000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ê³µê³¼ê¸ˆ ê¸°ë³¸ìš”ê¸ˆ"></td>
        <td><input type="number" value="2000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ê´€ë¦¬ë¹„(í†µì‹ , ì‹œìŠ¤í…œ ë“±)"></td>
        <td><input type="number" value="3000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
    </tbody>
  </table>
  <button class="btn-small btn-add" onclick="addFinancialRow('fixedCostTable')">+ í•­ëª© ì¶”ê°€</button>
  <div class="financial-summary">í•©ê³„: <span id="fixedCostSum">0</span> ë§Œì›/ë…„ (<span id="fixedCostSumBillion">0</span> ì–µì›/ë…„)</div>
</div>

<div class="financial-section">
  <h3>[4] ìš´ì˜ ë³€ë™ë¹„ (ì—°ê°„ ê¸°ì¤€) - ë‹¨ìœ„: ë§Œì›/ë…„</h3>
  <table class="financial-table" id="variableCostTable">
    <thead>
      <tr>
        <th class="item-name">í•­ëª©</th>
        <th class="item-value">ê¸ˆì•¡ (ë§Œì›/ë…„)</th>
        <th class="item-actions">ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" value="ê°ì‹¤ ìš´ì˜ë¹„(ì„¸íƒÂ·ì²­ì†Œ)"></td>
        <td><input type="number" value="8000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì†Œëª¨í’ˆ ë¹„ìš©"></td>
        <td><input type="number" value="4000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì—ë„ˆì§€ ë¹„ìš©"></td>
        <td><input type="number" value="6000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="OTA ìˆ˜ìˆ˜ë£Œ"></td>
        <td><input type="number" value="5000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
    </tbody>
  </table>
  <button class="btn-small btn-add" onclick="addFinancialRow('variableCostTable')">+ í•­ëª© ì¶”ê°€</button>
  <div class="financial-summary">í•©ê³„: <span id="variableCostSum">0</span> ë§Œì›/ë…„ (<span id="variableCostSumBillion">0</span> ì–µì›/ë…„)</div>
</div>

<div class="financial-section">
  <h3>[5] ê¸ˆìœµ ë° ì„¸ê¸ˆ</h3>
  <table class="financial-table" id="financeTable">
    <thead>
      <tr>
        <th class="item-name">í•­ëª©</th>
        <th class="item-value">ê°’</th>
        <th class="item-actions">ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" value="ì°¨ì…ê¸ˆ ê·œëª¨ (ë§Œì›)"></td>
        <td><input type="number" value="400000" step="1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì—°ì´ììœ¨ (%)"></td>
        <td><input type="number" value="4.5" step="0.01"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ë²•ì¸ì„¸ìœ¨ (%)"></td>
        <td><input type="number" value="22" step="0.1"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
    </tbody>
  </table>
  <button class="btn-small btn-add" onclick="addFinancialRow('financeTable')">+ í•­ëª© ì¶”ê°€</button>
</div>

  </div>
</details>

<details class="collapsible-section">
  <summary>ğŸ’° ë§¤ì¶œìˆ˜ìµ ì˜ˆìƒì˜ì—­ (ìš´ì˜ í•­ëª© ë° ê²°ê³¼í‘œ)</summary>
  <div class="collapsible-content">

<hr style="margin:30px 0; border:none; border-top:2px solid #ddd;">

<input id="gWeight" type="hidden" value="0.37">


<h3>ìš´ì˜ í•­ëª© ì…ë ¥í‘œ</h3>
<table id="glampingTable" class="grid">
  <thead>
    <tr>
      <th></th>
      <th>í‰ì¼</th>
      <th>ì£¼ë§</th>
      <th>ê³µíœ´ì¼(ì—°íœ´)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>ê¸°ì¤€2ì¸</th>
      <td><input type="text" value="110,000"></td>
      <td><input type="text" value="220,000"></td>
      <td><input type="text" value="220,000"></td>
    </tr>
    <tr>
      <th>ì¶”ê°€ì¸ì›(+1)</th>
      <td><input type="text" value="140,000"></td>
      <td><input type="text" value="250,000"></td>
      <td><input type="text" value="250,000"></td>
    </tr>
    <tr>
      <th>ì¶”ê°€ì¸ì›(+2)</th>
      <td><input type="text" value="170,000"></td>
      <td><input type="text" value="280,000"></td>
      <td><input type="text" value="280,000"></td>
    </tr>
  </tbody>
</table>

<!-- ì˜ˆìƒ ê°€ë™ë¥  ì„¤ì • í‘œ -->
<h3>ê°€ë™ë¥  ì„¤ì •</h3>
<table id="occSettings" class="grid">
  <thead>
    <tr><th colspan="4">ê°€ë™ë¥  ì„¤ì •</th></tr>
    <tr>
      <th></th>
      <th>ê¸ì •ì•ˆ</th>
      <th>ì¤‘ë¦½ì•ˆ</th>
      <th>ë¶€ì •ì•ˆ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>ì„±ìˆ˜ê¸°</th>
      <td><input type="number" id="occ_pos_high" value="80" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neu_high" value="80" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neg_high" value="70" step="0.1" min="0" max="100">%</td>
    </tr>
    <tr>
      <th>ì£¼ë§</th>
      <td><input type="number" id="occ_pos_weekend" value="50" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neu_weekend" value="50" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neg_weekend" value="45" step="0.1" min="0" max="100">%</td>
    </tr>
    <tr>
      <th>í‰ì¼</th>
      <td><input type="number" id="occ_pos_weekday" value="18" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neu_weekday" value="18" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neg_weekday" value="15" step="0.1" min="0" max="100">%</td>
    </tr>
  </tbody>
</table>

<h3>ì‹œë‚˜ë¦¬ì˜¤ë³„ ì „ê°œí‘œ</h3>
<div class="note" style="background:#e8f4f8; padding:10px; border-radius:6px; border-left:4px solid #3498db">
  <strong>ğŸ’¡ ê°€ì¤‘ì¹˜ ì„¤ì •:</strong> ì•„ë˜ ì‹œë‚˜ë¦¬ì˜¤ë³„ ì „ê°œí‘œì˜ ë‘ ë²ˆì§¸ í–‰(ê°€ì¤‘ì¹˜ ì¹¸)ì—ì„œ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤. ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ì— ë™ì¼í•˜ê²Œ ì ìš©ë©ë‹ˆë‹¤.
</div>
<div class="scenario">
  <label><input type="radio" name="scenario" value="positive"><span>ê¸ì •ì•ˆ</span></label>
  <label><input type="radio" name="scenario" value="neutral" checked><span>ì¤‘ë¦½ì•ˆ</span></label>
  <label><input type="radio" name="scenario" value="negative"><span>ë¶€ì •ì•ˆ</span></label>
</div>

<!-- ì´ë¯¸ì§€ ê¸°ë°˜ (3 ì‹œë‚˜ë¦¬ì˜¤): ê¸ì •/ì¤‘ë¦½/ë¶€ì • í‘œ -->
<div id="scenario_positive" class="scenarioTable" style="display:none">
  <div><strong>ê¸ì •ì•ˆ</strong></div>
  <table class="large" id="scenario_positive_table">
    <caption><strong>ê¸€ë¨í•‘ ìˆ˜ìµ ì „ê°œí‘œ (ê¸ì •ì•ˆ - ì´ë¯¸ì§€ ê¸°ë°˜)</strong></caption>
    <thead>
      <tr>
        <th colspan="2">êµ¬ë¶„</th>
        <th rowspan="2">ì„ëŒ€ë£Œ(ì›)</th>
        <th rowspan="2">ì¼ìˆ˜</th>
        <th rowspan="2">ì—°ê°„ ì„ëŒ€ìˆ˜</th>
        <th rowspan="2">ì˜ˆìƒ ê°€ë™ìœ¨</th>
        <th rowspan="2">ì˜ˆìƒìˆ˜ì…(ì›)</th>
        <th colspan="2">ì¶”ê°€ì¸ì›</th>
        <th>ê°€ì¤‘ì¹˜</th>
        <th rowspan="2">ë¹„ê³ </th>
      </tr>
      <tr>
        <th>ì‹œì„¤ë³„</th>
        <th>ì‹œê¸°ë³„</th>
        <th>ì¶”ê°€ì¸ì›(1)</th>
        <th>ì¶”ê°€ì¸ì›(2)</th>
        <th class="weightHeader"><input type="number" step="0.01" min="0" value="0.37" style="width:60px;text-align:center;padding:4px;border:1px solid #3498db;border-radius:3px;font-weight:bold" onchange="updateWeightFromHeader(this.value)"></th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="2">ì´ê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr style="background:#f0f0f0"><td>ê¸€ë¨í•‘</td><td>ì†Œê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>

      <tr><td>(10)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>109,120</td><td>14,880</td><td>29,760</td><td>16,516</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>96,800</td><td>13,200</td><td>26,400</td><td>14,652</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>18%</td><td>42,570</td><td>11,610</td><td>23,220</td><td>12,887</td><td></td></tr>

      <tr><td>(15)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>163,680</td><td>22,320</td><td>44,640</td><td>24,775</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>145,200</td><td>19,800</td><td>39,600</td><td>21,978</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>18%</td><td>63,855</td><td>17,415</td><td>34,830</td><td>19,330</td><td></td></tr>

      <tr><td>(30)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>327,360</td><td>44,640</td><td>89,280</td><td>49,550</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>290,400</td><td>39,600</td><td>79,200</td><td>43,956</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>18%</td><td>127,710</td><td>34,830</td><td>69,660</td><td>38,661</td><td></td></tr>

      <tr style="background:#f0f0f0"><td>ì¹´ë¼ë°˜</td><td>ì†Œê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>

      <tr><td>(5)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>54,560</td><td>7,440</td><td>14,880</td><td>8,258</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>48,400</td><td>6,600</td><td>13,200</td><td>7,326</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>27%</td><td>31,927</td><td>8,707</td><td>17,415</td><td>9,665</td><td></td></tr>

      <tr><td colspan="11" style="background:#fff"><strong>í•©ê³„ / ë¹„ê³ </strong></td></tr>
    </tbody>
  </table>
</div>

<div id="scenario_neutral" class="scenarioTable">
  <div><strong>ì¤‘ë¦½ì•ˆ</strong></div>
  <table class="large" id="scenario_neutral_table">
    <caption><strong>ê¸€ë¨í•‘ ìˆ˜ìµ ì „ê°œí‘œ (ì¤‘ë¦½ì•ˆ - ì´ë¯¸ì§€ ê¸°ë°˜)</strong></caption>
    <thead>
      <tr>
        <th colspan="2">êµ¬ë¶„</th>
        <th rowspan="2">ì„ëŒ€ë£Œ(ì›)</th>
        <th rowspan="2">ì¼ìˆ˜</th>
        <th rowspan="2">ì—°ê°„ ì„ëŒ€ìˆ˜</th>
        <th rowspan="2">ì˜ˆìƒ ê°€ë™ìœ¨</th>
        <th rowspan="2">ì˜ˆìƒìˆ˜ì…(ì›)</th>
        <th colspan="2">ì¶”ê°€ì¸ì›</th>
        <th>ê°€ì¤‘ì¹˜</th>
        <th rowspan="2">ë¹„ê³ </th>
      </tr>
      <tr>
        <th>ì‹œì„¤ë³„</th>
        <th>ì‹œê¸°ë³„</th>
        <th>ì¶”ê°€ì¸ì›(1)</th>
        <th>ì¶”ê°€ì¸ì›(2)</th>
        <th class="weightHeader">0.37</th>
      </tr>
    </thead>
    <tbody>
      <tr><td rowspan="2">ì´ê³„</td><td>ì´ê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr><td colspan="10" style="background:#f0f0f0"><strong>ê¸€ë¨í•‘ ì†Œê³„</strong> (365)</td></tr>

      <tr><td>(10)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>109,120</td><td>14,880</td><td>29,760</td><td>16,516</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>96,800</td><td>13,200</td><td>26,400</td><td>14,652</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>18%</td><td>42,570</td><td>11,610</td><td>23,220</td><td>12,887</td><td></td></tr>

      <tr><td>(15)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>163,680</td><td>22,320</td><td>44,640</td><td>24,775</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>145,200</td><td>19,800</td><td>39,600</td><td>21,978</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>18%</td><td>63,855</td><td>17,415</td><td>34,830</td><td>19,330</td><td></td></tr>

      <tr><td>(30)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>327,360</td><td>44,640</td><td>89,280</td><td>49,550</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>290,400</td><td>39,600</td><td>79,200</td><td>43,956</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>18%</td><td>127,710</td><td>34,830</td><td>69,660</td><td>38,661</td><td></td></tr>

      <tr><td colspan="11" style="background:#f0f0f0"><strong>ì¹´ë¼ë°˜ ì†Œê³„</strong> (365)</td></tr>

      <tr><td>(5)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>54,560</td><td>7,440</td><td>14,880</td><td>8,258</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>48,400</td><td>6,600</td><td>13,200</td><td>7,326</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>27%</td><td>31,927</td><td>8,707</td><td>17,415</td><td>9,665</td><td></td></tr>

      <tr><td colspan="11" style="background:#fff"><strong>í•©ê³„ / ë¹„ê³ </strong></td></tr>
    </tbody>
  </table>
</div>

<div id="scenario_negative" class="scenarioTable" style="display:none">
  <div><strong>ë¶€ì •ì•ˆ</strong></div>
  <table class="large" id="scenario_negative_table">
    <caption><strong>ê¸€ë¨í•‘ ìˆ˜ìµ ì „ê°œí‘œ (ë¶€ì •ì•ˆ - ì´ë¯¸ì§€ ê¸°ë°˜)</strong></caption>
    <thead>
      <tr>
        <th colspan="2">êµ¬ë¶„</th>
        <th rowspan="2">ì„ëŒ€ë£Œ(ì›)</th>
        <th rowspan="2">ì¼ìˆ˜</th>
        <th rowspan="2">ì—°ê°„ ì„ëŒ€ìˆ˜</th>
        <th rowspan="2">ì˜ˆìƒ ê°€ë™ìœ¨</th>
        <th rowspan="2">ì˜ˆìƒìˆ˜ì…(ì›)</th>
        <th colspan="2">ì¶”ê°€ì¸ì›</th>
        <th>ê°€ì¤‘ì¹˜</th>
        <th rowspan="2">ë¹„ê³ </th>
      </tr>
      <tr>
        <th>ì‹œì„¤ë³„</th>
        <th>ì‹œê¸°ë³„</th>
        <th>ì¶”ê°€ì¸ì›(1)</th>
        <th>ì¶”ê°€ì¸ì›(2)</th>
        <th class="weightHeader">0.37</th>
      </tr>
    </thead>
    <tbody>
      <tr><td rowspan="2">ì´ê³„</td><td>ì´ê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr><td colspan="10" style="background:#f0f0f0"><strong>ê¸€ë¨í•‘ ì†Œê³„</strong> (365)</td></tr>

      <tr><td>(10)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>109,120</td><td>14,880</td><td>29,760</td><td>16,516</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>96,800</td><td>13,200</td><td>26,400</td><td>14,652</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>18%</td><td>42,570</td><td>11,610</td><td>23,220</td><td>12,887</td><td></td></tr>

      <tr><td>(15)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>163,680</td><td>22,320</td><td>44,640</td><td>24,775</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>145,200</td><td>19,800</td><td>39,600</td><td>21,978</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>18%</td><td>63,855</td><td>17,415</td><td>34,830</td><td>19,330</td><td></td></tr>

      <tr><td>(30)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>327,360</td><td>44,640</td><td>89,280</td><td>49,550</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>290,400</td><td>39,600</td><td>79,200</td><td>43,956</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>18%</td><td>127,710</td><td>34,830</td><td>69,660</td><td>38,661</td><td></td></tr>

      <tr><td colspan="11" style="background:#f0f0f0"><strong>ì¹´ë¼ë°˜ ì†Œê³„</strong> (365)</td></tr>

      <tr><td>(5)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>54,560</td><td>7,440</td><td>14,880</td><td>8,258</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>48,400</td><td>6,600</td><td>13,200</td><td>7,326</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>110</td><td>215</td><td></td><td>27%</td><td>31,927</td><td>8,707</td><td>17,415</td><td>9,665</td><td></td></tr>

      <tr><td colspan="11" style="background:#fff"><strong>í•©ê³„ / ë¹„ê³ </strong></td></tr>
    </tbody>
  </table>
</div>

<!-- Scenario summary: per-scenario compact tables -->
<div id="scenarioSummaries" style="margin-top:16px; display:flex; gap:12px; flex-wrap:wrap">
  <div style="flex:1; min-width:300px">
    <h4>ê¸ì •ì•ˆ ìš”ì•½</h4>
    <table class="grid" id="summary_positive" style="font-size:12px">
      <thead><tr><th>ëŒ€ìˆ˜</th><th>ê¸€ë¨í•‘ ë‹¨ë…</th><th>+ê°€ì¤‘ì¹˜</th><th>+ì¹´ë¼ë°˜5ëŒ€</th><th>+ì¹´ë¼ë°˜+ê°€ì¤‘ì¹˜</th></tr></thead>
      <tbody>
        <tr><td>10ëŒ€</td><td class="sp_10">-</td><td class="sp_10_w">-</td><td class="sp_10_p">-</td><td class="sp_10_pw">-</td></tr>
        <tr><td>15ëŒ€</td><td class="sp_15">-</td><td class="sp_15_w">-</td><td class="sp_15_p">-</td><td class="sp_15_pw">-</td></tr>
        <tr><td>30ëŒ€</td><td class="sp_30">-</td><td class="sp_30_w">-</td><td class="sp_30_p">-</td><td class="sp_30_pw">-</td></tr>
      </tbody>
    </table>
  </div>
  <div style="flex:1; min-width:300px">
    <h4>ì¤‘ë¦½ì•ˆ ìš”ì•½</h4>
    <table class="grid" id="summary_neutral" style="font-size:12px">
      <thead><tr><th>ëŒ€ìˆ˜</th><th>ê¸€ë¨í•‘ ë‹¨ë…</th><th>+ê°€ì¤‘ì¹˜</th><th>+ì¹´ë¼ë°˜5ëŒ€</th><th>+ì¹´ë¼ë°˜+ê°€ì¤‘ì¹˜</th></tr></thead>
      <tbody>
        <tr><td>10ëŒ€</td><td class="sn_10">-</td><td class="sn_10_w">-</td><td class="sn_10_p">-</td><td class="sn_10_pw">-</td></tr>
        <tr><td>15ëŒ€</td><td class="sn_15">-</td><td class="sn_15_w">-</td><td class="sn_15_p">-</td><td class="sn_15_pw">-</td></tr>
        <tr><td>30ëŒ€</td><td class="sn_30">-</td><td class="sn_30_w">-</td><td class="sn_30_p">-</td><td class="sn_30_pw">-</td></tr>
      </tbody>
    </table>
  </div>
  <div style="flex:1; min-width:300px">
    <h4>ë¶€ì •ì•ˆ ìš”ì•½</h4>
    <table class="grid" id="summary_negative" style="font-size:12px">
      <thead><tr><th>ëŒ€ìˆ˜</th><th>ê¸€ë¨í•‘ ë‹¨ë…</th><th>+ê°€ì¤‘ì¹˜</th><th>+ì¹´ë¼ë°˜5ëŒ€</th><th>+ì¹´ë¼ë°˜+ê°€ì¤‘ì¹˜</th></tr></thead>
      <tbody>
        <tr><td>10ëŒ€</td><td class="sg_10">-</td><td class="sg_10_w">-</td><td class="sg_10_p">-</td><td class="sg_10_pw">-</td></tr>
        <tr><td>15ëŒ€</td><td class="sg_15">-</td><td class="sg_15_w">-</td><td class="sg_15_p">-</td><td class="sg_15_pw">-</td></tr>
        <tr><td>30ëŒ€</td><td class="sg_30">-</td><td class="sg_30_w">-</td><td class="sg_30_p">-</td><td class="sg_30_pw">-</td></tr>
      </tbody>
    </table>
  </div>
</div>

<button id="glampingAnalyze">ê¸€ë¨í•‘ ë¶„ì„ ì‹¤í–‰</button>
<div id="glampingSummary" class="note">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

<h3 style="margin-top:30px">ê¸€ë¨í•‘ ëŒ€ìˆ˜ë³„ í•©ì‚°ê¸ˆì•¡ ë¶„ì„</h3>
<div style="margin:10px 0; padding:10px; background:#f9f9f9; border-radius:6px">
  <label style="display:inline-flex; align-items:center; cursor:pointer; font-size:14px">
    <input type="checkbox" id="includeCaravanChart" style="width:18px; height:18px; margin-right:8px">
    <span>ì¹´ë¼ë°˜ 5ëŒ€ í¬í•¨</span>
  </label>
  <span style="margin-left:20px; color:#666; font-size:13px">* ê°€ì¤‘ì¹˜ëŠ” ëª¨ë‘ í¬í•¨ëœ ê¸ˆì•¡ì…ë‹ˆë‹¤</span>
</div>
<canvas id="glampingUnitsChart" style="max-height:400px"></canvas>

  </div>
</details>

</section>

<!-- ë²¤ì²˜ -->
<section id="venture" class="panel">
<h2>í•´ìš´Â·ë¬¼ë¥˜ ì‹ ê·œ ë²¤ì²˜ íˆ¬ì</h2>
<ul>
  <li>ì „ëµì  ì‹œë„ˆì§€ í™•ë³´ ëª©ì </li>
  <li>ì†Œì•¡ ì§€ë¶„ íˆ¬ì ê²€í† </li>
  <li>ê°„ë‹¨í•œ IRR ì‹œë‚˜ë¦¬ì˜¤ ì…ë ¥</li>
</ul>

<label>ì´ˆê¸° íˆ¬ìë¹„ (ì–µì›)</label>
<input id="vInvest" type="number" value="10">

<label>ì—°ê°„ ì˜ˆìƒ EBITDA (ì–µì›)</label>
<input id="vEbitda" type="number" value="1.2">

<label>ë¶„ì„ ê¸°ê°„ (ì—°)</label>
<input id="vYears" type="number" value="10">

<button id="ventureAnalyze">ë²¤ì²˜ ë¶„ì„ ì‹¤í–‰</button>
<div id="ventureSummary" class="note">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</section>

<!-- í†µí•© -->
<section id="total" class="panel">
<h2>í†µí•© ìˆ˜ìµ ë¶„ì„</h2>

<button id="consolidateBtn">í†µí•© ë¶„ì„ ì‹¤í–‰</button>
<button id="downloadPdf">PDF ë‹¤ìš´ë¡œë“œ</button>

<div id="aggregatedSummary" class="note">í†µí•© ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

<h3>ë‹¨ë… vs í†µí•© EBITDA</h3>
<canvas id="compareChart"></canvas>

<h3>ë³´ì¡°ê¸ˆ OFF vs ON IRR ë¹„êµ (í†µí•©)</h3>
<canvas id="subsidyChart"></canvas>
</section>

<script>
/* íƒ­ */
document.querySelectorAll(".tabs button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
    // ê¸€ë¨í•‘ íƒ­ì„ í™œì„±í™”í•  ë•Œ 11x17 í…Œì´ë¸”ì„ ë‹¤ì‹œ ìƒì„±í•˜ì—¬ í‘œì‹œ ë³´ì¥
    if(btn.dataset.tab === 'glamping') createScenarioTableSingle();
  }
});

/* DOM references */
const fare = document.getElementById('fare');
const fareSlider = document.getElementById('fareSlider');
const fareRate = document.getElementById('fareRate');
const days = document.getElementById('days');
const passengers = document.getElementById('passengers');
const shipPrice = document.getElementById('shipPrice');
const subsidy = document.getElementById('subsidy');
const subsidyToggle = document.getElementById('subsidyToggle');
const opex = document.getElementById('opex');

const gInvest = document.getElementById('gInvest');
const rooms = document.getElementById('rooms');
const occ = document.getElementById('occ');
const adr = document.getElementById('adr');
const gOpex = document.getElementById('gOpex');

const vInvest = document.getElementById('vInvest');
const vEbitda = document.getElementById('vEbitda');
const vYears = document.getElementById('vYears');

const ferryAnalyze = document.getElementById('ferryAnalyze');
const glampingAnalyze = document.getElementById('glampingAnalyze');
const ventureAnalyze = document.getElementById('ventureAnalyze');
const consolidateBtn = document.getElementById('consolidateBtn');
const downloadPdf = document.getElementById('downloadPdf');

const kRevenue = document.getElementById('kRevenue');
const kEbitda = document.getElementById('kEbitda');
const kIrr = document.getElementById('kIrr');

const compareChartEl = document.getElementById('compareChart');
const subsidyChartEl = document.getElementById('subsidyChart');
const glampingUnitsChartEl = document.getElementById('glampingUnitsChart');

const ferrySummary = document.getElementById('ferrySummary');
const glampingSummary = document.getElementById('glampingSummary');
const ventureSummary = document.getElementById('ventureSummary');
const aggregatedSummary = document.getElementById('aggregatedSummary');

const includeCaravanChart = document.getElementById('includeCaravanChart');

let compareChart, subsidyChart, glampingUnitsChart;
let projects = {ferry:null, glamping:null, venture:null};

/* Financial tables management */
function addFinancialRow(tableId) {
  const table = document.getElementById(tableId);
  if(!table) return;
  const tbody = table.querySelector('tbody');
  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td><input type="text" placeholder="í•­ëª©ëª… ì…ë ¥"></td>
    <td><input type="text" value="0"></td>
    <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
  `;
  tbody.appendChild(newRow);
  bindFinancialInputs();
  updateFinancialSummaries();
}

function deleteFinancialRow(btn) {
  const row = btn.closest('tr');
  const table = row.closest('table');
  const tbody = table.querySelector('tbody');
  if(tbody.children.length > 1) {
    row.remove();
    updateFinancialSummaries();
  } else {
    showToast('ìµœì†Œ 1ê°œ ì´ìƒì˜ í•­ëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
  }
}

function getTableSum(tableId) {
  const table = document.getElementById(tableId);
  if(!table) return 0;
  const inputs = table.querySelectorAll('tbody tr td:nth-child(2) input');
  let sum = 0;
  inputs.forEach(inp => {
    const val = Number(removeCommas(inp.value)) || 0;
    sum += val;
  });
  return sum;
}

function updateFinancialSummaries() {
  const tables = ['capex', 'preopening', 'fixedCost', 'variableCost'];
  tables.forEach(t => {
    const sum = getTableSum(t + 'Table');
    const sumEl = document.getElementById(t + 'Sum');
    const sumBillionEl = document.getElementById(t + 'SumBillion');
    if(sumEl) sumEl.textContent = formatNumberWithCommas(sum.toFixed(0));
    if(sumBillionEl) sumBillionEl.textContent = formatNumberWithCommas((sum / 10000).toFixed(2));
  });
  
  // Update gInvest field with total CAPEX + Pre-opening
  const totalCapex = getTableSum('capexTable');
  const totalPreopening = getTableSum('preopeningTable');
  const totalInitial = (totalCapex + totalPreopening) / 10000; // Convert to ì–µì›
  const gInvestEl = document.getElementById('gInvest');
  if(gInvestEl) {
    gInvestEl.value = totalInitial.toFixed(2);
  }
  
  // Update gOpex field with total fixed + variable costs
  const totalFixed = getTableSum('fixedCostTable');
  const totalVariable = getTableSum('variableCostTable');
  const totalOpex = (totalFixed + totalVariable) / 10000; // Convert to ì–µì›
  const gOpexEl = document.getElementById('gOpex');
  if(gOpexEl) {
    gOpexEl.value = totalOpex.toFixed(2);
  }
  
  // Update KPI indicators
  updateKPIIndicators();
}

function updateKPIIndicators() {
  // ì´ ì´ˆê¸° íˆ¬ìë¹„ (CAPEX + Pre-opening)
  const totalCapex = getTableSum('capexTable');
  const totalPreopening = getTableSum('preopeningTable');
  const totalInvest = (totalCapex + totalPreopening) / 10000; // ì–µì›
  
  // ì—°ê°„ ìš´ì˜ë¹„ (Fixed + Variable)
  const totalFixed = getTableSum('fixedCostTable');
  const totalVariable = getTableSum('variableCostTable');
  const opex = (totalFixed + totalVariable) / 10000; // ì–µì›
  
  // ì—°ê°„ ë§¤ì¶œ (í˜„ì¬ ì„ íƒëœ ì‹œë‚˜ë¦¬ì˜¤ì™€ ëŒ€ìˆ˜ ê¸°ë°˜)
  const selectedScenario = document.querySelector('input[name="scenario"]:checked')?.value || 'neutral';
  const revenue = getSelectedScenarioRevenue(selectedScenario); // ì–µì›
  
  // EBITDA = ë§¤ì¶œ - ìš´ì˜ë¹„
  const ebitda = revenue - opex;
  
  // ê°ê°€ìƒê°ë¹„ (ê³ ì •ë¹„ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ CAPEXì˜ 10%ë¡œ ì¶”ì •)
  const depreciation = totalInvest * 0.1; // 10ë…„ ì •ì•¡ë²• ê°€ì •
  
  // ì˜ì—…ì´ìµ = EBITDA - ê°ê°€ìƒê°
  const operatingProfit = ebitda - depreciation;
  
  // ì„¸ìœ¨ (finance í…Œì´ë¸”ì—ì„œ ê°€ì ¸ì˜¤ê¸°, ì—†ìœ¼ë©´ 22% ê¸°ë³¸ê°’)
  const taxRate = getTaxRate() / 100;
  
  // ì„¸í›„ì´ìµ = ì˜ì—…ì´ìµ * (1 - ì„¸ìœ¨)
  const netProfit = operatingProfit * (1 - taxRate);
  
  // ì—°ê°„ ìˆœí˜„ê¸ˆíë¦„ = ì„¸í›„ì´ìµ + ê°ê°€ìƒê°
  const cashFlow = netProfit + depreciation;
  
  // íˆ¬ìíšŒìˆ˜ê¸°ê°„ = ì´ íˆ¬ì / ì—°ê°„ ìˆœí˜„ê¸ˆíë¦„
  const payback = cashFlow > 0 ? totalInvest / cashFlow : 999;
  
  // IRR ê³„ì‚° (ê°„ë‹¨í•œ ê·¼ì‚¬ì¹˜)
  const irr = calculateSimpleIRR(totalInvest, cashFlow, 10);
  
  // Update UI
  document.getElementById('kpi_totalInvest').textContent = formatNumberWithCommas(totalInvest.toFixed(1));
  document.getElementById('kpi_opex').textContent = formatNumberWithCommas(opex.toFixed(1));
  document.getElementById('kpi_ebitda').textContent = formatNumberWithCommas(ebitda.toFixed(1));
  document.getElementById('kpi_operatingProfit').textContent = formatNumberWithCommas(operatingProfit.toFixed(1));
  document.getElementById('kpi_netProfit').textContent = formatNumberWithCommas(netProfit.toFixed(1));
  document.getElementById('kpi_cashFlow').textContent = formatNumberWithCommas(cashFlow.toFixed(1));
  document.getElementById('kpi_payback').textContent = payback < 999 ? payback.toFixed(1) : 'N/A';
  document.getElementById('kpi_irr').textContent = irr.toFixed(1);
}

function getSelectedScenarioRevenue(scenario) {
  // í˜„ì¬ ì„ íƒëœ ì‹œë‚˜ë¦¬ì˜¤ì˜ ë§¤ì¶œì„ ê°€ì ¸ì˜´ (ì²œì› ë‹¨ìœ„ë¥¼ ì–µì›ìœ¼ë¡œ ë³€í™˜)
  // ê¸°ë³¸ì ìœ¼ë¡œ 10ëŒ€ ê¸€ë¨í•‘ + ê°€ì¤‘ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
  const prefix = scenario === 'positive' ? 'sp' : scenario === 'neutral' ? 'sn' : 'sg';
  const revenueEl = document.querySelector(`.${prefix}_10_w`);
  if (revenueEl && revenueEl.textContent !== '-') {
    const revenue = parseFloat(removeCommas(revenueEl.textContent)) / 100000; // ì²œì› -> ì–µì›
    return revenue;
  }
  return 0;
}

function getTaxRate() {
  // finance í…Œì´ë¸”ì—ì„œ ë²•ì¸ì„¸ìœ¨ ì°¾ê¸°
  const financeTable = document.getElementById('financeTable');
  if (financeTable) {
    const rows = financeTable.querySelectorAll('tbody tr');
    for (const row of rows) {
      const nameInput = row.querySelector('td:first-child input');
      const valueInput = row.querySelector('td:nth-child(2) input');
      if (nameInput && nameInput.value.includes('ë²•ì¸ì„¸ìœ¨')) {
        return parseFloat(valueInput.value) || 22;
      }
    }
  }
  return 22; // ê¸°ë³¸ê°’
}

function calculateSimpleIRR(investment, annualCashFlow, years) {
  // NPV = 0ì´ ë˜ëŠ” í• ì¸ìœ¨ì„ ì°¾ëŠ” ê°„ë‹¨í•œ IRR ê³„ì‚°
  // Newton-Raphson ë°©ë²• ì‚¬ìš©
  let rate = 0.1; // ì´ˆê¸° ì¶”ì •ê°’ 10%
  const tolerance = 0.0001;
  const maxIterations = 100;
  
  for (let i = 0; i < maxIterations; i++) {
    let npv = -investment;
    let dnpv = 0;
    
    for (let year = 1; year <= years; year++) {
      const factor = Math.pow(1 + rate, year);
      npv += annualCashFlow / factor;
      dnpv -= year * annualCashFlow / (factor * (1 + rate));
    }
    
    if (Math.abs(npv) < tolerance) {
      return rate * 100; // í¼ì„¼íŠ¸ë¡œ ë³€í™˜
    }
    
    rate = rate - npv / dnpv;
    
    if (rate < -0.99) rate = -0.99; // í•˜í•œ
    if (rate > 10) rate = 10; // ìƒí•œ
  }
  
  return rate * 100;
}

function bindFinancialInputs() {
  const allInputs = document.querySelectorAll('.financial-table tbody td:nth-child(2) input');
  allInputs.forEach(inp => {
    inp.removeEventListener('input', updateFinancialSummaries);
    inp.addEventListener('input', updateFinancialSummaries);
    
    // Add comma formatting on blur
    inp.removeEventListener('blur', handleBlur);
    inp.addEventListener('blur', handleBlur);
    
    // Remove commas on focus for easier editing
    inp.removeEventListener('focus', handleFocus);
    inp.addEventListener('focus', handleFocus);
  });
}

function handleBlur(e) {
  formatNumberInput(e.target);
  updateFinancialSummaries();
}

function handleFocus(e) {
  e.target.value = removeCommas(e.target.value);
}

window.addFinancialRow = addFinancialRow;
window.deleteFinancialRow = deleteFinancialRow;

/* LocalStorage ë°ì´í„° ì €ì¥/ë³µì› */
function saveAllFinancialData() {
  const tables = ['capexTable', 'preopeningTable', 'fixedCostTable', 'variableCostTable', 'financeTable'];
  const data = {};
  
  tables.forEach(tableId => {
    const table = document.getElementById(tableId);
    if(!table) return;
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    data[tableId] = rows.map(tr => {
      const cells = tr.querySelectorAll('td');
      return {
        name: cells[0]?.querySelector('input')?.value || '',
        value: cells[1]?.querySelector('input')?.value || '0'
      };
    });
  });
  
  // Save glamping table data
  const glampingRows = Array.from(document.querySelectorAll('#glampingTable tbody tr'));
  data.glampingTable = glampingRows.map(tr => {
    const inputs = tr.querySelectorAll('input');
    return Array.from(inputs).map(inp => inp.value);
  });
  
  // Save occupancy settings
  data.occupancy = {
    pos_high: document.getElementById('occ_pos_high')?.value,
    pos_weekend: document.getElementById('occ_pos_weekend')?.value,
    pos_weekday: document.getElementById('occ_pos_weekday')?.value,
    neu_high: document.getElementById('occ_neu_high')?.value,
    neu_weekend: document.getElementById('occ_neu_weekend')?.value,
    neu_weekday: document.getElementById('occ_neu_weekday')?.value,
    neg_high: document.getElementById('occ_neg_high')?.value,
    neg_weekend: document.getElementById('occ_neg_weekend')?.value,
    neg_weekday: document.getElementById('occ_neg_weekday')?.value
  };
  
  // Save weight
  data.weight = document.querySelector('.weightHeader input')?.value || '0.37';
  
  localStorage.setItem('glampingFinancialData', JSON.stringify(data));
  showToast('ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
}

function loadAllFinancialData() {
  const saved = localStorage.getItem('glampingFinancialData');
  if(!saved) return false;
  
  try {
    const data = JSON.parse(saved);
    
    // Restore financial tables
    const tables = ['capexTable', 'preopeningTable', 'fixedCostTable', 'variableCostTable', 'financeTable'];
    tables.forEach(tableId => {
      if(!data[tableId]) return;
      const table = document.getElementById(tableId);
      if(!table) return;
      
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = ''; // Clear existing rows
      
      data[tableId].forEach(rowData => {
        const newRow = document.createElement('tr');
        const formattedValue = formatNumberWithCommas(Math.round(parseFloat(removeCommas(rowData.value)) || 0));
        newRow.innerHTML = `
          <td><input type="text" value="${rowData.name}"></td>
          <td><input type="text" value="${formattedValue}"></td>
          <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
        `;
        tbody.appendChild(newRow);
      });
    });
    
    // Restore glamping table
    if(data.glampingTable) {
      const glampingRows = document.querySelectorAll('#glampingTable tbody tr');
      data.glampingTable.forEach((rowData, idx) => {
        if(glampingRows[idx]) {
          const inputs = glampingRows[idx].querySelectorAll('input');
          rowData.forEach((val, i) => {
            if(inputs[i]) inputs[i].value = val;
          });
        }
      });
    }
    
    // Restore occupancy settings
    if(data.occupancy) {
      Object.keys(data.occupancy).forEach(key => {
        const el = document.getElementById('occ_' + key);
        if(el && data.occupancy[key]) el.value = data.occupancy[key];
      });
    }
    
    // Restore weight
    if(data.weight) {
      const gWeightEl = document.getElementById('gWeight');
      if(gWeightEl) gWeightEl.value = data.weight;
      document.querySelectorAll('.weightHeader input').forEach(inp => {
        inp.value = data.weight;
      });
    }
    
    return true;
  } catch(e) {
    console.error('Failed to load data:', e);
    return false;
  }
}

function resetAllFinancialData() {
  if(!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  localStorage.removeItem('glampingFinancialData');
  showToast('ì´ˆê¸°í™” ì™„ë£Œ! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.', 'success');
  setTimeout(() => location.reload(), 1000);
}

window.saveAllFinancialData = saveAllFinancialData;
window.loadAllFinancialData = loadAllFinancialData;
window.resetAllFinancialData = resetAllFinancialData;

function downloadHTMLFile() {
  // Get current HTML content
  let htmlContent = document.documentElement.outerHTML;
  
  // Update all financial table values in HTML
  const tables = ['capexTable', 'preopeningTable', 'fixedCostTable', 'variableCostTable', 'financeTable'];
  tables.forEach(tableId => {
    const table = document.getElementById(tableId);
    if(!table) return;
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    // This is for display purposes - the actual download will capture current DOM state
  });
  
  // Create a blob with the current HTML
  const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
  
  // Create download link
  const link = document.createElement('a');
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
  link.href = URL.createObjectURL(blob);
  link.download = `glamping_dashboard_${timestamp}.html`;
  
  // Trigger download
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(link.href);
  
  showToast('HTML íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
}

window.downloadHTMLFile = downloadHTMLFile;

/* ê°œì„ ëœ IRR (binary search) */
function irr(cfs){
  let low=-0.9999, high=2, mid=0;
  for(let i=0;i<80;i++){
    mid=(low+high)/2;
    let npv=0;
    cfs.forEach((c,t)=>npv+=c/Math.pow(1+mid,t));
    if(npv>0) low=mid; else high=mid;
  }
  return mid;
}

/* ê°œë³„ ê³„ì‚° */
function computeFerry(){
  const fareAdj = Number(fare.value) * Number(fareSlider.value);
  fareRate.innerText = Math.round(Number(fareSlider.value)*100)+"%";
  const revenue = Number(days.value) * Number(passengers.value) * fareAdj / 1e8;
  const ebitda = revenue - Number(opex.value);
  const investWith = Number(shipPrice.value) - Number(subsidy.value);
  const investWithout = Number(shipPrice.value);
  const years = 20;
  const cfsWith = [-investWith].concat(Array(years).fill(ebitda));
  const cfsWithout = [-investWithout].concat(Array(years).fill(ebitda));
  const irrWith = irr(cfsWith);
  const irrWithout = irr(cfsWithout);
  const res = {revenue, ebitda, investWith, investWithout, irrWith, irrWithout, years};
  projects.ferry = res;
  ferrySummary.innerHTML = `ì—°ê°„ ë§¤ì¶œ: ${revenue.toFixed(1)} ì–µì›<br>ì—°ê°„ EBITDA: ${ebitda.toFixed(1)} ì–µì›<br>IRR(ë³´ì¡°ê¸ˆ ON): ${(irrWith*100).toFixed(2)}% / OFF: ${(irrWithout*100).toFixed(2)}%`;
  return res;
}

function computeGlamping(){
  const revenue = Number(rooms.value)*365*Number(occ.value)*Number(adr.value)/1e8;
  const ebitda = revenue - Number(gOpex.value);
  const invest = Number(gInvest.value);
  const years = 10;
  const cfs = [-invest].concat(Array(years).fill(ebitda));
  const irrVal = irr(cfs);
  const res = {revenue, ebitda, invest, irr: irrVal, years};
  projects.glamping = res;
  glampingSummary.innerHTML = `ì—°ê°„ ë§¤ì¶œ: ${revenue.toFixed(1)} ì–µì›<br>ì—°ê°„ EBITDA: ${ebitda.toFixed(1)} ì–µì›<br>IRR: ${(irrVal*100).toFixed(2)}%`;
  return res;
}

function computeVenture(){
  const invest = Number(vInvest.value);
  const ebitda = Number(vEbitda.value);
  const years = Number(vYears.value)||10;
  const cfs = [-invest].concat(Array(years).fill(ebitda));
  const irrVal = irr(cfs);
  const res = {revenue: ebitda, ebitda, invest, irr: irrVal, years};
  projects.venture = res;
  ventureSummary.innerHTML = `ì—°ê°„ EBITDA: ${ebitda.toFixed(2)} ì–µì›<br>IRR: ${(irrVal*100).toFixed(2)}%`;
  return res;
}

/* í†µí•© ë¶„ì„ */
function consolidateAnalysis(){
  if(!projects.ferry) computeFerry();
  if(!projects.glamping) computeGlamping();
  if(!projects.venture) computeVenture();

  const f = projects.ferry, g = projects.glamping, v = projects.venture;
  const totalRevenue = (f.revenue||0) + (g.revenue||0) + (v.revenue||0);
  const totalEbitda = (f.ebitda||0) + (g.ebitda||0) + (v.ebitda||0);

  const years = 10;
  const investOn = (f.investWith||0) + (g.invest||0) + (v.invest||0);
  const investOff = (f.investWithout||0) + (g.invest||0) + (v.invest||0);

  const cfsOn = [-investOn].concat(Array(years).fill(totalEbitda));
  const cfsOff = [-investOff].concat(Array(years).fill(totalEbitda));

  const irrOn = irr(cfsOn);
  const irrOff = irr(cfsOff);

  kRevenue.innerText = totalRevenue.toFixed(1)+" ì–µì›";
  kEbitda.innerText = totalEbitda.toFixed(1)+" ì–µì›";
  kIrr.innerText = (irrOn*100).toFixed(2)+" %";

  aggregatedSummary.innerHTML = `ì´ ë§¤ì¶œ(ì—°ê°„ í•©ê³„): ${totalRevenue.toFixed(1)} ì–µì›<br>ì´ EBITDA(ì—°ê°„ í•©ê³„): ${totalEbitda.toFixed(1)} ì–µì›<br>í†µí•© IRR(ë³´ì¡°ê¸ˆ ON): ${(irrOn*100).toFixed(2)}% / OFF: ${(irrOff*100).toFixed(2)}%`;

  if(compareChart) compareChart.destroy();
  const labels=["ì—¬ê°ì„ ","ê¸€ë¨í•‘","ë²¤ì²˜","í†µí•©"];
  const data=[(f.ebitda||0),(g.ebitda||0),(v.ebitda||0), totalEbitda];
  compareChart = new Chart(compareChartEl,{type:"bar",data:{labels, datasets:[{data}]}});

  if(subsidyChart) subsidyChart.destroy();
  subsidyChart = new Chart(subsidyChartEl,{type:"line",data:{labels:["OFF","ON"], datasets:[{data:[irrOff*100, irrOn*100]}]}});
}

/* ì´ë²¤íŠ¸ ë°”ì¸ë”© */
fareSlider.oninput = ()=> fareRate.innerText = Math.round(Number(fareSlider.value)*100)+"%";
ferryAnalyze.onclick = computeFerry;
glampingAnalyze.onclick = computeGlamping;
ventureAnalyze.onclick = computeVenture;
consolidateBtn.onclick = consolidateAnalysis;

// Show/hide the static scenario tables
function showScenarioTable(id){
  ['positive','neutral','negative'].forEach(k=>{
    const el = document.getElementById('scenario_'+k);
    if(el) el.style.display = (k===id)?'':'none';
  });
}

// bind radios
document.querySelectorAll('input[name="scenario"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    const sel = document.querySelector('input[name="scenario"]:checked')?.value || 'neutral';
    showScenarioTable(sel);
    updateKPIIndicators(); // Update KPI when scenario changes
  });
});
// init visibility on load
window.addEventListener('load', ()=>{
  // Load saved data first
  const dataLoaded = loadAllFinancialData();
  
  // populate ê¸ì •/ë¶€ì • í‘œ from ì¤‘ë¦½ì•ˆ
  createScenarioTableSingle();
  // ensure neutral/negative follow the positive table structure
  syncTablesFromPositive();
  // Per user request: show only the ë¶€ì •ì•ˆ table by default
  setOnlyNegativeScenarioVisible();
  // bind input events and initialize the ì„ëŒ€ë£Œ column in all scenario tables
  bindGlampingInputsToRentUpdate();
  updateAllScenariosRentFromInputs();
  // bind occupancy settings and apply them to all scenarios
  bindOccupancyInputs();
  updateScenarioOccupancyFromSettings();
  
  // Initialize calculations and chart after all tables are set up
  setTimeout(()=>{
    bindFinancialInputs();
    updateFinancialSummaries();
    updateAllScenarioCalculations();
    updateWeightHeader();
    updateGlampingUnitsChart();
    
    // Format all existing financial inputs with commas
    document.querySelectorAll('.financial-table tbody td:nth-child(2) input').forEach(inp => {
      formatNumberInput(inp);
    });
    
    // Format all existing operation table inputs with commas
    document.querySelectorAll('#glampingTable input[type="text"]').forEach(inp => {
      let val = removeCommas(inp.value);
      const num = parseFloat(val);
      if (!isNaN(num)) {
        inp.value = formatNumberWithCommas(Math.round(num));
      }
    });
    
    if(dataLoaded) {
      showToast('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
    }
  }, 100);
});

// ensure tab activation also shows the selected scenario
document.querySelectorAll('.tabs button').forEach(btn=>{
  const original = btn.onclick;
  btn.onclick = ()=>{
    original();
    if(btn.dataset.tab === 'glamping'){
      // refresh scenario tables when tab activated
      createScenarioTableSingle();
      // make sure neutral/negative use same header structure as positive
      syncTablesFromPositive();
      // keep only ë¶€ì •ì•ˆ visible and refresh ì„ëŒ€ë£Œ values after structural sync
      setOnlyNegativeScenarioVisible();
      bindGlampingInputsToRentUpdate();
      updateAllScenariosRentFromInputs();
      // bind occupancy settings and apply them to all scenarios
      bindOccupancyInputs();
      updateScenarioOccupancyFromSettings();
    }
  }
});

// --- Helpers: keep only ë¶€ì •ì•ˆ visible and update ì„ëŒ€ë£Œ from ìš´ì˜ ì…ë ¥í‘œ ---
let _glampingInputsBound = false;
function setOnlyNegativeScenarioVisible(){
  // hide positive and neutral scenario containers but do not alter table structure
  const pos = document.getElementById('scenario_positive'); if(pos) pos.style.display = 'none';
  const neu = document.getElementById('scenario_neutral'); if(neu) neu.style.display = 'none';
  const neg = document.getElementById('scenario_negative'); if(neg) neg.style.display = '';
  // select the negative radio so UI reflects the change
  const negRadio = document.querySelector('input[name="scenario"][value="negative"]');
  if(negRadio) negRadio.checked = true;
}

function getGlampingPrices(){
  const rows = Array.from(document.querySelectorAll('#glampingTable tbody tr'));
  // Expect rows: [ê¸°ì¤€2ì¸, ì¶”ê°€ì¸ì›(+1), ì¶”ê°€ì¸ì›(+2)] and columns: í‰ì¼, ì£¼ë§, ê³µíœ´ì¼
  const values = {weekday:null, weekend:null, holiday:null};
  if(rows.length>=1){
    const cells = rows[0].querySelectorAll('input');
    values.weekday = Number(removeCommas(cells[0]?.value || '0'));
    values.weekend = Number(removeCommas(cells[1]?.value || '0'));
    values.holiday = Number(removeCommas(cells[2]?.value || '0'));
  }
  // Return values in ì›
  return values;
}

function updateAllScenariosRentFromInputs(){
  const prices = getGlampingPrices();
  if(prices.weekday==null) return;
  // convert to ì²œì› ë‹¨ìœ„ (round)
  const p_weekday = Math.round(prices.weekday/1000);
  const p_weekend = Math.round(prices.weekend/1000);
  const p_holiday = Math.round(prices.holiday/1000);

  const tableIds = ['scenario_positive_table','scenario_neutral_table','scenario_negative_table'];
  tableIds.forEach(tblId=>{
    const tbl = document.getElementById(tblId);
    if(!tbl) return;
    const rows = Array.from(tbl.querySelectorAll('tbody tr'));
    rows.forEach(tr=>{
      const cells = Array.from(tr.children);
      // skip rows that don't have at least 3 cells (e.g., total rows with colspan)
      if(cells.length < 3) return;
      const period = (cells[1]?.textContent || '').trim();
      // Update the ì„ëŒ€ë£Œ(ì›) column (index 2) for known periods
      if(period === 'ì„±ìˆ˜ê¸°'){
        // ê³µíœ´ì¼ì„ ì„±ìˆ˜ê¸°ì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
        cells[2].textContent = p_holiday;
      }else if(period === 'ì£¼ë§'){
        cells[2].textContent = p_weekend;
      }else if(period === 'í‰ì¼'){
        cells[2].textContent = p_weekday;
      }
    });
  });
}

// backward-compatible wrapper
function updateNegativeRentFromInputs(){
  updateAllScenariosRentFromInputs();
}

function bindGlampingInputsToRentUpdate(){
  if(_glampingInputsBound) return;
  const inputs = document.querySelectorAll('#glampingTable input[type="text"]');
  inputs.forEach(inp=>inp.addEventListener('input', ()=>{
    updateAllScenariosRentFromInputs();
  }));
  _glampingInputsBound = true;
}

// --- ì˜ˆìƒ ê°€ë™ë¥  ì„¤ì • helpers ---
let _occInputsBound = false;
function getOccupancySettings(){
  return {
    positive: { high: Number(document.getElementById('occ_pos_high')?.value||0), weekend: Number(document.getElementById('occ_pos_weekend')?.value||0), weekday: Number(document.getElementById('occ_pos_weekday')?.value||0) },
    neutral:  { high: Number(document.getElementById('occ_neu_high')?.value||0), weekend: Number(document.getElementById('occ_neu_weekend')?.value||0), weekday: Number(document.getElementById('occ_neu_weekday')?.value||0) },
    negative: { high: Number(document.getElementById('occ_neg_high')?.value||0), weekend: Number(document.getElementById('occ_neg_weekend')?.value||0), weekday: Number(document.getElementById('occ_neg_weekday')?.value||0) }
  };
}

function updateScenarioOccupancyFromSettings(){
  const occ = getOccupancySettings();
  const mapping = { 'ì„±ìˆ˜ê¸°': 'high', 'ì£¼ë§': 'weekend', 'í‰ì¼': 'weekday' };
  const tableMap = { positive: 'scenario_positive_table', neutral: 'scenario_neutral_table', negative: 'scenario_negative_table' };

  function formatPercentValue(v){
    const n = Number(v);
    if(!isFinite(n)) return '';
    // Preserve integers (e.g., 70 -> "70"), but trim unnecessary decimal zeros (e.g., 18.0 -> "18", 18.50 -> "18.5")
    let s = String(n);
    if(s.indexOf('.') >= 0){
      s = s.replace(/\.0+$|(?<=(?:\d)\d)0+$/,'');
      s = s.replace(/\.$/, '');
    }
    return s;
  }

  Object.keys(tableMap).forEach(scn=>{
    const tbl = document.getElementById(tableMap[scn]);
    if(!tbl) return;
    const rows = Array.from(tbl.querySelectorAll('tbody tr'));
    rows.forEach(tr=>{
      const cells = Array.from(tr.children);
      if(cells.length < 6) return; // skip subtotal/total rows
      const period = (cells[1]?.textContent || '').trim();
      const key = mapping[period];
      if(!key) return;
      const val = occ[scn][key];
      if(val===null || val===undefined) return;
      const formatted = formatPercentValue(val);
      if(formatted !== '') cells[5].textContent = formatted + "%";
    });
  });
}

function bindOccupancyInputs(){
  if(_occInputsBound) return;
  const inputs = document.querySelectorAll('#occSettings input[type="number"]');
  inputs.forEach(inp=>inp.addEventListener('input', ()=>{
    if(!validateOccupancyInputs()) return;
    updateScenarioOccupancyFromSettings();
    updateAllScenarioCalculations();
  }));
  _occInputsBound = true;
}

/* --- Toast helpers --- */
function showToast(message, type='error', timeout=3500){
  const container = document.getElementById('toastContainer');
  if(!container) return;
  const el = document.createElement('div');
  el.className = 'toast '+(type==='error'?'error':'success');
  el.textContent = message;
  container.appendChild(el);
  setTimeout(()=>{ el.style.opacity = '0'; setTimeout(()=>el.remove(),300); }, timeout);
}

/* --- Input validation --- */
function validateWeightInput(){
  const el = document.getElementById('gWeight');
  if(!el) return true;
  const v = Number(el.value);
  if(!isFinite(v) || v < 0){
    showToast('ê°€ì¤‘ì¹˜ëŠ” 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
    return false;
  }
  return true;
}

function formatWeightValue(v){
  const n = Number(v);
  if(!isFinite(n)) return '';
  let s = String(n);
  if(s.indexOf('.') >= 0){
    s = s.replace(/\.0+$/,'');
    s = s.replace(/(\.\d*?)0+$/,'$1');
    s = s.replace(/\.$/, '');
  }
  return s;
}

function updateWeightHeader(){
  const el = document.getElementById('gWeight');
  const s = formatWeightValue(el?.value);
  // Update all weight header inputs
  document.querySelectorAll('.weightHeader input').forEach(inp=>{
    if(inp.value !== s) inp.value = s;
  });
}

function updateWeightFromHeader(value){
  const gWeightEl = document.getElementById('gWeight');
  if(gWeightEl) {
    gWeightEl.value = value;
  }
  // Sync all weight header inputs across all scenarios
  document.querySelectorAll('.weightHeader input').forEach(inp=>{
    if(inp.value !== value) inp.value = value;
  });
  // Trigger calculation update
  if(!validateWeightInput()) return;
  updateAllScenarioCalculations();
}

window.updateWeightFromHeader = updateWeightFromHeader;

window.updateWeightFromHeader = updateWeightFromHeader; 

function validateGlampingInputs(){
  const inputs = document.querySelectorAll('#glampingTable input[type="text"]');
  for(const inp of inputs){
    const v = Number(removeCommas(inp.value));
    if(!isFinite(v) || v < 0){
      showToast('ê¸€ë¨í•‘ ìš´ì˜ ì…ë ¥ê°’ì€ 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
      return false;
    }
  }
  // validate weight as well
  if(!validateWeightInput()) return false;
  return true;
} 

function validateOccupancyInputs(){
  const inputs = document.querySelectorAll('#occSettings input[type="number"]');
  for(const inp of inputs){
    const v = Number(inp.value);
    if(!isFinite(v) || v < 0 || v > 100){
      showToast('ê°€ë™ë¥ ì€ 0~100 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
      return false;
    }
  }
  return true;
}

/* --- Core: calculate revenue / add-on columns for a scenario table --- */
function updateAllScenarioCalculations(){
  if(!validateGlampingInputs()) return;
  const prices = getGlampingPrices(); // in ì›
  // convert to ì²œì›
  const base = { weekday: Math.round(prices.weekday/1000), weekend: Math.round(prices.weekend/1000), holiday: Math.round(prices.holiday/1000) };
  // add-on prices total (full price for +1 and +2)
  const glRows = Array.from(document.querySelectorAll('#glampingTable tbody tr'));
  if(glRows.length < 3) return; // need base, +1, +2 rows
  const baseRowInputs = glRows[0].querySelectorAll('input');
  const add1RowInputs = glRows[1].querySelectorAll('input');
  const add2RowInputs = glRows[2].querySelectorAll('input');
  const addon = {
    weekday: { add1: Math.round((Number(removeCommas(add1RowInputs[0]?.value||'0')) - Number(removeCommas(baseRowInputs[0]?.value||'0'))) / 1000), add2: Math.round((Number(removeCommas(add2RowInputs[0]?.value||'0')) - Number(removeCommas(baseRowInputs[0]?.value||'0'))) / 1000) },
    weekend: { add1: Math.round((Number(removeCommas(add1RowInputs[1]?.value||'0')) - Number(removeCommas(baseRowInputs[1]?.value||'0'))) / 1000), add2: Math.round((Number(removeCommas(add2RowInputs[1]?.value||'0')) - Number(removeCommas(baseRowInputs[1]?.value||'0'))) / 1000) },
    holiday: { add1: Math.round((Number(removeCommas(add1RowInputs[2]?.value||'0')) - Number(removeCommas(baseRowInputs[2]?.value||'0'))) / 1000), add2: Math.round((Number(removeCommas(add2RowInputs[2]?.value||'0')) - Number(removeCommas(baseRowInputs[2]?.value||'0'))) / 1000) }
  };

  const mapping = { 'ì„±ìˆ˜ê¸°': 'holiday', 'ì£¼ë§': 'weekend', 'í‰ì¼': 'weekday' };
  ['scenario_positive_table','scenario_neutral_table','scenario_negative_table'].forEach(tblId=>{
    const tbl = document.getElementById(tblId);
    if(!tbl) return;
    const rows = Array.from(tbl.querySelectorAll('tbody tr'));
    let currentUnits = null;
    // determine scenario key from table id
    const scnKey = tblId.includes('positive')? 'positive' : tblId.includes('neutral')? 'neutral' : 'negative';
    const occSettings = getOccupancySettings()[scnKey];
    rows.forEach(tr=>{
      const cells = Array.from(tr.children);
      if(cells.length < 6) return; // skip subtotal/total rows
      const first = (cells[0]?.textContent || '').trim();
      const m = first.match(/\((\d+)\)/);
      if(m) currentUnits = Number(m[1]);
      if(currentUnits==null) return; // skip rows until we know units
      const period = (cells[1]?.textContent || '').trim();
      const key = mapping[period];
      if(!key) return;
      const daysVal = parseInt((cells[3]?.textContent||'').replace(/[^0-9]/g,'')) || 0;
      const occText = (cells[5]?.textContent||'').trim();
      let occNum = parsePercent(occText);
      if(occNum == null) occNum = occSettings[key];
      // normalize to decimal (0-1): if value appears as 0-100 percentage, divide by 100
      let occDecimal = (typeof occNum === 'number') ? (occNum > 1 ? occNum/100 : occNum) : 0;
      // rent in ì²œì›
      const rent_th = base[key];
      const rev = Math.round(currentUnits * rent_th * daysVal * occDecimal);
      cells[6].textContent = formatNumberWithCommas(rev);
      // add1/add2 totals
      const add1_total = Math.round(currentUnits * addon[key].add1 * daysVal * occDecimal);
      const add2_total = Math.round(currentUnits * addon[key].add2 * daysVal * occDecimal);
      cells[7].textContent = formatNumberWithCommas(add1_total);
      cells[8].textContent = formatNumberWithCommas(add2_total);
      // ê°€ì¤‘ì¹˜ ê³„ì‚°: (ì¶”ê°€ì¸ì›(1) + ì¶”ê°€ì¸ì›(2)) * ê°€ì¤‘ì¹˜ (gWeight), ê²°ê³¼ëŠ” ì²œì› ë‹¨ìœ„
      const weightInput = document.querySelector('.weightHeader input');
      const weightFactor = Number(weightInput?.value || document.getElementById('gWeight')?.value) || 0;
      const weightVal = Math.round((add1_total + add2_total) * weightFactor);
      cells[9].textContent = formatNumberWithCommas(weightVal);
    });
  });
  // update scenario summaries after table calculations
  updateScenarioSummaries();
}

// Bind existing input listeners to also recompute derived columns
(function bindAdditionalListeners(){
  // extend existing bindings
  const glInputs = document.querySelectorAll('#glampingTable input[type="text"]');
  glInputs.forEach(inp=>{
    inp.addEventListener('input', ()=>{
      if(!validateGlampingInputs()) return;
      updateAllScenariosRentFromInputs();
      updateAllScenarioCalculations();
    });
    
    // Add comma formatting on blur
    inp.addEventListener('blur', (e) => {
      let val = removeCommas(e.target.value);
      const num = parseFloat(val);
      if (!isNaN(num)) {
        e.target.value = formatNumberWithCommas(Math.round(num));
      }
      updateAllScenariosRentFromInputs();
      updateAllScenarioCalculations();
    });
    
    // Remove commas on focus
    inp.addEventListener('focus', (e) => {
      e.target.value = removeCommas(e.target.value);
    });
  });

  const occInputs = document.querySelectorAll('#occSettings input[type="number"]');
  occInputs.forEach(inp=>{
    inp.addEventListener('input', ()=>{
      if(!validateOccupancyInputs()) return;
      updateScenarioOccupancyFromSettings();
      updateAllScenarioCalculations();
    });
  });

  const weightEl = document.getElementById('gWeight');
  if(weightEl){
    weightEl.addEventListener('input', ()=>{
      if(!validateWeightInput()) return;
      updateWeightHeader();
      updateAllScenarioCalculations();
    });
    // initialize header to current value
    updateWeightHeader();
  }
})();

// Bind caravan checkbox to chart update
if(includeCaravanChart){
  includeCaravanChart.addEventListener('change', ()=>{
    updateGlampingUnitsChart();
  });
}

/* create ê¸ì •/ë¶€ì • variant tables by adjusting numeric cells (+/-10%) */
function formatNumberWithCommas(n){ return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }

function removeCommas(str) {
  return str.replace(/,/g, '');
}

function formatNumberInput(input) {
  let val = removeCommas(input.value);
  if (val === '' || val === '-') return;
  const num = parseFloat(val);
  if (!isNaN(num)) {
    input.value = formatNumberWithCommas(Math.round(num));
  }
}

function adjustTableNumbers(tableEl, factor){
  const t = tableEl.cloneNode(true);
  t.querySelectorAll('td').forEach(td=>{
    const txt = td.textContent.trim();
    if(!txt) return;
    if(txt.indexOf('%')>=0) return;
    // remove commas and non-numeric chars
    const num = Number(txt.replace(/,/g,'').replace(/[^\d.-]/g,''));
    if(!isFinite(num)) return;
    const adjusted = Math.round(num * factor);
    td.textContent = formatNumberWithCommas(adjusted);
  });
  return t;
}

// --- Scenario table parsing helpers (tables are in 'ì²œì›' units) ---
function parseTableNumberToWon(s){
  if(!s) return null;
  const cleaned = s.toString().replace(/,/g,'').replace(/[^\d.-]/g,'').trim();
  if(cleaned === '') return null;
  const asNum = Number(cleaned);
  if(!isFinite(asNum)) return null;
  // table numbers are in ì²œì› ë‹¨ìœ„, convert to ì›
  return asNum * 1000;
}

function parsePercent(s){
  if(!s) return null;
  const m = s.toString().match(/-?\d+(?:\.\d+)?/);
  return m ? Number(m[0]) : null;
}

function extractScenarioTable(id){
  const table = document.getElementById(id);
  if(!table) return [];
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  return rows.map(tr=>{
    const cells = Array.from(tr.children);
    const getText = i => cells[i]?.textContent.trim() ?? '';
    return {
      raw: tr.textContent.trim(),
      col0: getText(0),
      facility: getText(1),
      rent_thousand: (function(n){ if(!n) return null; const v=Number(n.replace(/,/g,'')); return isFinite(v)? v : null; })(getText(2)),
      rent_won: parseTableNumberToWon(getText(2)),
      days: (function(n){ const v=parseInt(n); return isNaN(v)?null:v; })(getText(3)),
      annual_count: (function(n){ const v=parseInt(n); return isNaN(v)?null:v; })(getText(4)),
      occupancy_pct: parsePercent(getText(5)),
      revenue_won: parseTableNumberToWon(getText(6)),
      add1_won: parseTableNumberToWon(getText(7)),
      add2_won: parseTableNumberToWon(getText(8)),
      weight_raw: getText(9),
      weight: (function(n){ if(!n) return null; const p = parsePercent(n); if(p!==null) return p; const w = Number(n.replace(/,/g,'')); return isFinite(w)? w : null; })(getText(9)),
      note: getText(10)
    };
  });
}

window.extractScenarioTable = extractScenarioTable;
window.extractAllScenarios = ()=>({
  positive: extractScenarioTable('scenario_positive_table'),
  neutral: extractScenarioTable('scenario_neutral_table'),
  negative: extractScenarioTable('scenario_negative_table')
});

// --- Scenario summary helpers ---
function parseThousandNumber(s){
  if(!s) return 0;
  const cleaned = s.toString().replace(/,/g,'').replace(/[^0-9.-]/g,'').trim();
  if(cleaned === '') return 0;
  const n = Number(cleaned);
  return isFinite(n)? n : 0;
}

function sumRevenueForUnits(tblId, units, includeWeight = false){
  const tbl = document.getElementById(tblId);
  if(!tbl) return 0;
  const rows = Array.from(tbl.querySelectorAll('tbody tr'));
  let sum = 0;
  let inTargetUnit = false;
  
  rows.forEach(tr=>{
    const cells = Array.from(tr.children);
    const first = (cells[0]?.textContent||'').trim();
    const second = (cells[1]?.textContent||'').trim();
    
    // Check if this row starts a new unit section
    if(first.indexOf('('+units+')')>=0){
      inTargetUnit = true;
    } else if(first.indexOf('(')>=0 && first.indexOf(')')>=0){
      // This is a different unit section, stop accumulating
      inTargetUnit = false;
    }
    
    // If we're in the target unit section and this is a period row (ì„±ìˆ˜ê¸°, ì£¼ë§, í‰ì¼)
    if(inTargetUnit && (second === 'ì„±ìˆ˜ê¸°' || second === 'ì£¼ë§' || second === 'í‰ì¼')){
      const revText = cells[6]?.textContent || '';
      sum += parseThousandNumber(revText);
      if(includeWeight){
        const weightText = cells[9]?.textContent || '';
        sum += parseThousandNumber(weightText);
      }
    }
  });
  
  return sum;
}

function sumCaravan5(tblId, includeWeight = false){
  const tbl = document.getElementById(tblId);
  if(!tbl) return 0;
  const rows = Array.from(tbl.querySelectorAll('tbody tr'));
  let sum = 0;
  let inCaravan5 = false;
  
  rows.forEach(tr=>{
    const cells = Array.from(tr.children);
    const first = (cells[0]?.textContent||'').trim();
    const second = (cells[1]?.textContent||'').trim();
    
    // Check if this row starts the caravan 5 section
    if(first.indexOf('(5)')>=0){
      inCaravan5 = true;
    } else if(first.indexOf('(')>=0 && first.indexOf(')')>=0 && first.indexOf('(5)')<0){
      // This is a different section, stop accumulating
      inCaravan5 = false;
    }
    
    // If we're in the caravan 5 section and this is a period row
    if(inCaravan5 && (second === 'ì„±ìˆ˜ê¸°' || second === 'ì£¼ë§' || second === 'í‰ì¼')){
      const revText = cells[6]?.textContent || '';
      sum += parseThousandNumber(revText);
      if(includeWeight){
        const weightText = cells[9]?.textContent || '';
        sum += parseThousandNumber(weightText);
      }
    }
  });
  
  return sum;
}

function updateScenarioSummaries(){
  ['positive','neutral','negative'].forEach(scn=>{
    const tblId = 'scenario_'+scn+'_table';
    const gl10 = sumRevenueForUnits(tblId, 10, false);
    const gl10_w = sumRevenueForUnits(tblId, 10, true);
    const gl15 = sumRevenueForUnits(tblId, 15, false);
    const gl15_w = sumRevenueForUnits(tblId, 15, true);
    const gl30 = sumRevenueForUnits(tblId, 30, false);
    const gl30_w = sumRevenueForUnits(tblId, 30, true);
    const cv5 = sumCaravan5(tblId, false);
    const cv5_w = sumCaravan5(tblId, true);
    // set cells safely
    const setText = (sel, val)=>{ const el = document.querySelector(sel); if(el) el.textContent = val; };
    if(scn==='positive'){
      setText('.sp_10', formatNumberWithCommas(gl10));
      setText('.sp_10_w', formatNumberWithCommas(gl10_w));
      setText('.sp_10_p', formatNumberWithCommas(gl10 + cv5));
      setText('.sp_10_pw', formatNumberWithCommas(gl10_w + cv5_w));
      setText('.sp_15', formatNumberWithCommas(gl15));
      setText('.sp_15_w', formatNumberWithCommas(gl15_w));
      setText('.sp_15_p', formatNumberWithCommas(gl15 + cv5));
      setText('.sp_15_pw', formatNumberWithCommas(gl15_w + cv5_w));
      setText('.sp_30', formatNumberWithCommas(gl30));
      setText('.sp_30_w', formatNumberWithCommas(gl30_w));
      setText('.sp_30_p', formatNumberWithCommas(gl30 + cv5));
      setText('.sp_30_pw', formatNumberWithCommas(gl30_w + cv5_w));
    }else if(scn==='neutral'){
      setText('.sn_10', formatNumberWithCommas(gl10));
      setText('.sn_10_w', formatNumberWithCommas(gl10_w));
      setText('.sn_10_p', formatNumberWithCommas(gl10 + cv5));
      setText('.sn_10_pw', formatNumberWithCommas(gl10_w + cv5_w));
      setText('.sn_15', formatNumberWithCommas(gl15));
      setText('.sn_15_w', formatNumberWithCommas(gl15_w));
      setText('.sn_15_p', formatNumberWithCommas(gl15 + cv5));
      setText('.sn_15_pw', formatNumberWithCommas(gl15_w + cv5_w));
      setText('.sn_30', formatNumberWithCommas(gl30));
      setText('.sn_30_w', formatNumberWithCommas(gl30_w));
      setText('.sn_30_p', formatNumberWithCommas(gl30 + cv5));
      setText('.sn_30_pw', formatNumberWithCommas(gl30_w + cv5_w));
    }else{
      setText('.sg_10', formatNumberWithCommas(gl10));
      setText('.sg_10_w', formatNumberWithCommas(gl10_w));
      setText('.sg_10_p', formatNumberWithCommas(gl10 + cv5));
      setText('.sg_10_pw', formatNumberWithCommas(gl10_w + cv5_w));
      setText('.sg_15', formatNumberWithCommas(gl15));
      setText('.sg_15_w', formatNumberWithCommas(gl15_w));
      setText('.sg_15_p', formatNumberWithCommas(gl15 + cv5));
      setText('.sg_15_pw', formatNumberWithCommas(gl15_w + cv5_w));
      setText('.sg_30', formatNumberWithCommas(gl30));
      setText('.sg_30_w', formatNumberWithCommas(gl30_w));
      setText('.sg_30_p', formatNumberWithCommas(gl30 + cv5));
      setText('.sg_30_pw', formatNumberWithCommas(gl30_w + cv5_w));
    }
  });
  // Update glamping units chart after summaries are calculated
  updateGlampingUnitsChart();
  // Update KPI indicators
  updateKPIIndicators();
}

function updateGlampingUnitsChart(){
  if(!glampingUnitsChartEl) return;
  
  const includeCaravan = includeCaravanChart?.checked || false;
  
  // Collect data for all scenarios
  const scenarios = ['positive', 'neutral', 'negative'];
  const units = [10, 15, 30];
  const datasets = [];
  
  const colors = {
    positive: { border: 'rgb(46, 125, 50)', bg: 'rgba(46, 125, 50, 0.2)' },
    neutral: { border: 'rgb(66, 133, 244)', bg: 'rgba(66, 133, 244, 0.2)' },
    negative: { border: 'rgb(176, 0, 32)', bg: 'rgba(176, 0, 32, 0.2)' }
  };
  
  const lineStyles = {
    positive: [],
    neutral: [5, 5],
    negative: [10, 5]
  };
  
  const labels = { positive: 'ê¸ì •ì•ˆ', neutral: 'ì¤‘ë¦½ì•ˆ', negative: 'ë¶€ì •ì•ˆ' };
  
  // Build datasets for each scenario
  scenarios.forEach(scn => {
    const tblId = 'scenario_' + scn + '_table';
    const tbl = document.getElementById(tblId);
    
    // Check if table exists before processing
    if(!tbl) {
      console.warn('Table not found:', tblId);
      return;
    }
    
    const data = [];
    units.forEach(u => {
      let glampingWithWeight = sumRevenueForUnits(tblId, u, true);
      if(includeCaravan){
        const caravanWithWeight = sumCaravan5(tblId, true);
        glampingWithWeight += caravanWithWeight;
      }
      data.push(glampingWithWeight);
    });
    
    console.log(scn + ' data:', data); // Debug log
    
    datasets.push({
      label: labels[scn],
      data: data,
      borderColor: colors[scn].border,
      backgroundColor: colors[scn].bg,
      borderWidth: 3,
      borderDash: lineStyles[scn],
      tension: 0.3,
      fill: false,
      pointRadius: 6,
      pointHoverRadius: 8,
      pointBackgroundColor: colors[scn].border,
      pointBorderColor: '#fff',
      pointBorderWidth: 2
    });
  });
  
  console.log('Total datasets:', datasets.length); // Debug log
  
  if(glampingUnitsChart){
    glampingUnitsChart.destroy();
  }
  
  glampingUnitsChart = new Chart(glampingUnitsChartEl, {
    type: 'line',
    data: {
      labels: ['10ëŒ€', '15ëŒ€', '30ëŒ€'],
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        title: {
          display: true,
          text: 'ê¸€ë¨í•‘ ëŒ€ìˆ˜ë³„ í•©ì‚°ê¸ˆì•¡ ë¹„êµ' + (includeCaravan ? ' (ì¹´ë¼ë°˜ 5ëŒ€ í¬í•¨)' : '') + ' - ê°€ì¤‘ì¹˜ í¬í•¨ (ì²œì›)',
          font: { size: 16, weight: 'bold' }
        },
        legend: {
          display: true,
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 15,
            font: { size: 13 }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed.y !== null) {
                label += formatNumberWithCommas(context.parsed.y) + ' ì²œì›';
              }
              return label;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          grace: '5%',
          ticks: {
            callback: function(value) {
              return formatNumberWithCommas(value);
            },
            maxTicksLimit: 8
          },
          title: {
            display: true,
            text: 'í•©ì‚°ê¸ˆì•¡ (ì²œì›)',
            font: { size: 13, weight: 'bold' }
          }
        },
        x: {
          title: {
            display: true,
            text: 'ê¸€ë¨í•‘ ëŒ€ìˆ˜',
            font: { size: 13, weight: 'bold' }
          }
        }
      }
    }
  });
}

function createScenarioTableSingle(){
  // Copy HTML-only between scenario tables (no numeric adjustments)
  const pos = document.getElementById('scenario_positive_table');
  const neutral = document.getElementById('scenario_neutral_table');
  const neg = document.getElementById('scenario_negative_table');

  if(pos){
    if(neutral) neutral.innerHTML = pos.innerHTML.replace(/id="scenario_positive_table"/g, 'id="scenario_neutral_table"');
    if(neg) neg.innerHTML = pos.innerHTML.replace(/id="scenario_positive_table"/g, 'id="scenario_negative_table"');
    return;
  }

  if(neutral){
    // fallback: copy neutral into others
    if(pos) pos.innerHTML = neutral.innerHTML.replace(/id="scenario_neutral_table"/g, 'id="scenario_positive_table"');
    if(neg) neg.innerHTML = neutral.innerHTML.replace(/id="scenario_neutral_table"/g, 'id="scenario_negative_table"');
  }
}

// Sync neutral and negative tables to use the same structure as the positive table
function syncTablesFromPositive(){
  const pos = document.getElementById('scenario_positive_table');
  if(!pos) return;
  ['neutral','negative'].forEach(k=>{
    const dstId = 'scenario_'+k+'_table';
    const dst = document.getElementById(dstId);
    if(dst){
      // Clone the positive table structure into the destination table while keeping its id
      dst.innerHTML = pos.innerHTML.replace(/id="scenario_positive_table"/g, `id="${dstId}"`);
    }
  });
}

/* PDF */
downloadPdf.onclick=async()=>{
  consolidateAnalysis();
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  const canvas=await html2canvas(document.body,{scale:2});
  const img=canvas.toDataURL("image/png");
  pdf.addImage(img,"PNG",0,0,210,canvas.height*210/canvas.width);
  pdf.save("Investment_Portfolio_Summary.pdf");
};
</script>

</body>
</html>
