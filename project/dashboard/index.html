<html lang="ko"><head>
<meta charset="UTF-8">
<title>Investment Portfolio Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f4f6f9;
  margin: 0;
  padding: 20px;
}

h1, h2, h3 {
  margin: 10px 0;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.tabs button {
  margin-right: 6px;
  padding: 8px 14px;
  border: none;
  background: #ddd;
  cursor: pointer;
  border-radius: 4px;
}

.tabs button.active {
  background: #2c3e50;
  color: #fff;
}

.panel {
  display: none;
  background: #fff;
  padding: 20px;
  margin-top: 15px;
  border-radius: 6px;
}

.panel.active {
  display: block;
}

label {
  display: block;
  margin-top: 10px;
  font-size: 13px;
  color: #555;
}

input, select {
  width: 220px;
  padding: 6px;
  color: #000;
}

button {
  margin-top: 15px;
  padding: 10px 16px;
  border: none;
  background: #34495e;
  color: white;
  cursor: pointer;
  border-radius: 4px;
}

.kpi {
  display: flex;
  gap: 12px;
  margin-top: 15px;
}

.card {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  width: 160px;
  text-align: center;
}

.note {
  color: #888;
  font-size: 13px;
  margin-top: 10px;
}
/* ê¸€ë¨í•‘ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
table.grid {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
table.grid th, table.grid td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}
table.grid input {
  width: 80%;
  padding: 4px;
  text-align: right;
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 14px;
}

.table-large-container {
  margin-top: 12px;
  overflow: auto;
  max-width: 100%;
  border: 1px solid #eee;
  padding: 8px;
  background: #fafafa;
  min-height: 180px;
}

.table-large-container .empty {
  color: #666;
  text-align: center;
  padding: 24px 8px;
}

/* ë¼ë””ì˜¤ë¥¼ ê°€ë¡œë¡œ ì •ë ¬ */
.scenario { 
  margin-top: 12px; 
  display: flex;
  gap: 8px;
}
.scenario label { 
  display: inline-flex;
  align-items: center;
  padding: 10px 18px;
  background: #f5f5f5;
  border: 2px solid #ddd;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 500;
  font-size: 14px;
}
.scenario label:hover {
  background: #e8e8e8;
  border-color: #bbb;
}
.scenario input[type="radio"] {
  margin-right: 8px;
  width: 18px;
  height: 18px;
  cursor: pointer;
}
.scenario input[type="radio"]:checked + span,
.scenario label:has(input[type="radio"]:checked) {
  background: #2c3e50;
  color: white;
  border-color: #2c3e50;
}

/* KPI scenario selection styling */
input[name="kpi_scenario"]:checked + span {
  color: #fff !important;
}

input[name="kpi_scenario"]:checked {
  accent-color: #fff;
}

label:has(input[name="kpi_scenario"]:checked) {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  border-color: #fff !important;
  box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
  transform: translateY(-2px);
}

label:has(input[name="kpi_scenario"]) {
  transition: all 0.3s ease;
}

label:has(input[name="kpi_scenario"]):hover {
  box-shadow: 0 3px 6px rgba(102, 126, 234, 0.3);
  transform: translateY(-1px);
}

table.large {
  border-collapse: collapse;
  width: 100%;
}

table.large th, table.large td {
  border: 1px solid #ddd;
  padding: 6px;
  min-width: 60px;
  text-align: center;
}

/* Toast notifications */
#toastContainer{position:fixed;top:20px;right:20px;z-index:9999;}
.toast{background:#333;color:#fff;padding:10px 14px;border-radius:6px;margin-top:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);opacity:0.95}
.toast.error{background:#b00020}
.toast.success{background:#2e7d32}

/* occupancy settings small tweaks */
#occSettings input[type="number"]{width:70px;text-align:right;padding-right:6px}

/* Collapsible section styling */
.collapsible-section {
  margin: 20px 0;
  border: 2px solid #3498db;
  border-radius: 10px;
  overflow: hidden;
  background: #fff;
}

.collapsible-section summary {
  cursor: pointer;
  padding: 18px 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 18px;
  font-weight: 700;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.collapsible-section summary:hover {
  background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.collapsible-section summary::before {
  content: 'â–¼';
  font-size: 14px;
  transition: transform 0.3s ease;
  display: inline-block;
}

.collapsible-section[open] summary::before {
  transform: rotate(180deg);
}

.collapsible-section summary::marker {
  display: none;
}

.collapsible-section summary::-webkit-details-marker {
  display: none;
}

.collapsible-content {
  padding: 20px;
  background: #f8f9fa;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* KPI Cards styling */
.kpi-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  text-align: center;
  color: white;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  position: relative;
  cursor: help;
}

.kpi-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.kpi-card:hover .kpi-tooltip {
  visibility: visible;
  opacity: 1;
}

.kpi-tooltip {
  visibility: hidden;
  opacity: 0;
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.9);
  color: #fff;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 13px;
  white-space: pre-line;
  z-index: 1000;
  margin-bottom: 10px;
  transition: opacity 0.3s, visibility 0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  font-weight: 400;
  text-align: left;
  line-height: 1.6;
  min-width: 250px;
  max-width: 400px;
}

.kpi-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
}

/* ê° KPI ì¹´ë“œì˜ ê³ ìœ í•œ ìƒ‰ìƒ */
.kpi-card-1 {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.kpi-card-2 {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.kpi-card-3 {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.kpi-card-4 {
  background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.kpi-card-5 {
  background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.kpi-card-6 {
  background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
}

.kpi-card-7 {
  background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
  color: #333;
}

.kpi-card-8 {
  background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%);
}

.kpi-label {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 10px;
  opacity: 0.9;
}

.kpi-value {
  font-size: 32px;
  font-weight: 700;
  margin: 10px 0;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.kpi-unit {
  font-size: 13px;
  opacity: 0.8;
  font-weight: 500;
}

/* Financial tables styling */
.financial-section {
  margin: 20px 0;
  padding: 15px;
  background: #fafafa;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}
.financial-section h3 {
  margin: 0 0 12px 0;
  color: #2c3e50;
  font-size: 16px;
  border-bottom: 2px solid #3498db;
  padding-bottom: 6px;
}
.financial-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 8px;
  font-size: 13px;
}
.financial-table th {
  background: #e8f4f8;
  padding: 8px;
  text-align: left;
  font-weight: 600;
  border: 1px solid #d0d0d0;
}
.financial-table td {
  padding: 6px 8px;
  border: 1px solid #d0d0d0;
}
.financial-table input[type="text"],
.financial-table input[type="number"] {
  width: 95%;
  padding: 4px 6px;
  border: 1px solid #ccc;
  border-radius: 3px;
  color: #333 !important;
  background-color: #fff !important;
  font-size: 13px !important;
  font-family: inherit;
}
.financial-table input[type="text"]:focus,
.financial-table input[type="number"]:focus {
  border-color: #3498db;
  outline: none;
}
.financial-table .item-name {
  width: 45%;
}
.financial-table .item-value {
  width: 45%;
}
.financial-table .item-actions {
  width: 10%;
  text-align: center;
}
.btn-small {
  padding: 4px 8px;
  font-size: 12px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  margin: 2px;
}
.btn-add {
  background: #27ae60;
  color: white;
}
.btn-add:hover {
  background: #229954;
}
.btn-delete {
  background: #e74c3c;
  color: white;
}
.btn-delete:hover {
  background: #c0392b;
}
.financial-summary {
  margin-top: 8px;
  padding: 8px 12px;
  background: #fff;
  border-radius: 4px;
  font-weight: 600;
  border-left: 4px solid #3498db;
}
</style>
</head>

<body>

<header>
  <h1>ì‚¬ì—… í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ì§€ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
  <div class="tabs">
    <button class="active" data-tab="glamping">ê¸€ë¨í•‘</button>
    <button data-tab="venture" class="">ì‹ ê·œ ë²¤ì²˜</button>
    <button data-tab="ferry">ì—¬ê°ì„ </button>
    <button data-tab="total">í†µí•© ë¶„ì„</button>
  </div>
</header>

<!-- ì €ì¥ ë²„íŠ¼ -->
<div style="display:flex; gap:8px; align-items:center; justify-content:flex-end; padding:8px 20px; background:#f8f9fa; border-bottom:1px solid #e0e0e0;">
  <button onclick="saveAllFinancialData()" style="background:#27ae60; padding:6px 12px; font-weight:500; font-size:12px; border:none; border-radius:4px; color:white; cursor:pointer;">ğŸ’¾ ë¸Œë¼ìš°ì €ì— ì €ì¥</button>
  <button onclick="downloadHTMLFile()" style="background:#3498db; padding:6px 12px; font-weight:500; font-size:12px; border:none; border-radius:4px; color:white; cursor:pointer;">ğŸ“„ HTML íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ</button>
  <button onclick="resetAllFinancialData()" style="background:#e67e22; padding:6px 12px; font-weight:500; font-size:12px; border:none; border-radius:4px; color:white; cursor:pointer;">ğŸ”„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”</button>
</div>

<!-- Toast container for user messages -->
<div id="toastContainer"></div>

<!-- ì‹œë‚˜ë¦¬ì˜¤ ë° ë§¤ì¶œ êµ¬ì„± ì„ íƒ -->
<div style="margin: 20px 0 15px 0; padding: 12px 15px; background: #f8f9fa; border-radius: 6px; border: 2px solid #e0e0e0; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
  <div style="display: flex; gap: 8px; align-items: center;">
    <span style="font-weight: 600; font-size: 13px; color: #555;">ì‹œë‚˜ë¦¬ì˜¤:</span>
    <label style="display: inline-flex; align-items: center; cursor: pointer; padding: 4px 10px; background: #fff; border-radius: 4px; border: 1px solid #667eea; transition: all 0.2s; font-size: 12px;">
      <input type="radio" name="kpi_scenario" value="positive" style="width: 14px; height: 14px; margin-right: 5px; cursor: pointer;" onchange="updateKPIScenario()" checked="checked">
      <span style="font-weight: 500; color: #667eea;">ê¸ì •</span>
    </label>
    <label style="display: inline-flex; align-items: center; cursor: pointer; padding: 4px 10px; background: #fff; border-radius: 4px; border: 1px solid #667eea; transition: all 0.2s; font-size: 12px;">
      <input type="radio" name="kpi_scenario" value="neutral" style="width: 14px; height: 14px; margin-right: 5px; cursor: pointer;" onchange="updateKPIScenario()">
      <span style="font-weight: 500; color: #667eea;">ì¤‘ë¦½</span>
    </label>
    <label style="display: inline-flex; align-items: center; cursor: pointer; padding: 4px 10px; background: #fff; border-radius: 4px; border: 1px solid #667eea; transition: all 0.2s; font-size: 12px;">
      <input type="radio" name="kpi_scenario" value="negative" style="width: 14px; height: 14px; margin-right: 5px; cursor: pointer;" onchange="updateKPIScenario()">
      <span style="font-weight: 500; color: #667eea;">ë¶€ì •</span>
    </label>
  </div>
  
  <div style="height: 20px; width: 1px; background: #ddd;"></div>
  
  <div style="display: flex; gap: 10px; align-items: center;">
    <span style="font-weight: 600; font-size: 13px; color: #555;">ê¸€ë¨í•‘:</span>
    <select id="kpi_glamping_units" style="padding: 4px 10px; border-radius: 4px; border: 1px solid #667eea; font-weight: 500; cursor: pointer; font-size: 12px;" onchange="updateKPIScenario()">
      <option value="10">10ëŒ€</option>
      <option value="15" selected="selected">15ëŒ€</option>
      <option value="30">30ëŒ€</option>
    </select>
  </div>
  
  <div style="display: flex; gap: 8px; align-items: center;">
    <label style="display: inline-flex; align-items: center; cursor: pointer; padding: 4px 10px; background: #fff; border-radius: 4px; border: 1px solid #667eea; font-size: 12px;">
      <input type="checkbox" id="kpi_include_caravan" style="width: 14px; height: 14px; margin-right: 5px; cursor: pointer;" onchange="updateKPIScenario()" checked="checked">
      <span style="font-weight: 500; color: #667eea;">ì¹´ë¼ë°˜ 5ëŒ€</span>
    </label>
  </div>
  
  <div style="height: 20px; width: 1px; background: #ddd;"></div>
  
  <div style="display: flex; gap: 8px; align-items: center;">
    <button onclick="openMapPopup()" style="padding: 6px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 4px; font-weight: 600; font-size: 13px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
      ğŸ—ºï¸ MAP
    </button>
  </div>
</div>

<!-- í•µì‹¬ ì¬ë¬´ ì„±ê³¼ ì§€í‘œ (ìƒë‹¨) -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 0 0 20px 0;">
  <!-- 1. ì´ ì´ˆê¸° íˆ¬ìë¹„ -->
  <div class="kpi-card kpi-card-1">
    <div class="kpi-tooltip">ì´ˆê¸° íˆ¬ìë¹„(CAPEX) í•©ê³„
= 12.8ì–µ + 0.3ì–µ
= 13.1ì–µì›</div>
    <div class="kpi-label">ğŸ’µ ì´ ì´ˆê¸° íˆ¬ìë¹„</div>
    <div class="kpi-value" id="kpi_totalInvest">13.1</div>
    <div class="kpi-unit">ì–µì›</div>
  </div>
  
  <!-- 2. ì—°ê°„ ìš´ì˜ë¹„ -->
  <div class="kpi-card kpi-card-2">
    <div class="kpi-tooltip">ê³ ì • ìš´ì˜ë¹„ + ë³€ë™ ìš´ì˜ë¹„
= 3.8ì–µ + 0.2ì–µ
= 3.9ì–µì›/ë…„</div>
    <div class="kpi-label">ğŸ“‰ ì—°ê°„ ìš´ì˜ë¹„</div>
    <div class="kpi-value" id="kpi_opex">3.9</div>
    <div class="kpi-unit">ì–µì›/ë…„</div>
  </div>
  
  <!-- 3. EBITDA -->
  <div class="kpi-card kpi-card-3">
    <div class="kpi-tooltip">ë§¤ì¶œì•¡(ë¶€ê°€ì„¸ ì œì™¸) - ìš´ì˜ë¹„ - ë§ˆì¼€íŒ…ë¹„
ë¶€ê°€ì„¸ í¬í•¨: 9.2ì–µ
ë¶€ê°€ì„¸ ì œì™¸: 8.4ì–µ
= 8.4ì–µ - 3.9ì–µ - 0.0ì–µ
= 4.4ì–µì›/ë…„</div>
    <div class="kpi-label">ğŸ“Š EBITDA</div>
    <div class="kpi-value" id="kpi_ebitda">4.4</div>
    <div class="kpi-unit">ì–µì›/ë…„</div>
  </div>
  
  <!-- 4. ì˜ì—…ì´ìµ -->
  <div class="kpi-card kpi-card-4">
    <div class="kpi-tooltip">EBITDA - ê°ê°€ìƒê°ë¹„
= 4.4ì–µ - 0.3ì–µ
= 4.2ì–µì›/ë…„</div>
    <div class="kpi-label">ğŸ’° ì˜ì—…ì´ìµ</div>
    <div class="kpi-value" id="kpi_operatingProfit">4.2</div>
    <div class="kpi-unit">ì–µì›/ë…„</div>
  </div>
  
  <!-- 5. ì„¸í›„ì´ìµ -->
  <div class="kpi-card kpi-card-5">
    <div class="kpi-tooltip">ì˜ì—…ì´ìµ Ã— (1 - ë²•ì¸ì„¸ìœ¨)
= 4.2ì–µ Ã— (1 - 22.0%)
= 3.2ì–µì›/ë…„</div>
    <div class="kpi-label">âœ… ì„¸í›„ì´ìµ</div>
    <div class="kpi-value" id="kpi_netProfit">3.2</div>
    <div class="kpi-unit">ì–µì›/ë…„</div>
  </div>
  
  <!-- 6. ì—°ê°„ ìˆœí˜„ê¸ˆíë¦„ -->
  <div class="kpi-card kpi-card-6">
    <div class="kpi-tooltip">ì„¸í›„ì´ìµ + ê°ê°€ìƒê°ë¹„
= 3.2ì–µ + 0.3ì–µ
= 3.5ì–µì›/ë…„</div>
    <div class="kpi-label">ğŸ’¸ ì—°ê°„ ìˆœí˜„ê¸ˆíë¦„</div>
    <div class="kpi-value" id="kpi_cashFlow">3.5</div>
    <div class="kpi-unit">ì–µì›/ë…„</div>
  </div>
  
  <!-- 7. íˆ¬ìíšŒìˆ˜ê¸°ê°„ -->
  <div class="kpi-card kpi-card-7">
    <div class="kpi-tooltip">ì´ˆê¸° íˆ¬ìë¹„ Ã· ì—°ê°„ ìˆœí˜„ê¸ˆíë¦„
= 13.1ì–µ Ã· 3.5ì–µ
= 3.7ë…„</div>
    <div class="kpi-label">â±ï¸ íˆ¬ìíšŒìˆ˜ê¸°ê°„</div>
    <div class="kpi-value" id="kpi_payback">3.7</div>
    <div class="kpi-unit">ë…„</div>
  </div>
  
  <!-- 8. IRR -->
  <div class="kpi-card kpi-card-8">
    <div class="kpi-tooltip">NPV = 0ì´ ë˜ëŠ” í• ì¸ìœ¨
(5ë…„ê°„ í˜„ê¸ˆíë¦„ ê¸°ì¤€)
íˆ¬ì: 13.1ì–µ
ì—°ê°„ CF: 3.5ì–µ
IRR = 23.6%</div>
    <div class="kpi-label">ğŸ”¥ IRR (5ë…„ ê¸°ì¤€)</div>
    <div class="kpi-value" id="kpi_irr">23.6</div>
    <div class="kpi-unit">%</div>
  </div>
</div>

<!-- ì—¬ê°ì„  -->
<section id="ferry" class="panel">
<h2>ì—¬ê°ì„  ì‚¬ì—… (ì‹ ì¡° í¬í•¨)</h2>

<label>ì„ ê°€ (ì–µì›)</label>
<input id="shipPrice" type="number" value="300">

<label>ë³´ì¡°ê¸ˆ (ì–µì›)</label>
<input id="subsidy" type="number" value="60">

<label>ì—°ê°„ ìš´í•­ì¼ìˆ˜</label>
<input id="days" type="number" value="330">

<label>ì¼ í‰ê·  ìŠ¹ê°ìˆ˜</label>
<input id="passengers" type="number" value="800">

<label>ê°ë‹¨ê°€ (ì›)</label>
<input id="fare" type="number" value="50000">

<label>ì—°ê°„ ìš´ì˜ë¹„ (ì–µì›)</label>
<input id="opex" type="number" value="120">

<h3>ì‹œë‚˜ë¦¬ì˜¤</h3>
<label>ê°ë‹¨ê°€ ì¡°ì •</label>
<input id="fareSlider" type="range" min="0.8" max="1.2" step="0.05" value="1">
<span id="fareRate">100%</span>

<label>ë³´ì¡°ê¸ˆ ì ìš©</label>
<select id="subsidyToggle">
  <option value="on" selected="selected">ON</option>
  <option value="off">OFF</option>
</select>

<button id="ferryAnalyze">ì—¬ê°ì„  ë¶„ì„ ì‹¤í–‰</button>
<div id="ferrySummary" class="note">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</section>

<!-- ê¸€ë¨í•‘ -->
<section id="glamping" class="panel active">
<h2>ê¸€ë¨í•‘ ì‚¬ì—…</h2>

<!-- ì¬ë¬´ ì…ë ¥ ì„¹ì…˜: ë¶„í• ëœ ë‘ ê°œì˜ ì ‘ì´ì‹ ì˜ì—­ -->
<details class="collapsible-section">
  <summary>ï¿½ ì´ˆê¸° íˆ¬ìë¹„ìš© (CAPEX &amp; ê°œì—…ì¤€ë¹„)</summary>
  <div class="collapsible-content">

<div class="financial-section">
  <h3>[1] ì´ˆê¸° íˆ¬ìë¹„ (CAPEX) - ë‹¨ìœ„: ë§Œì›</h3>
  <table class="financial-table" id="capexTable">
    <thead>
      <tr>
        <th class="item-name">í•­ëª©</th>
        <th class="item-value">ê¸ˆì•¡ (ë§Œì›)</th>
        <th class="item-actions">ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      <!-- í† ì§€ë¹„ìš© í‘œì‹œ í–‰ (í´ë¦­í•˜ë©´ ìƒì„¸ ê³„ì‚° ì˜ì—­ í† ê¸€) -->
      <tr class="land-cost-row" style="background: #e8f8f0; cursor: pointer;" onclick="toggleLandCalcDetails()" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ê³„ì‚° ë³´ê¸°/ìˆ¨ê¸°ê¸°">
        <td style="position: relative;">
          <span id="landCalcToggleIcon" style="display: inline-block; margin-right: 8px; transition: transform 0.3s; transform: rotate(-90deg);">â–¶</span>
          <input type="text" value="í† ì§€ ë§¤ì…ë¹„" readonly="" style="background-color: transparent; cursor: pointer; border: none; font-weight: 600; display: inline; width: auto;">
        </td>
        <td><input type="text" id="landCostInput" value="71,400" readonly="" style="background-color: transparent; cursor: pointer; font-weight: 700; color: #27ae60; border: none; font-size: 15px;"></td>
        <td><span style="color: #27ae60; font-size: 11px; font-weight: 600;">âœ“ ìë™ê³„ì‚°</span></td>
      </tr>
      <!-- í† ì§€ë¹„ìš© ìë™ ê³„ì‚° ìƒì„¸ ì˜ì—­ (í† ê¸€ ê°€ëŠ¥) -->
      <tr class="land-calc-header" id="landCalcDetails" style="background: linear-gradient(135deg, rgb(232, 244, 248) 0%, rgb(212, 233, 247) 100%); display: none;">
        <td colspan="3" style="padding: 12px;">
          <div style="font-weight: 700; color: #2c3e50; font-size: 14px; margin-bottom: 8px;">ğŸï¸ í† ì§€ë¹„ìš© ìƒì„¸ ê³„ì‚° (ìˆ˜ì •ë¶ˆê°€)</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
            <div>
              <label style="font-size: 11px; color: #555; font-weight: 600; display: block; margin-bottom: 3px;">ê³µì‹œì§€ê°€ (ì›/mÂ²)</label>
              <input type="number" id="landPrice" value="255000" style="width: 100%; padding: 6px; border: 2px solid #3498db; border-radius: 4px; font-weight: 500; font-size: 13px;" onchange="calculateLandCost()">
            </div>
            <div>
              <label style="font-size: 11px; color: #555; font-weight: 600; display: block; margin-bottom: 3px;">ë©´ì  (mÂ²)</label>
              <input type="number" id="landArea" value="2000" style="width: 100%; padding: 6px; border: 2px solid #3498db; border-radius: 4px; font-weight: 500; font-size: 13px;" onchange="calculateLandCost()">
            </div>
            <div>
              <label style="font-size: 11px; color: #555; font-weight: 600; display: block; margin-bottom: 3px;">ì‹¤ê±°ë˜ë¹„ìœ¨</label>
              <input type="number" id="landRatio" value="1.4" step="0.1" style="width: 100%; padding: 6px; border: 2px solid #3498db; border-radius: 4px; font-weight: 500; font-size: 13px;" onchange="calculateLandCost()">
            </div>
            <div>
              <label style="font-size: 11px; color: #555; font-weight: 600; display: block; margin-bottom: 3px;">ê³„ì‚°ê²°ê³¼ (ë§Œì›)</label>
              <input type="text" id="calculatedLandCost" value="71,400" readonly="" style="width: 100%; padding: 6px; border: 2px solid #27ae60; border-radius: 4px; font-weight: 700; background: #fff; color: #27ae60; font-size: 14px; cursor: not-allowed;">
            </div>
          </div>
          <div style="margin-top: 6px; color: #555; font-size: 11px;">
            ğŸ’¡ ê³„ì‚°ì‹: ê³µì‹œì§€ê°€ Ã— ë©´ì  Ã— ì‹¤ê±°ë˜ë¹„ìœ¨ Ã· 10,000
          </div>
        </td>
      </tr>
      <tr>
        <td><input type="text" value="ë¶€ì§€ ì¡°ì„±ë¹„(í† ëª©)"></td>
        <td><input type="text" value="20,000"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ê¸€ë¨í•‘ ì‹œì„¤ ì„¤ì¹˜ë¹„"></td>
        <td><input type="text" value="20,000"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ê³µìš©ì‹œì„¤(ê´€ë¦¬ë™, í™”ì¥ì‹¤ ë“±)"></td>
        <td><input type="text" value="10,000"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì„¤ê³„Â·ì¸í—ˆê°€ ë¹„ìš©"></td>
        <td><input type="text" value="5,000"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      
      
    <tr>
    <td><input type="text" placeholder="í•­ëª©ëª… ì…ë ¥" value="í–‰ì •ë¹„ìš©"></td>
    <td><input type="text" value="2,000"></td>
    <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
  </tr></tbody>
  </table>
  <button class="btn-small btn-add" onclick="addFinancialRow('capexTable')">+ í•­ëª© ì¶”ê°€</button>
  <div class="financial-summary">í•©ê³„: <span id="capexSum">128,400</span> ë§Œì› (<span id="capexSumBillion">12.84</span> ì–µì›)</div>
</div>

<div class="financial-section">
  <h3>[2] ê°œì—… ì „ ë¹„ìš© (Pre-opening Cost) - ë‹¨ìœ„: ë§Œì›</h3>
  <table class="financial-table" id="preopeningTable">
    <thead>
      <tr>
        <th class="item-name">í•­ëª©</th>
        <th class="item-value">ê¸ˆì•¡ (ë§Œì›)</th>
        <th class="item-actions">ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" value="ì˜¤í”ˆ ì¤€ë¹„ ì¸ê±´ë¹„"></td>
        <td><input type="text" value="2,000"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì´ˆê¸° ë§ˆì¼€íŒ… ë¹„ìš©"></td>
        <td><input type="text" value="300"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ì‹œìš´ì˜ ë¹„ìš©"></td>
        <td><input type="text" value="300"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      
      
    </tbody>
  </table>
  <button class="btn-small btn-add" onclick="addFinancialRow('preopeningTable')">+ í•­ëª© ì¶”ê°€</button>
  <div class="financial-summary">í•©ê³„: <span id="preopeningSum">2,600</span> ë§Œì› (<span id="preopeningSumBillion">0.26</span> ì–µì›)</div>
</div>

  </div>
</details>

<details class="collapsible-section">
  <summary>ğŸ“Š ìš´ì˜ë¹„ìš© (ê³ ì •ë¹„, ë³€ë™ë¹„ &amp; ì„¸ê¸ˆ)</summary>
  <div class="collapsible-content">

<div class="financial-section">
  <h3>[3] ìš´ì˜ ê³ ì •ë¹„ (ì—°ê°„ ê¸°ì¤€) - ë‹¨ìœ„: ë§Œì›/ë…„</h3>
  <table class="financial-table" id="fixedCostTable">
    <thead>
      <tr>
        <th class="item-name">í•­ëª©</th>
        <th class="item-value">ê¸ˆì•¡ (ë§Œì›/ë…„)</th>
        <th class="item-actions">ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      <!-- ê°ê°€ìƒê°ë¹„ í‘œì‹œ í–‰ (í´ë¦­í•˜ë©´ ìƒì„¸ ê³„ì‚° ì˜ì—­ í† ê¸€) -->
      <tr class="depreciation-row" style="background: #fff3e0; cursor: pointer;" onclick="toggleDepreciationDetails()" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ê³„ì‚° ë³´ê¸°/ìˆ¨ê¸°ê¸°">
        <td style="position: relative;">
          <span id="depreciationToggleIcon" style="display: inline-block; margin-right: 8px; transition: transform 0.3s; transform: rotate(-90deg);">â–¶</span>
          <input type="text" value="ê°ê°€ìƒê°ë¹„" readonly="" style="background-color: transparent; cursor: pointer; border: none; font-weight: 600; display: inline; width: auto;">
        </td>
        <td><input type="text" id="depreciationInput" value="2,700" readonly="" style="background-color: transparent; cursor: pointer; font-weight: 700; color: #ff6f00; border: none; font-size: 15px;"></td>
        <td><span style="color: #ff6f00; font-size: 11px; font-weight: 600;">âœ“ ìë™ê³„ì‚°</span></td>
      </tr>
      <!-- ê°ê°€ìƒê°ë¹„ ìë™ ê³„ì‚° ìƒì„¸ ì˜ì—­ (í† ê¸€ ê°€ëŠ¥) -->
      <tr class="depreciation-header" id="depreciationDetails" style="background: linear-gradient(135deg, rgb(255, 243, 224) 0%, rgb(255, 224, 178) 100%); display: none;">
        <td colspan="3" style="padding: 15px;">
          <div style="font-weight: 700; color: #e65100; font-size: 14px; margin-bottom: 12px;">ğŸ“Š ê°ê°€ìƒê°ë¹„ ìƒì„¸ ê³„ì‚°</div>
          
          <!-- ê°ê°€ìƒê° ìì‚° í…Œì´ë¸” -->
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px; background: white; border-radius: 4px; overflow: hidden;">
            <thead>
              <tr style="background: #f5f5f5;">
                <th style="padding: 8px; text-align: left; border: 1px solid #ddd; font-size: 12px;">ìì‚°ëª…</th>
                <th style="padding: 8px; text-align: center; border: 1px solid #ddd; font-size: 12px;">ì·¨ë“ê°€ì•¡<br>(ë§Œì›)</th>
                <th style="padding: 8px; text-align: center; border: 1px solid #ddd; font-size: 12px;">ë‚´ìš©ì—°ìˆ˜<br>(ë…„)</th>
                <th style="padding: 8px; text-align: center; border: 1px solid #ddd; font-size: 12px;">ìƒê°ë°©ë²•</th>
                <th style="padding: 8px; text-align: center; border: 1px solid #ddd; font-size: 12px;">ì—°ê°„ ìƒê°ë¹„<br>(ë§Œì›)</th>
                <th style="padding: 8px; text-align: center; border: 1px solid #ddd; font-size: 12px; width: 80px;">ì‘ì—…</th>
              </tr>
            </thead>
            <tbody id="depreciationAssetsTable">
              <tr>
                <td style="padding: 6px; border: 1px solid #ddd;"><input type="text" value="ê¸€ë¨í•‘ ì‹œì„¤" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;"></td>
                <td style="padding: 6px; border: 1px solid #ddd;"><input type="number" value="20000" style="width: 100%; padding: 4px; border: 1px solid rgb(204, 204, 204); border-radius: 3px; font-size: 12px; text-align: right; color: rgb(51, 51, 51); background-color: rgb(255, 255, 255);" onchange="calculateDepreciation()"></td>
                <td style="padding: 6px; border: 1px solid #ddd;"><input type="number" value="10" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; text-align: center;" onchange="calculateDepreciation()"></td>
                <td style="padding: 6px; border: 1px solid #ddd;">
                  <select style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;" onchange="calculateDepreciation()">
                    <option value="straight" selected="selected">ì •ì•¡ë²•</option>
                    <option value="declining">ì •ë¥ ë²•</option>
                  </select>
                </td>
                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: 600; color: #ff6f00;" class="depreciation-amount">1,800</td>
                <td style="padding: 6px; border: 1px solid #ddd; text-align: center;"><button class="btn-small btn-delete" onclick="deleteDepreciationAsset(this)" style="font-size: 11px; padding: 3px 8px;">ì‚­ì œ</button></td>
              </tr>
              
              <tr>
                <td style="padding: 6px; border: 1px solid #ddd;"><input type="text" value="ê³µìš©ì‹œì„¤" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;"></td>
                <td style="padding: 6px; border: 1px solid #ddd;"><input type="number" value="10000" style="width: 100%; padding: 4px; border: 1px solid rgb(204, 204, 204); border-radius: 3px; font-size: 12px; text-align: right; color: rgb(51, 51, 51); background-color: rgb(255, 255, 255);" onchange="calculateDepreciation()"></td>
                <td style="padding: 6px; border: 1px solid #ddd;"><input type="number" value="10" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; text-align: center;" onchange="calculateDepreciation()"></td>
                <td style="padding: 6px; border: 1px solid #ddd;">
                  <select style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;" onchange="calculateDepreciation()">
                    <option value="straight" selected="selected">ì •ì•¡ë²•</option>
                    <option value="declining">ì •ë¥ ë²•</option>
                  </select>
                </td>
                <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: 600; color: #ff6f00;" class="depreciation-amount">900</td>
                <td style="padding: 6px; border: 1px solid #ddd; text-align: center;"><button class="btn-small btn-delete" onclick="deleteDepreciationAsset(this)" style="font-size: 11px; padding: 3px 8px;">ì‚­ì œ</button></td>
              </tr>
              
            </tbody>
          </table>
          
          <button class="btn-small btn-add" onclick="addDepreciationAsset()" style="margin-top: 8px;">+ ìì‚° í•­ëª© ì¶”ê°€</button>
          
          <div style="margin-top: 10px; padding: 8px; background: white; border-radius: 4px; font-weight: 600; color: #e65100; text-align: right; border: 2px solid #ff6f00;">
            ì´ ê°ê°€ìƒê°ë¹„: <span id="totalDepreciation">2,700</span> ë§Œì›/ë…„
          </div>
          
          <div style="margin-top: 8px; color: #555; font-size: 11px;">
            ğŸ’¡ <strong>ì •ì•¡ë²•:</strong> ì·¨ë“ê°€ì•¡ Ã· ë‚´ìš©ì—°ìˆ˜ (ì”ì¡´ê°€ì¹˜ 0) | <strong>ì •ë¥ ë²•:</strong> ì·¨ë“ê°€ì•¡ Ã— ìƒê°ë¥ (ê·¼ì‚¬ì¹˜ ì‚¬ìš©, ì”ì¡´ê°€ì¹˜ 0)
          </div>
        </td>
      </tr>
      <tr>
        <td><input type="text" value="ì¸ê±´ë¹„"></td>
        <td><input type="text" value="4,000"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      
      <tr>
        <td><input type="text" value="ë³´í—˜ë£Œ"></td>
        <td><input type="text" value="400"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ê³µê³¼ê¸ˆ ê¸°ë³¸ìš”ê¸ˆ"></td>
        <td><input type="text" value="120"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ê´€ë¦¬ë¹„(í†µì‹ , ì‹œìŠ¤í…œ ë“±)"></td>
        <td><input type="text" value="120"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
    <tr>
    <td><input type="text" placeholder="í•­ëª©ëª… ì…ë ¥" value="ì•ˆì „ì ê²€ë¹„"></td>
    <td><input type="text" value="275"></td>
    <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
  </tr></tbody>
  </table>
  <button class="btn-small btn-add" onclick="addFinancialRow('fixedCostTable')">+ í•­ëª© ì¶”ê°€</button>
  <div class="financial-summary">í•©ê³„: <span id="fixedCostSum">37,615</span> ë§Œì›/ë…„ (<span id="fixedCostSumBillion">3.76</span> ì–µì›/ë…„)</div>
</div>

<div class="financial-section">
  <h3>[4] ìš´ì˜ ë³€ë™ë¹„ (ì—°ê°„ ê¸°ì¤€) - ë‹¨ìœ„: ë§Œì›/ë…„</h3>
  <table class="financial-table" id="variableCostTable">
    <thead>
      <tr>
        <th class="item-name">í•­ëª©</th>
        <th class="item-value">ê¸ˆì•¡ (ë§Œì›/ë…„)</th>
        <th class="item-actions">ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td><input type="text" value="ë§ˆì¼€íŒ…ë¹„"></td>
        <td><input type="text" value="300"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      
      <tr>
        <td><input type="text" value="ì—ë„ˆì§€ ë¹„ìš©(ì „ë ¥ë¹„,ìš©ìˆ˜ë¹„)"></td>
        <td><input type="text" value="1,300"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
      
    <tr>
    <td><input type="text" placeholder="í•­ëª©ëª… ì…ë ¥" value="ì‹œì„¤ìš´ì˜ìœ ì§€ë¹„(ìˆ˜ë¦¬ìˆ˜ì„ ë¹„)"></td>
    <td><input type="text" value="200"></td>
    <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
  </tr><tr>
    <td><input type="text" placeholder="í•­ëª©ëª… ì…ë ¥" value="ì†Œëª¨í’ˆë¹„ "></td>
    <td><input type="text" value="320"></td>
    <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
  </tr><tr>
    <td><input type="text" placeholder="í•­ëª©ëª… ì…ë ¥" value=""></td>
    <td><input type="text" value="0"></td>
    <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
  </tr></tbody>
  </table>
  <button class="btn-small btn-add" onclick="addFinancialRow('variableCostTable')">+ í•­ëª© ì¶”ê°€</button>
  <div class="financial-summary">í•©ê³„: <span id="variableCostSum">1,820</span> ë§Œì›/ë…„ (<span id="variableCostSumBillion">0.18</span> ì–µì›/ë…„)</div>
</div>

<div class="financial-section">
  <h3>[5] ê¸ˆìœµ ë° ì„¸ê¸ˆ</h3>
  <table class="financial-table" id="financeTable">
    <thead>
      <tr>
        <th class="item-name">í•­ëª©</th>
        <th class="item-value">ê°’</th>
        <th class="item-actions">ì‘ì—…</th>
      </tr>
    </thead>
    <tbody>
      <!-- ì°¨ì…ê¸ˆ ì´ì í‘œì‹œ í–‰ (í´ë¦­í•˜ë©´ ìƒì„¸ ê³„ì‚° ì˜ì—­ í† ê¸€) -->
      <tr class="loan-interest-row" style="background: #e3f2fd; cursor: pointer;" onclick="toggleLoanInterestDetails()" title="í´ë¦­í•˜ì—¬ ìƒì„¸ ê³„ì‚° ë³´ê¸°/ìˆ¨ê¸°ê¸°">
        <td style="position: relative;">
          <span id="loanInterestToggleIcon" style="display: inline-block; margin-right: 8px; transition: transform 0.3s; transform: rotate(-90deg);">â–¶</span>
          <input type="text" value="ì°¨ì…ê¸ˆ ì´ì" readonly style="background-color: transparent; cursor: pointer; border: none; font-weight: 600; display: inline; width: auto;">
        </td>
        <td><input type="text" id="loanInterestInput" value="0" readonly style="background-color: transparent; cursor: pointer; font-weight: 700; color: #1976d2; border: none; font-size: 15px;"></td>
        <td><span style="color: #1976d2; font-size: 11px; font-weight: 600;">âœ“ ìë™ê³„ì‚°</span></td>
      </tr>
      <!-- ì°¨ì…ê¸ˆ ì´ì ìë™ ê³„ì‚° ìƒì„¸ ì˜ì—­ (í† ê¸€ ê°€ëŠ¥) -->
      <tr class="loan-interest-header" id="loanInterestDetails" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); display: none;">
        <td colspan="3" style="padding: 15px;">
          <div style="font-weight: 700; color: #1565c0; font-size: 14px; margin-bottom: 12px;">ğŸ’° ì°¨ì…ê¸ˆ ì´ì ê³„ì‚°</div>
          
          <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <div style="margin-bottom: 8px;">
              <label style="font-weight: 600; color: #333; font-size: 13px; display: inline-block; width: 120px;">ì°¨ì…ê¸ˆ (ë§Œì›):</label>
              <input type="number" id="loanAmount" value="0" style="width: 150px; padding: 6px; border: 2px solid #42a5f5; border-radius: 4px; font-size: 13px; text-align: right;" onchange="calculateLoanInterest()">
            </div>
            <div style="margin-bottom: 8px;">
              <label style="font-weight: 600; color: #333; font-size: 13px; display: inline-block; width: 120px;">ì´ììœ¨ (%):</label>
              <input type="number" id="loanInterestRate" value="4.5" step="0.1" style="width: 150px; padding: 6px; border: 2px solid #42a5f5; border-radius: 4px; font-size: 13px; text-align: right;" onchange="calculateLoanInterest()">
            </div>
          </div>
          
          <div style="margin-top: 10px; padding: 8px; background: white; border-radius: 4px; font-weight: 600; color: #1565c0; text-align: right; border: 2px solid #1976d2;">
            ì—°ê°„ ì´ìë¹„ìš©: <span id="totalLoanInterest">0</span> ë§Œì›/ë…„
          </div>
          
          <div style="margin-top: 8px; color: #555; font-size: 11px;">
            ğŸ’¡ <strong>ê³„ì‚°ì‹:</strong> ì°¨ì…ê¸ˆ Ã— ì´ììœ¨ Ã· 100
          </div>
        </td>
      </tr>
      <tr>
        <td><input type="text" value="ë¶€ê°€ì„¸ (%)" readonly="" style="background-color: #f0f0f0; cursor: not-allowed;"></td>
        <td><input type="text" value="10" readonly="" style="background-color: #f0f0f0; cursor: not-allowed;"></td>
        <td><span style="color: #999; font-size: 12px;">ê³ ì •</span></td>
      </tr>
      <tr>
        <td><input type="text" value="ë²•ì¸ì„¸ìœ¨ (%)"></td>
        <td><input type="text" value="22"></td>
        <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
      </tr>
    </tbody>
  </table>
  <button class="btn-small btn-add" onclick="addFinancialRow('financeTable')">+ í•­ëª© ì¶”ê°€</button>
</div>

  </div>
</details>

<details class="collapsible-section">
  <summary>ğŸ’° ë§¤ì¶œìˆ˜ìµ ì˜ˆìƒì˜ì—­ (ìš´ì˜ í•­ëª© ë° ê²°ê³¼í‘œ)</summary>
  <div class="collapsible-content">

<hr style="margin:30px 0; border:none; border-top:2px solid #ddd;">

<h3>[6] ê¸€ë¨í•‘ ì£¼ìš” ë§¤ì¶œ</h3>

<input id="gWeight" type="hidden" value="0.37">


<h3>ìš´ì˜ í•­ëª© ì…ë ¥í‘œ</h3>
<table id="glampingTable" class="grid">
  <thead>
    <tr>
      <th></th>
      <th>í‰ì¼</th>
      <th>ì£¼ë§</th>
      <th>ê³µíœ´ì¼(ì—°íœ´)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>ê¸°ì¤€2ì¸</th>
      <td><input type="text" value="150,000"></td>
      <td><input type="text" value="220,000"></td>
      <td><input type="text" value="220,000"></td>
    </tr>
    <tr>
      <th>ì¶”ê°€ì¸ì›(+1)</th>
      <td><input type="text" value="180,000"></td>
      <td><input type="text" value="250,000"></td>
      <td><input type="text" value="250,000"></td>
    </tr>
    <tr>
      <th>ì¶”ê°€ì¸ì›(+2)</th>
      <td><input type="text" value="210,000"></td>
      <td><input type="text" value="280,000"></td>
      <td><input type="text" value="280,000"></td>
    </tr>
  </tbody>
</table>

<!-- ì˜ˆìƒ ê°€ë™ë¥  ì„¤ì • í‘œ -->
<h3>ê°€ë™ë¥  ì„¤ì •</h3>
<table id="occSettings" class="grid">
  <thead>
    <tr><th colspan="4">ê°€ë™ë¥  ì„¤ì •</th></tr>
    <tr>
      <th></th>
      <th>ê¸ì •ì•ˆ</th>
      <th>ì¤‘ë¦½ì•ˆ</th>
      <th>ë¶€ì •ì•ˆ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>ì„±ìˆ˜ê¸°</th>
      <td><input type="number" id="occ_pos_high" value="90" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neu_high" value="80" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neg_high" value="70" step="0.1" min="0" max="100">%</td>
    </tr>
    <tr>
      <th>ì£¼ë§</th>
      <td><input type="number" id="occ_pos_weekend" value="90" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neu_weekend" value="50" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neg_weekend" value="45" step="0.1" min="0" max="100">%</td>
    </tr>
    <tr>
      <th>í‰ì¼</th>
      <td><input type="number" id="occ_pos_weekday" value="30" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neu_weekday" value="18" step="0.1" min="0" max="100">%</td>
      <td><input type="number" id="occ_neg_weekday" value="15" step="0.1" min="0" max="100">%</td>
    </tr>
  </tbody>
</table>

<h3>ì‹œë‚˜ë¦¬ì˜¤ë³„ ì „ê°œí‘œ</h3>
<div class="note" style="background:#e8f4f8; padding:10px; border-radius:6px; border-left:4px solid #3498db">
  <strong>ğŸ’¡ ê°€ì¤‘ì¹˜ ì„¤ì •:</strong> ì•„ë˜ ì‹œë‚˜ë¦¬ì˜¤ë³„ ì „ê°œí‘œì˜ ë‘ ë²ˆì§¸ í–‰(ê°€ì¤‘ì¹˜ ì¹¸)ì—ì„œ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤. ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ì— ë™ì¼í•˜ê²Œ ì ìš©ë©ë‹ˆë‹¤.
</div>
<div class="scenario">
  <label><input type="radio" name="scenario" value="positive" checked="checked"><span>ê¸ì •ì•ˆ</span></label>
  <label><input type="radio" name="scenario" value="neutral"><span>ì¤‘ë¦½ì•ˆ</span></label>
  <label><input type="radio" name="scenario" value="negative"><span>ë¶€ì •ì•ˆ</span></label>
</div>

<!-- ì´ë¯¸ì§€ ê¸°ë°˜ (3 ì‹œë‚˜ë¦¬ì˜¤): ê¸ì •/ì¤‘ë¦½/ë¶€ì • í‘œ -->
<div id="scenario_positive" class="scenarioTable" style="display: none;">
  <div><strong>ê¸ì •ì•ˆ</strong></div>
  <table class="large" id="scenario_positive_table">
    <caption><strong>ê¸€ë¨í•‘ ìˆ˜ìµ ì „ê°œí‘œ (ê¸ì •ì•ˆ - ì´ë¯¸ì§€ ê¸°ë°˜)</strong></caption>
    <thead>
      <tr>
        <th colspan="2">êµ¬ë¶„</th>
        <th rowspan="2">ì„ëŒ€ë£Œ(ì›)</th>
        <th rowspan="2">ì¼ìˆ˜</th>
        <th rowspan="2">ì—°ê°„ ì„ëŒ€ìˆ˜</th>
        <th rowspan="2">ì˜ˆìƒ ê°€ë™ìœ¨</th>
        <th rowspan="2">ì˜ˆìƒìˆ˜ì…(ì›)</th>
        <th colspan="2">ì¶”ê°€ì¸ì›</th>
        <th>ê°€ì¤‘ì¹˜</th>
        <th rowspan="2">ë¹„ê³ </th>
      </tr>
      <tr>
        <th>ì‹œì„¤ë³„</th>
        <th>ì‹œê¸°ë³„</th>
        <th>ì¶”ê°€ì¸ì›(1)</th>
        <th>ì¶”ê°€ì¸ì›(2)</th>
        <th class="weightHeader"><input type="number" step="0.01" min="0" value="0.37" style="width:60px;text-align:center;padding:4px;border:1px solid #3498db;border-radius:3px;font-weight:bold" onchange="updateWeightFromHeader(this.value)"></th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="2">ì´ê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr style="background:#f0f0f0"><td>ê¸€ë¨í•‘</td><td>ì†Œê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>

      <tr><td>(10)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>90%</td><td>122,760</td><td>16,740</td><td>33,480</td><td>18,581</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>90%</td><td>174,240</td><td>23,760</td><td>47,520</td><td>26,374</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>30%</td><td>96,750</td><td>19,350</td><td>38,700</td><td>21,479</td><td></td></tr>

      <tr><td>(15)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>90%</td><td>184,140</td><td>25,110</td><td>50,220</td><td>27,872</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>90%</td><td>261,360</td><td>35,640</td><td>71,280</td><td>39,560</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>30%</td><td>145,125</td><td>29,025</td><td>58,050</td><td>32,218</td><td></td></tr>

      <tr><td>(30)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>90%</td><td>368,280</td><td>50,220</td><td>100,440</td><td>55,744</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>90%</td><td>522,720</td><td>71,280</td><td>142,560</td><td>79,121</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>30%</td><td>290,250</td><td>58,050</td><td>116,100</td><td>64,436</td><td></td></tr>

      <tr style="background:#f0f0f0"><td>ì¹´ë¼ë°˜</td><td>ì†Œê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>

      <tr><td>(5)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>90%</td><td>61,380</td><td>8,370</td><td>16,740</td><td>9,291</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>90%</td><td>87,120</td><td>11,880</td><td>23,760</td><td>13,187</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>30%</td><td>48,375</td><td>9,675</td><td>19,350</td><td>10,739</td><td></td></tr>

      <tr><td colspan="11" style="background:#fff"><strong>í•©ê³„ / ë¹„ê³ </strong></td></tr>
    </tbody>
  </table>
</div>

<div id="scenario_neutral" class="scenarioTable" style="display: none;">
  <div><strong>ì¤‘ë¦½ì•ˆ</strong></div>
  <table class="large" id="scenario_neutral_table">
    <caption><strong>ê¸€ë¨í•‘ ìˆ˜ìµ ì „ê°œí‘œ (ê¸ì •ì•ˆ - ì´ë¯¸ì§€ ê¸°ë°˜)</strong></caption>
    <thead>
      <tr>
        <th colspan="2">êµ¬ë¶„</th>
        <th rowspan="2">ì„ëŒ€ë£Œ(ì›)</th>
        <th rowspan="2">ì¼ìˆ˜</th>
        <th rowspan="2">ì—°ê°„ ì„ëŒ€ìˆ˜</th>
        <th rowspan="2">ì˜ˆìƒ ê°€ë™ìœ¨</th>
        <th rowspan="2">ì˜ˆìƒìˆ˜ì…(ì›)</th>
        <th colspan="2">ì¶”ê°€ì¸ì›</th>
        <th>ê°€ì¤‘ì¹˜</th>
        <th rowspan="2">ë¹„ê³ </th>
      </tr>
      <tr>
        <th>ì‹œì„¤ë³„</th>
        <th>ì‹œê¸°ë³„</th>
        <th>ì¶”ê°€ì¸ì›(1)</th>
        <th>ì¶”ê°€ì¸ì›(2)</th>
        <th class="weightHeader"><input type="number" step="0.01" min="0" value="0.37" style="width:60px;text-align:center;padding:4px;border:1px solid #3498db;border-radius:3px;font-weight:bold" onchange="updateWeightFromHeader(this.value)"></th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="2">ì´ê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr style="background:#f0f0f0"><td>ê¸€ë¨í•‘</td><td>ì†Œê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>

      <tr><td>(10)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>109,120</td><td>14,880</td><td>29,760</td><td>16,517</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>96,800</td><td>13,200</td><td>26,400</td><td>14,652</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>18%</td><td>58,050</td><td>11,610</td><td>23,220</td><td>12,887</td><td></td></tr>

      <tr><td>(15)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>163,680</td><td>22,320</td><td>44,640</td><td>24,775</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>145,200</td><td>19,800</td><td>39,600</td><td>21,978</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>18%</td><td>87,075</td><td>17,415</td><td>34,830</td><td>19,331</td><td></td></tr>

      <tr><td>(30)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>327,360</td><td>44,640</td><td>89,280</td><td>49,550</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>290,400</td><td>39,600</td><td>79,200</td><td>43,956</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>18%</td><td>174,150</td><td>34,830</td><td>69,660</td><td>38,661</td><td></td></tr>

      <tr style="background:#f0f0f0"><td>ì¹´ë¼ë°˜</td><td>ì†Œê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>

      <tr><td>(5)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>80%</td><td>54,560</td><td>7,440</td><td>14,880</td><td>8,258</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>50%</td><td>48,400</td><td>6,600</td><td>13,200</td><td>7,326</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>18%</td><td>29,025</td><td>5,805</td><td>11,610</td><td>6,444</td><td></td></tr>

      <tr><td colspan="11" style="background:#fff"><strong>í•©ê³„ / ë¹„ê³ </strong></td></tr>
    </tbody>
  </table>
</div>

<div id="scenario_negative" class="scenarioTable" style="">
  <div><strong>ë¶€ì •ì•ˆ</strong></div>
  <table class="large" id="scenario_negative_table">
    <caption><strong>ê¸€ë¨í•‘ ìˆ˜ìµ ì „ê°œí‘œ (ê¸ì •ì•ˆ - ì´ë¯¸ì§€ ê¸°ë°˜)</strong></caption>
    <thead>
      <tr>
        <th colspan="2">êµ¬ë¶„</th>
        <th rowspan="2">ì„ëŒ€ë£Œ(ì›)</th>
        <th rowspan="2">ì¼ìˆ˜</th>
        <th rowspan="2">ì—°ê°„ ì„ëŒ€ìˆ˜</th>
        <th rowspan="2">ì˜ˆìƒ ê°€ë™ìœ¨</th>
        <th rowspan="2">ì˜ˆìƒìˆ˜ì…(ì›)</th>
        <th colspan="2">ì¶”ê°€ì¸ì›</th>
        <th>ê°€ì¤‘ì¹˜</th>
        <th rowspan="2">ë¹„ê³ </th>
      </tr>
      <tr>
        <th>ì‹œì„¤ë³„</th>
        <th>ì‹œê¸°ë³„</th>
        <th>ì¶”ê°€ì¸ì›(1)</th>
        <th>ì¶”ê°€ì¸ì›(2)</th>
        <th class="weightHeader"><input type="number" step="0.01" min="0" value="0.37" style="width:60px;text-align:center;padding:4px;border:1px solid #3498db;border-radius:3px;font-weight:bold" onchange="updateWeightFromHeader(this.value)"></th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="2">ì´ê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
      <tr style="background:#f0f0f0"><td>ê¸€ë¨í•‘</td><td>ì†Œê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>

      <tr><td>(10)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>70%</td><td>95,480</td><td>13,020</td><td>26,040</td><td>14,452</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>45%</td><td>87,120</td><td>11,880</td><td>23,760</td><td>13,187</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>15%</td><td>48,375</td><td>9,675</td><td>19,350</td><td>10,739</td><td></td></tr>

      <tr><td>(15)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>70%</td><td>143,220</td><td>19,530</td><td>39,060</td><td>21,678</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>45%</td><td>130,680</td><td>17,820</td><td>35,640</td><td>19,780</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>15%</td><td>72,563</td><td>14,513</td><td>29,025</td><td>16,109</td><td></td></tr>

      <tr><td>(30)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>70%</td><td>286,440</td><td>39,060</td><td>78,120</td><td>43,357</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>45%</td><td>261,360</td><td>35,640</td><td>71,280</td><td>39,560</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>15%</td><td>145,125</td><td>29,025</td><td>58,050</td><td>32,218</td><td></td></tr>

      <tr style="background:#f0f0f0"><td>ì¹´ë¼ë°˜</td><td>ì†Œê³„</td><td></td><td>365</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>

      <tr><td>(5)</td><td>ì„±ìˆ˜ê¸°</td><td>220</td><td>62</td><td></td><td>70%</td><td>47,740</td><td>6,510</td><td>13,020</td><td>7,226</td><td></td></tr>
      <tr><td></td><td>ì£¼ë§</td><td>220</td><td>88</td><td></td><td>45%</td><td>43,560</td><td>5,940</td><td>11,880</td><td>6,593</td><td></td></tr>
      <tr><td></td><td>í‰ì¼</td><td>150</td><td>215</td><td></td><td>15%</td><td>24,188</td><td>4,838</td><td>9,675</td><td>5,370</td><td></td></tr>

      <tr><td colspan="11" style="background:#fff"><strong>í•©ê³„ / ë¹„ê³ </strong></td></tr>
    </tbody>
  </table>
</div>

<!-- Scenario summary: per-scenario compact tables -->
<div id="scenarioSummaries" style="margin-top:16px; display:flex; gap:12px; flex-wrap:wrap">
  <div style="flex:1; min-width:300px">
    <h4>ê¸ì •ì•ˆ ìš”ì•½</h4>
    <table class="grid" id="summary_positive" style="font-size:12px">
      <thead><tr><th>ëŒ€ìˆ˜</th><th>ê¸€ë¨í•‘ ë‹¨ë…</th><th>+ê°€ì¤‘ì¹˜</th><th>+ì¹´ë¼ë°˜5ëŒ€</th><th>+ì¹´ë¼ë°˜+ê°€ì¤‘ì¹˜</th></tr></thead>
      <tbody>
        <tr><td>10ëŒ€</td><td class="sp_10">393,750</td><td class="sp_10_w">460,184</td><td class="sp_10_p">590,625</td><td class="sp_10_pw">690,276</td></tr>
        <tr><td>15ëŒ€</td><td class="sp_15">590,625</td><td class="sp_15_w">690,275</td><td class="sp_15_p">787,500</td><td class="sp_15_pw">920,367</td></tr>
        <tr><td>30ëŒ€</td><td class="sp_30">1,181,250</td><td class="sp_30_w">1,380,551</td><td class="sp_30_p">1,378,125</td><td class="sp_30_pw">1,610,643</td></tr>
      </tbody>
    </table>
  </div>
  <div style="flex:1; min-width:300px">
    <h4>ì¤‘ë¦½ì•ˆ ìš”ì•½</h4>
    <table class="grid" id="summary_neutral" style="font-size:12px">
      <thead><tr><th>ëŒ€ìˆ˜</th><th>ê¸€ë¨í•‘ ë‹¨ë…</th><th>+ê°€ì¤‘ì¹˜</th><th>+ì¹´ë¼ë°˜5ëŒ€</th><th>+ì¹´ë¼ë°˜+ê°€ì¤‘ì¹˜</th></tr></thead>
      <tbody>
        <tr><td>10ëŒ€</td><td class="sn_10">263,970</td><td class="sn_10_w">308,026</td><td class="sn_10_p">395,955</td><td class="sn_10_pw">462,039</td></tr>
        <tr><td>15ëŒ€</td><td class="sn_15">395,955</td><td class="sn_15_w">462,039</td><td class="sn_15_p">527,940</td><td class="sn_15_pw">616,052</td></tr>
        <tr><td>30ëŒ€</td><td class="sn_30">791,910</td><td class="sn_30_w">924,077</td><td class="sn_30_p">923,895</td><td class="sn_30_pw">1,078,090</td></tr>
      </tbody>
    </table>
  </div>
  <div style="flex:1; min-width:300px">
    <h4>ë¶€ì •ì•ˆ ìš”ì•½</h4>
    <table class="grid" id="summary_negative" style="font-size:12px">
      <thead><tr><th>ëŒ€ìˆ˜</th><th>ê¸€ë¨í•‘ ë‹¨ë…</th><th>+ê°€ì¤‘ì¹˜</th><th>+ì¹´ë¼ë°˜5ëŒ€</th><th>+ì¹´ë¼ë°˜+ê°€ì¤‘ì¹˜</th></tr></thead>
      <tbody>
        <tr><td>10ëŒ€</td><td class="sg_10">230,975</td><td class="sg_10_w">269,353</td><td class="sg_10_p">346,463</td><td class="sg_10_pw">404,030</td></tr>
        <tr><td>15ëŒ€</td><td class="sg_15">346,463</td><td class="sg_15_w">404,030</td><td class="sg_15_p">461,951</td><td class="sg_15_pw">538,707</td></tr>
        <tr><td>30ëŒ€</td><td class="sg_30">692,925</td><td class="sg_30_w">808,060</td><td class="sg_30_p">808,413</td><td class="sg_30_pw">942,737</td></tr>
      </tbody>
    </table>
  </div>
</div>

<button id="glampingAnalyze">ê¸€ë¨í•‘ ë¶„ì„ ì‹¤í–‰</button>
<div id="glampingSummary" class="note">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

<h3 style="margin-top:30px">ê¸€ë¨í•‘ ëŒ€ìˆ˜ë³„ í•©ì‚°ê¸ˆì•¡ ë¶„ì„</h3>
<div style="margin:10px 0; padding:10px; background:#f9f9f9; border-radius:6px">
  <label style="display:inline-flex; align-items:center; cursor:pointer; font-size:14px">
    <input type="checkbox" id="includeCaravanChart" style="width:18px; height:18px; margin-right:8px">
    <span>ì¹´ë¼ë°˜ 5ëŒ€ í¬í•¨</span>
  </label>
  <span style="margin-left:20px; color:#666; font-size:13px">* ê°€ì¤‘ì¹˜ëŠ” ëª¨ë‘ í¬í•¨ëœ ê¸ˆì•¡ì…ë‹ˆë‹¤</span>
</div>
<canvas id="glampingUnitsChart" style="max-height: 400px; box-sizing: border-box; display: block; height: 400px; width: 1796px;" width="1796" height="400"></canvas>

  </div>
</details>

<details class="collapsible-section">
  <summary>ğŸ’µ ì¶”ê°€ë§¤ì¶œ</summary>
  <div class="collapsible-content">
    
    <h3>[7] ì¶”ê°€ë§¤ì¶œ</h3>
    <table class="financial-table" id="additionalRevenueTable">
      <thead>
        <tr>
          <th class="item-name">í•­ëª©</th>
          <th class="item-value">ì›”ë³„ ê¸ˆì•¡ (ë§Œì›/ì›”)</th>
          <th class="item-value">ì—°ê°„ ê¸ˆì•¡ (ë§Œì›/ë…„)</th>
          <th class="item-actions">ì‘ì—…</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="text" value="ë§¤ì ìˆ˜ì…"></td>
          <td><input type="text" value="200" oninput="calculateAdditionalRevenue(this)"></td>
          <td><input type="text" value="2,400" readonly style="background-color: #f0f0f0; font-weight: 700; color: #2e7d32;"></td>
          <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
        </tr>
        <tr>
          <td><input type="text" value="ìíŒê¸°ìˆ˜ì…"></td>
          <td><input type="text" value="10" oninput="calculateAdditionalRevenue(this)"></td>
          <td><input type="text" value="120" readonly style="background-color: #f0f0f0; font-weight: 700; color: #2e7d32;"></td>
          <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
        </tr>
      </tbody>
    </table>
    <button class="btn-small btn-add" onclick="addAdditionalRevenueRow()">+ í•­ëª© ì¶”ê°€</button>
    
    <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; border: 2px solid #4caf50;">
      <div style="font-size: 16px; font-weight: 700; color: #1b5e20; text-align: right;">
        ì´ ì¶”ê°€ë§¤ì¶œ: <span id="additionalRevenueSum">2,520</span> ë§Œì›/ë…„ 
        (<span id="additionalRevenueSumBillion">0.25</span> ì–µì›/ë…„)
      </div>
    </div>
  </div>
</details>

</section>

<!-- ë²¤ì²˜ -->
<section id="venture" class="panel">
<h2>í•´ìš´Â·ë¬¼ë¥˜ ì‹ ê·œ ë²¤ì²˜ íˆ¬ì</h2>
<ul>
  <li>ì „ëµì  ì‹œë„ˆì§€ í™•ë³´ ëª©ì </li>
  <li>ì†Œì•¡ ì§€ë¶„ íˆ¬ì ê²€í† </li>
  <li>ê°„ë‹¨í•œ IRR ì‹œë‚˜ë¦¬ì˜¤ ì…ë ¥</li>
</ul>

<label>ì´ˆê¸° íˆ¬ìë¹„ (ì–µì›)</label>
<input id="vInvest" type="number" value="10">

<label>ì—°ê°„ ì˜ˆìƒ EBITDA (ì–µì›)</label>
<input id="vEbitda" type="number" value="1.2">

<label>ë¶„ì„ ê¸°ê°„ (ì—°)</label>
<input id="vYears" type="number" value="10">

<button id="ventureAnalyze">ë²¤ì²˜ ë¶„ì„ ì‹¤í–‰</button>
<div id="ventureSummary" class="note">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</section>

<!-- í†µí•© -->
<section id="total" class="panel">
<h2>í†µí•© ìˆ˜ìµ ë¶„ì„</h2>

<button id="consolidateBtn">í†µí•© ë¶„ì„ ì‹¤í–‰</button>
<button id="downloadPdf">PDF ë‹¤ìš´ë¡œë“œ</button>

<div id="aggregatedSummary" class="note">í†µí•© ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

<h3>ë‹¨ë… vs í†µí•© EBITDA</h3>
<canvas id="compareChart"></canvas>

<h3>ë³´ì¡°ê¸ˆ OFF vs ON IRR ë¹„êµ (í†µí•©)</h3>
<canvas id="subsidyChart"></canvas>
</section>

<script>
/* íƒ­ */
document.querySelectorAll(".tabs button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
    // ê¸€ë¨í•‘ íƒ­ì„ í™œì„±í™”í•  ë•Œ 11x17 í…Œì´ë¸”ì„ ë‹¤ì‹œ ìƒì„±í•˜ì—¬ í‘œì‹œ ë³´ì¥
    if(btn.dataset.tab === 'glamping') createScenarioTableSingle();
  }
});

/* DOM references */
const fare = document.getElementById('fare');
const fareSlider = document.getElementById('fareSlider');
const fareRate = document.getElementById('fareRate');
const days = document.getElementById('days');
const passengers = document.getElementById('passengers');
const shipPrice = document.getElementById('shipPrice');
const subsidy = document.getElementById('subsidy');
const subsidyToggle = document.getElementById('subsidyToggle');
const opex = document.getElementById('opex');

const gInvest = document.getElementById('gInvest');
const rooms = document.getElementById('rooms');
const occ = document.getElementById('occ');
const adr = document.getElementById('adr');
const gOpex = document.getElementById('gOpex');

const vInvest = document.getElementById('vInvest');
const vEbitda = document.getElementById('vEbitda');
const vYears = document.getElementById('vYears');

const ferryAnalyze = document.getElementById('ferryAnalyze');
const glampingAnalyze = document.getElementById('glampingAnalyze');
const ventureAnalyze = document.getElementById('ventureAnalyze');
const consolidateBtn = document.getElementById('consolidateBtn');
const downloadPdf = document.getElementById('downloadPdf');

const kRevenue = document.getElementById('kRevenue');
const kEbitda = document.getElementById('kEbitda');
const kIrr = document.getElementById('kIrr');

const compareChartEl = document.getElementById('compareChart');
const subsidyChartEl = document.getElementById('subsidyChart');
const glampingUnitsChartEl = document.getElementById('glampingUnitsChart');

const ferrySummary = document.getElementById('ferrySummary');
const glampingSummary = document.getElementById('glampingSummary');
const ventureSummary = document.getElementById('ventureSummary');
const aggregatedSummary = document.getElementById('aggregatedSummary');

const includeCaravanChart = document.getElementById('includeCaravanChart');

let compareChart, subsidyChart, glampingUnitsChart;
let projects = {ferry:null, glamping:null, venture:null};

/* Financial tables management */
function addFinancialRow(tableId) {
  const table = document.getElementById(tableId);
  if(!table) return;
  const tbody = table.querySelector('tbody');
  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td><input type="text" placeholder="í•­ëª©ëª… ì…ë ¥"></td>
    <td><input type="text" value="0"></td>
    <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
  `;
  
  // CAPEX í…Œì´ë¸”ì˜ ê²½ìš° í† ì§€ë¹„ìš© í–‰(ì²˜ìŒ 2ê°œ) ë‹¤ìŒì— ì¶”ê°€
  if(tableId === 'capexTable') {
    const landCostRow = tbody.querySelector('.land-cost-row');
    if(landCostRow && landCostRow.nextSibling) {
      tbody.insertBefore(newRow, landCostRow.nextSibling);
    } else {
      tbody.appendChild(newRow);
    }
  } else if(tableId === 'fixedCostTable') {
    // ê³ ì •ë¹„ í…Œì´ë¸”ì˜ ê²½ìš° ê°ê°€ìƒê°ë¹„ í–‰(ì²˜ìŒ 2ê°œ) ë‹¤ìŒì— ì¶”ê°€
    const depreciationRow = tbody.querySelector('.depreciation-row');
    if(depreciationRow && depreciationRow.nextSibling) {
      tbody.insertBefore(newRow, depreciationRow.nextSibling);
    } else {
      tbody.appendChild(newRow);
    }
  } else if(tableId === 'financeTable') {
    // ê¸ˆìœµ ë° ì„¸ê¸ˆ í…Œì´ë¸”ì˜ ê²½ìš° ì°¨ì…ê¸ˆ ì´ì í–‰(ì²˜ìŒ 2ê°œ) ë‹¤ìŒì— ì¶”ê°€
    const loanInterestRow = tbody.querySelector('.loan-interest-row');
    if(loanInterestRow && loanInterestRow.nextSibling) {
      tbody.insertBefore(newRow, loanInterestRow.nextSibling);
    } else {
      tbody.appendChild(newRow);
    }
  } else {
    tbody.appendChild(newRow);
  }
  
  bindFinancialInputs();
  updateFinancialSummaries();
}

function deleteFinancialRow(btn) {
  const row = btn.closest('tr');
  
  // í† ì§€ë¹„ìš© ê´€ë ¨ í–‰ì€ ì‚­ì œ ë¶ˆê°€
  if(row.classList.contains('land-calc-header') || row.classList.contains('land-cost-row')) {
    showToast('í† ì§€ë¹„ìš© í•­ëª©ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  
  // ê°ê°€ìƒê°ë¹„ ê´€ë ¨ í–‰ì€ ì‚­ì œ ë¶ˆê°€
  if(row.classList.contains('depreciation-header') || row.classList.contains('depreciation-row')) {
    showToast('ê°ê°€ìƒê°ë¹„ í•­ëª©ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  
  // ì°¨ì…ê¸ˆ ì´ì ê´€ë ¨ í–‰ì€ ì‚­ì œ ë¶ˆê°€
  if(row.classList.contains('loan-interest-header') || row.classList.contains('loan-interest-row')) {
    showToast('ì°¨ì…ê¸ˆ ì´ì í•­ëª©ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  
  const table = row.closest('table');
  const tbody = table.querySelector('tbody');
  
  // CAPEX í…Œì´ë¸”ì˜ ê²½ìš° í† ì§€ë¹„ìš© 2ê°œ í–‰ì„ ì œì™¸í•˜ê³  ìµœì†Œ 1ê°œ ì´ìƒ í•„ìš”
  const isCapexTable = table.id === 'capexTable';
  const isFixedCostTable = table.id === 'fixedCostTable';
  const isFinanceTable = table.id === 'financeTable';
  let minRows = 1;
  
  if(isCapexTable) {
    minRows = 3; // CAPEXëŠ” í† ì§€ë¹„ìš© 2í–‰ + ìµœì†Œ 1í–‰
  } else if(isFixedCostTable) {
    minRows = 3; // ê³ ì •ë¹„ëŠ” ê°ê°€ìƒê°ë¹„ 2í–‰ + ìµœì†Œ 1í–‰
  } else if(isFinanceTable) {
    minRows = 4; // ê¸ˆìœµ ë° ì„¸ê¸ˆì€ ì°¨ì…ê¸ˆ ì´ì 2í–‰ + ë¶€ê°€ì„¸ + ë²•ì¸ì„¸ìœ¨ ìµœì†Œ
  }
  
  if(tbody.children.length > minRows) {
    row.remove();
    updateFinancialSummaries();
  } else {
    showToast('ìµœì†Œ 1ê°œ ì´ìƒì˜ í•­ëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
  }
}

function getTableSum(tableId) {
  const table = document.getElementById(tableId);
  if(!table) return 0;
  // ì§ì ‘ ìì‹ tbodyì˜ trë§Œ ì„ íƒ (ì¤‘ì²© í…Œì´ë¸” ì œì™¸)
  const rows = table.querySelector('tbody')?.children || [];
  let sum = 0;
  
  for (const row of rows) {
    // íŠ¹ìˆ˜ í—¤ë” í–‰(land-calc-header, depreciation-header, loan-interest-header)ì€ ì œì™¸
    if (row.classList.contains('land-calc-header') || row.classList.contains('depreciation-header') || row.classList.contains('loan-interest-header')) {
      continue;
    }
    
    const valueInput = row.querySelector('td:nth-child(2) input');
    if (valueInput) {
      const val = Number(removeCommas(valueInput.value)) || 0;
      sum += val;
    }
  }
  
  return sum;
}

function updateFinancialSummaries() {
  const tables = ['capex', 'preopening', 'fixedCost', 'variableCost'];
  tables.forEach(t => {
    const sum = getTableSum(t + 'Table');
    const sumEl = document.getElementById(t + 'Sum');
    const sumBillionEl = document.getElementById(t + 'SumBillion');
    if(sumEl) sumEl.textContent = formatNumberWithCommas(sum.toFixed(0));
    if(sumBillionEl) sumBillionEl.textContent = formatNumberWithCommas((sum / 10000).toFixed(2));
  });
  
  // Update gInvest field with total CAPEX + Pre-opening
  const totalCapex = getTableSum('capexTable');
  const totalPreopening = getTableSum('preopeningTable');
  const totalInitial = (totalCapex + totalPreopening) / 10000; // Convert to ì–µì›
  const gInvestEl = document.getElementById('gInvest');
  if(gInvestEl) {
    gInvestEl.value = totalInitial.toFixed(2);
  }
  
  // Update gOpex field with total fixed + variable costs
  const totalFixed = getTableSum('fixedCostTable');
  const totalVariable = getTableSum('variableCostTable');
  const totalOpex = (totalFixed + totalVariable) / 10000; // Convert to ì–µì›
  const gOpexEl = document.getElementById('gOpex');
  if(gOpexEl) {
    gOpexEl.value = totalOpex.toFixed(2);
  }
  
  // Update KPI indicators
  updateKPIIndicators();
}

function updateKPIIndicators() {
  // ì´ ì´ˆê¸° íˆ¬ìë¹„ (CAPEX + Pre-opening)
  const totalCapex = getTableSum('capexTable');
  const totalPreopening = getTableSum('preopeningTable');
  const totalInvest = (totalCapex + totalPreopening) / 10000; // ì–µì›
  
  // ì—°ê°„ ìš´ì˜ë¹„ (Fixed + Variable)
  const totalFixed = getTableSum('fixedCostTable');
  const totalVariable = getTableSum('variableCostTable');
  const opex = (totalFixed + totalVariable) / 10000; // ì–µì›
  
  // ì—°ê°„ ë§¤ì¶œ (KPI ì„¹ì…˜ì—ì„œ ì„ íƒëœ ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜)
  const selectedScenario = document.querySelector('input[name="kpi_scenario"]:checked')?.value || 'neutral';
  const revenueGross = getSelectedScenarioRevenue(selectedScenario); // ì–µì› (ë¶€ê°€ì„¸ í¬í•¨)
  
  // ë¶€ê°€ì„¸ìœ¨ ê°€ì ¸ì˜¤ê¸°
  const vatRate = getVATRate() / 100;
  
  // ë¶€ê°€ì„¸ ì œì™¸ ë§¤ì¶œ = ë¶€ê°€ì„¸ í¬í•¨ ë§¤ì¶œ / (1 + ë¶€ê°€ì„¸ìœ¨)
  const revenue = revenueGross / (1 + vatRate);
  
  // ì¶”ê°€ë§¤ì¶œ ê°€ì ¸ì˜¤ê¸°
  const additionalRevenue = getAdditionalRevenue(); // ì–µì›
  
  // ë§ˆì¼€íŒ…ë¹„ ê°€ì ¸ì˜¤ê¸° (ë³€ë™ë¹„ì—ì„œ ì¶”ì¶œ)
  const marketingCost = getMarketingCost(); // ì–µì›
  
  // EBITDA = ë§¤ì¶œ(ë¶€ê°€ì„¸ ì œì™¸) + ì¶”ê°€ë§¤ì¶œ - ìš´ì˜ë¹„ - ë§ˆì¼€íŒ…ë¹„
  const ebitda = revenue + additionalRevenue - opex - marketingCost;
  
  // ê°ê°€ìƒê°ë¹„ (ê³ ì •ë¹„ í…Œì´ë¸”ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
  const depreciation = getDepreciation(); // ì–µì›
  
  // ì˜ì—…ì´ìµ = EBITDA - ê°ê°€ìƒê°
  const operatingProfit = ebitda - depreciation;
  
  // ì°¨ì…ê¸ˆ ì´ì (ê¸ˆìœµ ë° ì„¸ê¸ˆ í…Œì´ë¸”ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
  const loanInterest = getLoanInterest(); // ì–µì›
  
  // ì„¸ì „ì´ìµ = ì˜ì—…ì´ìµ - ì´ìë¹„ìš©
  const profitBeforeTax = operatingProfit - loanInterest;
  
  // ì„¸ìœ¨ (finance í…Œì´ë¸”ì—ì„œ ê°€ì ¸ì˜¤ê¸°, ì—†ìœ¼ë©´ 22% ê¸°ë³¸ê°’)
  const taxRate = getTaxRate() / 100;
  
  // ì„¸í›„ì´ìµ = ì„¸ì „ì´ìµ * (1 - ì„¸ìœ¨)
  const netProfit = profitBeforeTax * (1 - taxRate);
  
  // ì—°ê°„ ìˆœí˜„ê¸ˆíë¦„ = ì„¸í›„ì´ìµ + ê°ê°€ìƒê°
  const cashFlow = netProfit + depreciation;
  
  // íˆ¬ìíšŒìˆ˜ê¸°ê°„ = ì´ íˆ¬ì / ì—°ê°„ ìˆœí˜„ê¸ˆíë¦„
  const payback = cashFlow > 0 ? totalInvest / cashFlow : 999;
  
  // IRR ê³„ì‚° (ê°„ë‹¨í•œ ê·¼ì‚¬ì¹˜)
  const irr = calculateSimpleIRR(totalInvest, cashFlow, 5);
  
  // Update UI
  document.getElementById('kpi_totalInvest').textContent = formatNumberWithCommas(totalInvest.toFixed(1));
  document.getElementById('kpi_opex').textContent = formatNumberWithCommas(opex.toFixed(1));
  document.getElementById('kpi_ebitda').textContent = formatNumberWithCommas(ebitda.toFixed(1));
  document.getElementById('kpi_operatingProfit').textContent = formatNumberWithCommas(operatingProfit.toFixed(1));
  document.getElementById('kpi_netProfit').textContent = formatNumberWithCommas(netProfit.toFixed(1));
  document.getElementById('kpi_cashFlow').textContent = formatNumberWithCommas(cashFlow.toFixed(1));
  document.getElementById('kpi_payback').textContent = payback < 999 ? payback.toFixed(1) : 'N/A';
  document.getElementById('kpi_irr').textContent = irr.toFixed(1);
  
  // Update tooltips with actual values
  updateKPITooltip('kpi-card-1', `ì´ˆê¸° íˆ¬ìë¹„(CAPEX) í•©ê³„\n= ${formatNumberWithCommas((totalCapex/10000).toFixed(1))}ì–µ + ${formatNumberWithCommas((totalPreopening/10000).toFixed(1))}ì–µ\n= ${formatNumberWithCommas(totalInvest.toFixed(1))}ì–µì›`);
  
  updateKPITooltip('kpi-card-2', `ê³ ì • ìš´ì˜ë¹„ + ë³€ë™ ìš´ì˜ë¹„\n= ${formatNumberWithCommas((totalFixed/10000).toFixed(1))}ì–µ + ${formatNumberWithCommas((totalVariable/10000).toFixed(1))}ì–µ\n= ${formatNumberWithCommas(opex.toFixed(1))}ì–µì›/ë…„`);
  
  updateKPITooltip('kpi-card-3', `ë§¤ì¶œì•¡(ë¶€ê°€ì„¸ ì œì™¸) + ì¶”ê°€ë§¤ì¶œ - ìš´ì˜ë¹„ - ë§ˆì¼€íŒ…ë¹„\në¶€ê°€ì„¸ í¬í•¨: ${formatNumberWithCommas(revenueGross.toFixed(1))}ì–µ\në¶€ê°€ì„¸ ì œì™¸: ${formatNumberWithCommas(revenue.toFixed(1))}ì–µ\nì¶”ê°€ë§¤ì¶œ: ${formatNumberWithCommas(additionalRevenue.toFixed(1))}ì–µ\n= ${formatNumberWithCommas(revenue.toFixed(1))}ì–µ + ${formatNumberWithCommas(additionalRevenue.toFixed(1))}ì–µ - ${formatNumberWithCommas(opex.toFixed(1))}ì–µ - ${formatNumberWithCommas(marketingCost.toFixed(1))}ì–µ\n= ${formatNumberWithCommas(ebitda.toFixed(1))}ì–µì›/ë…„`);
  
  updateKPITooltip('kpi-card-4', `EBITDA - ê°ê°€ìƒê°ë¹„\n= ${formatNumberWithCommas(ebitda.toFixed(1))}ì–µ - ${formatNumberWithCommas(depreciation.toFixed(1))}ì–µ\n= ${formatNumberWithCommas(operatingProfit.toFixed(1))}ì–µì›/ë…„`);
  
  updateKPITooltip('kpi-card-5', `ì„¸ì „ì´ìµ Ã— (1 - ë²•ì¸ì„¸ìœ¨)\nì„¸ì „ì´ìµ = ì˜ì—…ì´ìµ - ì´ìë¹„ìš©\n= ${formatNumberWithCommas(operatingProfit.toFixed(1))}ì–µ - ${formatNumberWithCommas(loanInterest.toFixed(1))}ì–µ = ${formatNumberWithCommas(profitBeforeTax.toFixed(1))}ì–µ\nì„¸í›„ì´ìµ = ${formatNumberWithCommas(profitBeforeTax.toFixed(1))}ì–µ Ã— (1 - ${(taxRate*100).toFixed(1)}%)\n= ${formatNumberWithCommas(netProfit.toFixed(1))}ì–µì›/ë…„`);
  
  updateKPITooltip('kpi-card-6', `ì„¸í›„ì´ìµ + ê°ê°€ìƒê°ë¹„\n= ${formatNumberWithCommas(netProfit.toFixed(1))}ì–µ + ${formatNumberWithCommas(depreciation.toFixed(1))}ì–µ\n= ${formatNumberWithCommas(cashFlow.toFixed(1))}ì–µì›/ë…„`);
  
  updateKPITooltip('kpi-card-7', `ì´ˆê¸° íˆ¬ìë¹„ Ã· ì—°ê°„ ìˆœí˜„ê¸ˆíë¦„\n= ${formatNumberWithCommas(totalInvest.toFixed(1))}ì–µ Ã· ${formatNumberWithCommas(cashFlow.toFixed(1))}ì–µ\n= ${payback < 999 ? payback.toFixed(1) : 'N/A'}ë…„`);
  
  updateKPITooltip('kpi-card-8', `NPV = 0ì´ ë˜ëŠ” í• ì¸ìœ¨\n(5ë…„ê°„ í˜„ê¸ˆíë¦„ ê¸°ì¤€)\níˆ¬ì: ${formatNumberWithCommas(totalInvest.toFixed(1))}ì–µ\nì—°ê°„ CF: ${formatNumberWithCommas(cashFlow.toFixed(1))}ì–µ\nIRR = ${irr.toFixed(1)}%`);
}

function updateKPITooltip(cardClass, content) {
  const card = document.querySelector(`.${cardClass}`);
  if (card) {
    const tooltip = card.querySelector('.kpi-tooltip');
    if (tooltip) {
      tooltip.textContent = content;
    }
  }
}

function toggleLandCalcDetails() {
  const details = document.getElementById('landCalcDetails');
  const icon = document.getElementById('landCalcToggleIcon');
  
  if (details.style.display === 'none') {
    details.style.display = '';
    icon.style.transform = 'rotate(0deg)';
    icon.textContent = 'â–¼';
  } else {
    details.style.display = 'none';
    icon.style.transform = 'rotate(-90deg)';
    icon.textContent = 'â–¶';
  }
}

window.toggleLandCalcDetails = toggleLandCalcDetails;

function calculateLandCost() {
  const landPrice = parseFloat(document.getElementById('landPrice').value) || 0;
  const landArea = parseFloat(document.getElementById('landArea').value) || 0;
  const landRatio = parseFloat(document.getElementById('landRatio').value) || 0;
  
  // í† ì§€ë¹„ìš© = ê³µì‹œì§€ê°€ Ã— ë©´ì  Ã— ì‹¤ê±°ë˜ë¹„ìœ¨ (ì› ë‹¨ìœ„)
  const landCostWon = landPrice * landArea * landRatio;
  // ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜
  const landCostManWon = landCostWon / 10000;
  
  // ê³„ì‚°ëœ í† ì§€ë¹„ìš© í‘œì‹œ (ì½¤ë§ˆ í¬ë§·)
  const calculatedLandCostEl = document.getElementById('calculatedLandCost');
  if (calculatedLandCostEl) {
    calculatedLandCostEl.value = formatNumberWithCommas(Math.round(landCostManWon));
  }
  
  // CAPEX í…Œì´ë¸”ì˜ í† ì§€ ë§¤ì…ë¹„ ì—…ë°ì´íŠ¸
  const landCostInput = document.getElementById('landCostInput');
  if (landCostInput) {
    landCostInput.value = formatNumberWithCommas(Math.round(landCostManWon));
  }
  
  // ì¬ë¬´ ìš”ì•½ ì—…ë°ì´íŠ¸
  updateFinancialSummaries();
}

window.calculateLandCost = calculateLandCost;

function toggleDepreciationDetails() {
  const details = document.getElementById('depreciationDetails');
  const icon = document.getElementById('depreciationToggleIcon');
  
  if (details.style.display === 'none') {
    details.style.display = '';
    icon.style.transform = 'rotate(0deg)';
    icon.textContent = 'â–¼';
  } else {
    details.style.display = 'none';
    icon.style.transform = 'rotate(-90deg)';
    icon.textContent = 'â–¶';
  }
}

window.toggleDepreciationDetails = toggleDepreciationDetails;

function calculateDepreciation() {
  const table = document.getElementById('depreciationAssetsTable');
  if (!table) return;
  
  const rows = table.querySelectorAll('tr');
  let totalDepreciation = 0;
  
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length < 5) return;
    
    const acquisitionCost = parseFloat(cells[1].querySelector('input').value) || 0;
    const usefulLife = parseFloat(cells[2].querySelector('input').value) || 1;
    const method = cells[3].querySelector('select').value;
    
    let annualDepreciation = 0;
    
    if (method === 'straight') {
      // ì •ì•¡ë²•: ì·¨ë“ê°€ì•¡ / ë‚´ìš©ì—°ìˆ˜
      // ì”ì¡´ê°€ì¹˜ 0ì›ìœ¼ë¡œ ê³„ì‚°
      annualDepreciation = acquisitionCost / usefulLife;
    } else if (method === 'declining') {
      // ì •ë¥ ë²•: ì·¨ë“ê°€ì•¡ Ã— ìƒê°ë¥ 
      // ìƒê°ë¥  ê·¼ì‚¬ì¹˜ = 1 - (ì”ì¡´ê°€ì¹˜ìœ¨ ^ (1/ë‚´ìš©ì—°ìˆ˜))
      // ì”ì¡´ê°€ì¹˜ìœ¨ 0.01%ë¡œ ê°€ì • (ì‹¤ì§ˆì ìœ¼ë¡œ 0ì›)
      const rate = 1 - Math.pow(0.0001, 1 / usefulLife);
      annualDepreciation = acquisitionCost * rate;
    }
    
    totalDepreciation += annualDepreciation;
    
    // ì—°ê°„ ìƒê°ë¹„ í‘œì‹œ
    const amountCell = row.querySelector('.depreciation-amount');
    if (amountCell) {
      amountCell.textContent = formatNumberWithCommas(Math.round(annualDepreciation));
    }
  });
  
  // ì´ ê°ê°€ìƒê°ë¹„ ì—…ë°ì´íŠ¸
  const totalEl = document.getElementById('totalDepreciation');
  if (totalEl) {
    totalEl.textContent = formatNumberWithCommas(Math.round(totalDepreciation));
  }
  
  // ê³ ì •ë¹„ í…Œì´ë¸”ì˜ ê°ê°€ìƒê°ë¹„ ì…ë ¥ë€ ì—…ë°ì´íŠ¸
  const depreciationInput = document.getElementById('depreciationInput');
  if (depreciationInput) {
    depreciationInput.value = formatNumberWithCommas(Math.round(totalDepreciation));
  }
  
  // ì¬ë¬´ ìš”ì•½ ì—…ë°ì´íŠ¸
  updateFinancialSummaries();
}

window.calculateDepreciation = calculateDepreciation;

function addDepreciationAsset() {
  const tbody = document.getElementById('depreciationAssetsTable');
  if (!tbody) return;
  
  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td style="padding: 6px; border: 1px solid #ddd;"><input type="text" placeholder="ìì‚°ëª… ì…ë ¥" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;"></td>
    <td style="padding: 6px; border: 1px solid #ddd;"><input type="number" value="0" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; text-align: right;" onchange="calculateDepreciation()"></td>
    <td style="padding: 6px; border: 1px solid #ddd;"><input type="number" value="5" style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; text-align: center;" onchange="calculateDepreciation()"></td>
    <td style="padding: 6px; border: 1px solid #ddd;">
      <select style="width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;" onchange="calculateDepreciation()">
        <option value="straight" selected>ì •ì•¡ë²•</option>
        <option value="declining">ì •ë¥ ë²•</option>
      </select>
    </td>
    <td style="padding: 6px; border: 1px solid #ddd; text-align: right; font-weight: 600; color: #ff6f00;" class="depreciation-amount">0</td>
    <td style="padding: 6px; border: 1px solid #ddd; text-align: center;"><button class="btn-small btn-delete" onclick="deleteDepreciationAsset(this)" style="font-size: 11px; padding: 3px 8px;">ì‚­ì œ</button></td>
  `;
  
  tbody.appendChild(newRow);
  calculateDepreciation();
}

window.addDepreciationAsset = addDepreciationAsset;

function deleteDepreciationAsset(btn) {
  const row = btn.closest('tr');
  const tbody = row.closest('tbody');
  
  if (tbody.children.length > 1) {
    row.remove();
    calculateDepreciation();
  } else {
    showToast('ìµœì†Œ 1ê°œ ì´ìƒì˜ ìì‚°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
  }
}

window.deleteDepreciationAsset = deleteDepreciationAsset;

// ì°¨ì…ê¸ˆ ì´ì í† ê¸€ í•¨ìˆ˜
function toggleLoanInterestDetails() {
  const details = document.getElementById('loanInterestDetails');
  const icon = document.getElementById('loanInterestToggleIcon');
  
  if (!details || !icon) return;
  
  if (details.style.display === 'none') {
    details.style.display = 'table-row';
    icon.style.transform = 'rotate(0deg)';
    icon.textContent = 'â–¼';
  } else {
    details.style.display = 'none';
    icon.style.transform = 'rotate(-90deg)';
    icon.textContent = 'â–¶';
  }
}

window.toggleLoanInterestDetails = toggleLoanInterestDetails;

// ì°¨ì…ê¸ˆ ì´ì ê³„ì‚° í•¨ìˆ˜
function calculateLoanInterest() {
  const loanAmount = parseFloat(document.getElementById('loanAmount')?.value) || 0;
  const interestRate = parseFloat(document.getElementById('loanInterestRate')?.value) || 0;
  
  // ì—°ê°„ ì´ìë¹„ìš© = ì°¨ì…ê¸ˆ Ã— ì´ììœ¨ Ã· 100
  const annualInterest = loanAmount * interestRate / 100;
  
  // ì´ ì´ìë¹„ìš© í‘œì‹œ ì—…ë°ì´íŠ¸
  const totalEl = document.getElementById('totalLoanInterest');
  if (totalEl) {
    totalEl.textContent = formatNumberWithCommas(Math.round(annualInterest));
  }
  
  // ê¸ˆìœµ ë° ì„¸ê¸ˆ í…Œì´ë¸”ì˜ ì°¨ì…ê¸ˆ ì´ì ì…ë ¥ë€ ì—…ë°ì´íŠ¸
  const loanInterestInput = document.getElementById('loanInterestInput');
  if (loanInterestInput) {
    loanInterestInput.value = formatNumberWithCommas(Math.round(annualInterest));
  }
  
  // ì¬ë¬´ ìš”ì•½ ì—…ë°ì´íŠ¸
  updateFinancialSummaries();
}

window.calculateLoanInterest = calculateLoanInterest;

// MAP íŒì—… ì—´ê¸° í•¨ìˆ˜
function openMapPopup() {
  const mapPath = '../map/index.html';
  const width = Math.min(1400, window.screen.width * 0.9);
  const height = Math.min(900, window.screen.height * 0.9);
  const left = (window.screen.width - width) / 2;
  const top = (window.screen.height - height) / 2;
  
  const popup = window.open(
    mapPath,
    'MapPopup',
    `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,toolbar=no,menubar=no,location=no,status=no`
  );
  
  if (!popup) {
    alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
  } else {
    popup.focus();
  }
}

window.openMapPopup = openMapPopup;

// ì¶”ê°€ë§¤ì¶œ ê³„ì‚° í•¨ìˆ˜
function calculateAdditionalRevenue(input) {
  const row = input.closest('tr');
  if (!row) return;
  
  const monthlyInput = row.querySelector('td:nth-child(2) input');
  const annualInput = row.querySelector('td:nth-child(3) input');
  
  if (monthlyInput && annualInput) {
    const monthlyValue = parseFloat(removeCommas(monthlyInput.value)) || 0;
    const annualValue = monthlyValue * 12;
    annualInput.value = formatNumberWithCommas(annualValue.toFixed(0));
  }
  
  updateAdditionalRevenueSum();
}

window.calculateAdditionalRevenue = calculateAdditionalRevenue;

// ì¶”ê°€ë§¤ì¶œ í•©ê³„ ì—…ë°ì´íŠ¸
function updateAdditionalRevenueSum() {
  const table = document.getElementById('additionalRevenueTable');
  if (!table) return;
  
  const rows = table.querySelectorAll('tbody tr');
  let sum = 0;
  
  rows.forEach(row => {
    const annualInput = row.querySelector('td:nth-child(3) input');
    if (annualInput) {
      const value = parseFloat(removeCommas(annualInput.value)) || 0;
      sum += value;
    }
  });
  
  const sumEl = document.getElementById('additionalRevenueSum');
  const sumBillionEl = document.getElementById('additionalRevenueSumBillion');
  
  if (sumEl) sumEl.textContent = formatNumberWithCommas(sum.toFixed(0));
  if (sumBillionEl) sumBillionEl.textContent = formatNumberWithCommas((sum / 10000).toFixed(2));
  
  // ì¬ë¬´ ìš”ì•½ ì—…ë°ì´íŠ¸
  updateFinancialSummaries();
}

window.updateAdditionalRevenueSum = updateAdditionalRevenueSum;

// ì¶”ê°€ë§¤ì¶œ í•­ëª© ì¶”ê°€
function addAdditionalRevenueRow() {
  const table = document.getElementById('additionalRevenueTable');
  if (!table) return;
  
  const tbody = table.querySelector('tbody');
  if (!tbody) return;
  
  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td><input type="text" placeholder="í•­ëª©ëª… ì…ë ¥"></td>
    <td><input type="text" value="0" oninput="calculateAdditionalRevenue(this)"></td>
    <td><input type="text" value="0" readonly style="background-color: #f0f0f0; font-weight: 700; color: #2e7d32;"></td>
    <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
  `;
  
  tbody.appendChild(newRow);
  bindFinancialInputs();
  updateAdditionalRevenueSum();
}

window.addAdditionalRevenueRow = addAdditionalRevenueRow;

function getSelectedScenarioRevenue(scenario) {
  // í˜„ì¬ ì„ íƒëœ ì‹œë‚˜ë¦¬ì˜¤ì˜ ë§¤ì¶œì„ ê°€ì ¸ì˜´ (ì²œì› ë‹¨ìœ„ë¥¼ ì–µì›ìœ¼ë¡œ ë³€í™˜)
  // ì‚¬ìš©ìê°€ ì„ íƒí•œ ëŒ€ìˆ˜ì™€ ì¹´ë¼ë°˜ í¬í•¨ ì—¬ë¶€ì— ë”°ë¼ ê³„ì‚°
  const prefix = scenario === 'positive' ? 'sp' : scenario === 'neutral' ? 'sn' : 'sg';
  
  // Get selected units (default 10)
  const unitsSelect = document.getElementById('kpi_glamping_units');
  const selectedUnits = unitsSelect ? unitsSelect.value : '10';
  
  // Get caravan checkbox (default false)
  const caravanCheckbox = document.getElementById('kpi_include_caravan');
  const includeCaravan = caravanCheckbox ? caravanCheckbox.checked : false;
  
  // Build selector: prefix + units + (_p for caravan) + _w (always include weight)
  // Examples: sp_10_w, sp_10_pw (10 units + caravan + weight), sp_15_w, sp_30_pw
  const selector = includeCaravan ? `.${prefix}_${selectedUnits}_pw` : `.${prefix}_${selectedUnits}_w`;
  
  const revenueEl = document.querySelector(selector);
  if (revenueEl && revenueEl.textContent !== '-') {
    const revenue = parseFloat(removeCommas(revenueEl.textContent)) / 100000; // ì²œì› -> ì–µì›
    return revenue;
  }
  return 0;
}

function getVATRate() {
  // finance í…Œì´ë¸”ì—ì„œ ë¶€ê°€ì„¸ìœ¨ ì°¾ê¸°
  const financeTable = document.getElementById('financeTable');
  if (financeTable) {
    const rows = financeTable.querySelectorAll('tbody tr');
    for (const row of rows) {
      const nameInput = row.querySelector('td:first-child input');
      const valueInput = row.querySelector('td:nth-child(2) input');
      if (nameInput && nameInput.value.includes('ë¶€ê°€ì„¸')) {
        return parseFloat(valueInput.value) || 10;
      }
    }
  }
  return 10; // ê¸°ë³¸ê°’
}

function getTaxRate() {
  // finance í…Œì´ë¸”ì—ì„œ ë²•ì¸ì„¸ìœ¨ ì°¾ê¸°
  const financeTable = document.getElementById('financeTable');
  if (financeTable) {
    const rows = financeTable.querySelectorAll('tbody tr');
    for (const row of rows) {
      const nameInput = row.querySelector('td:first-child input');
      const valueInput = row.querySelector('td:nth-child(2) input');
      if (nameInput && nameInput.value.includes('ë²•ì¸ì„¸ìœ¨')) {
        return parseFloat(valueInput.value) || 22;
      }
    }
  }
  return 22; // ê¸°ë³¸ê°’
}

function getDepreciation() {
  // ê³ ì •ë¹„ í…Œì´ë¸”ì—ì„œ ê°ê°€ìƒê°ë¹„ ì°¾ê¸°
  const fixedCostTable = document.getElementById('fixedCostTable');
  if (fixedCostTable) {
    const rows = fixedCostTable.querySelectorAll('tbody tr');
    for (const row of rows) {
      const nameInput = row.querySelector('td:first-child input');
      const valueInput = row.querySelector('td:nth-child(2) input');
      if (nameInput && nameInput.value.includes('ê°ê°€ìƒê°')) {
        const value = parseFloat(removeCommas(valueInput.value)) || 0;
        return value / 10000; // ë§Œì› -> ì–µì›
      }
    }
  }
  return 0; // ê¸°ë³¸ê°’ 0
}

function getLoanInterest() {
  // ê¸ˆìœµ ë° ì„¸ê¸ˆ í…Œì´ë¸”ì—ì„œ ì°¨ì…ê¸ˆ ì´ì ì°¾ê¸°
  const financeTable = document.getElementById('financeTable');
  if (financeTable) {
    const rows = financeTable.querySelectorAll('tbody tr');
    for (const row of rows) {
      const nameInput = row.querySelector('td:first-child input');
      const valueInput = row.querySelector('td:nth-child(2) input');
      if (nameInput && nameInput.value.includes('ì°¨ì…ê¸ˆ ì´ì')) {
        const value = parseFloat(removeCommas(valueInput.value)) || 0;
        return value / 10000; // ë§Œì› -> ì–µì›
      }
    }
  }
  return 0; // ê¸°ë³¸ê°’ 0
}

function getAdditionalRevenue() {
  // ì¶”ê°€ë§¤ì¶œ í…Œì´ë¸”ì—ì„œ ì—°ê°„ í•©ê³„ ê°€ì ¸ì˜¤ê¸°
  const table = document.getElementById('additionalRevenueTable');
  if (!table) return 0;
  
  const rows = table.querySelectorAll('tbody tr');
  let sum = 0;
  
  rows.forEach(row => {
    const annualInput = row.querySelector('td:nth-child(3) input');
    if (annualInput) {
      const value = parseFloat(removeCommas(annualInput.value)) || 0;
      sum += value;
    }
  });
  
  return sum / 10000; // ë§Œì› -> ì–µì›
}

function getMarketingCost() {
  // ë³€ë™ë¹„ í…Œì´ë¸”ì—ì„œ ë§ˆì¼€íŒ…ë¹„ í•­ëª© ì°¾ê¸°
  const variableTable = document.getElementById('variableCostTable');
  if (!variableTable) return 0;
  
  const rows = variableTable.querySelectorAll('tbody tr');
  for (const row of rows) {
    const nameInput = row.querySelector('td:first-child input');
    const valueInput = row.querySelector('td:nth-child(2) input');
    if (nameInput && nameInput.value.includes('ë§ˆì¼€íŒ…')) {
      const value = parseFloat(removeCommas(valueInput.value)) || 0;
      return value / 10000; // ë§Œì› -> ì–µì›
    }
  }
  
  return 0; // ê¸°ë³¸ê°’ 0
}

function calculateSimpleIRR(investment, annualCashFlow, years) {
  // NPV = 0ì´ ë˜ëŠ” í• ì¸ìœ¨ì„ ì°¾ëŠ” ê°„ë‹¨í•œ IRR ê³„ì‚°
  // Newton-Raphson ë°©ë²• ì‚¬ìš©
  let rate = 0.1; // ì´ˆê¸° ì¶”ì •ê°’ 10%
  const tolerance = 0.0001;
  const maxIterations = 100;
  
  for (let i = 0; i < maxIterations; i++) {
    let npv = -investment;
    let dnpv = 0;
    
    for (let year = 1; year <= years; year++) {
      const factor = Math.pow(1 + rate, year);
      npv += annualCashFlow / factor;
      dnpv -= year * annualCashFlow / (factor * (1 + rate));
    }
    
    if (Math.abs(npv) < tolerance) {
      return rate * 100; // í¼ì„¼íŠ¸ë¡œ ë³€í™˜
    }
    
    rate = rate - npv / dnpv;
    
    if (rate < -0.99) rate = -0.99; // í•˜í•œ
    if (rate > 10) rate = 10; // ìƒí•œ
  }
  
  return rate * 100;
}

function bindFinancialInputs() {
  const allInputs = document.querySelectorAll('.financial-table tbody td:nth-child(2) input');
  allInputs.forEach(inp => {
    inp.removeEventListener('input', updateFinancialSummaries);
    inp.addEventListener('input', updateFinancialSummaries);
    
    // Add comma formatting on blur
    inp.removeEventListener('blur', handleBlur);
    inp.addEventListener('blur', handleBlur);
    
    // Remove commas on focus for easier editing
    inp.removeEventListener('focus', handleFocus);
    inp.addEventListener('focus', handleFocus);
  });
}

function handleBlur(e) {
  formatNumberInput(e.target);
  updateFinancialSummaries();
}

function handleFocus(e) {
  e.target.value = removeCommas(e.target.value);
}

window.addFinancialRow = addFinancialRow;
window.deleteFinancialRow = deleteFinancialRow;

/* LocalStorage ë°ì´í„° ì €ì¥/ë³µì› */
function saveAllFinancialData() {
  const tables = ['capexTable', 'preopeningTable', 'fixedCostTable', 'variableCostTable', 'financeTable', 'additionalRevenueTable'];
  const data = {};
  
  tables.forEach(tableId => {
    const table = document.getElementById(tableId);
    if(!table) return;
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    
    // additionalRevenueTable has 3 columns (name, monthly, annual)
    if (tableId === 'additionalRevenueTable') {
      data[tableId] = rows.map(tr => {
        const cells = tr.querySelectorAll('td');
        return {
          name: cells[0]?.querySelector('input')?.value || '',
          monthly: cells[1]?.querySelector('input')?.value || '0',
          annual: cells[2]?.querySelector('input')?.value || '0'
        };
      });
    } else {
      data[tableId] = rows.map(tr => {
        const cells = tr.querySelectorAll('td');
        return {
          name: cells[0]?.querySelector('input')?.value || '',
          value: cells[1]?.querySelector('input')?.value || '0'
        };
      });
    }
  });
  
  // Save glamping table data
  const glampingRows = Array.from(document.querySelectorAll('#glampingTable tbody tr'));
  data.glampingTable = glampingRows.map(tr => {
    const inputs = tr.querySelectorAll('input');
    return Array.from(inputs).map(inp => inp.value);
  });
  
  // Save occupancy settings
  data.occupancy = {
    pos_high: document.getElementById('occ_pos_high')?.value,
    pos_weekend: document.getElementById('occ_pos_weekend')?.value,
    pos_weekday: document.getElementById('occ_pos_weekday')?.value,
    neu_high: document.getElementById('occ_neu_high')?.value,
    neu_weekend: document.getElementById('occ_neu_weekend')?.value,
    neu_weekday: document.getElementById('occ_neu_weekday')?.value,
    neg_high: document.getElementById('occ_neg_high')?.value,
    neg_weekend: document.getElementById('occ_neg_weekend')?.value,
    neg_weekday: document.getElementById('occ_neg_weekday')?.value
  };
  
  // Save weight
  data.weight = document.querySelector('.weightHeader input')?.value || '0.37';
  
  localStorage.setItem('glampingFinancialData', JSON.stringify(data));
  showToast('ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
}

function loadAllFinancialData() {
  const saved = localStorage.getItem('glampingFinancialData');
  if(!saved) return false;
  
  try {
    const data = JSON.parse(saved);
    
    // Restore financial tables
    const tables = ['capexTable', 'preopeningTable', 'fixedCostTable', 'variableCostTable', 'financeTable', 'additionalRevenueTable'];
    tables.forEach(tableId => {
      if(!data[tableId]) return;
      const table = document.getElementById(tableId);
      if(!table) return;
      
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = ''; // Clear existing rows
      
      // additionalRevenueTable has 3 columns
      if (tableId === 'additionalRevenueTable') {
        data[tableId].forEach(rowData => {
          const newRow = document.createElement('tr');
          const formattedMonthly = formatNumberWithCommas(Math.round(parseFloat(removeCommas(rowData.monthly)) || 0));
          const formattedAnnual = formatNumberWithCommas(Math.round(parseFloat(removeCommas(rowData.annual)) || 0));
          newRow.innerHTML = `
            <td><input type="text" value="${rowData.name}"></td>
            <td><input type="text" value="${formattedMonthly}" oninput="calculateAdditionalRevenue(this)"></td>
            <td><input type="text" value="${formattedAnnual}" readonly style="background-color: #f0f0f0; font-weight: 700; color: #2e7d32;"></td>
            <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
          `;
          tbody.appendChild(newRow);
        });
      } else {
        data[tableId].forEach(rowData => {
          const newRow = document.createElement('tr');
          const formattedValue = formatNumberWithCommas(Math.round(parseFloat(removeCommas(rowData.value)) || 0));
          newRow.innerHTML = `
            <td><input type="text" value="${rowData.name}"></td>
            <td><input type="text" value="${formattedValue}"></td>
            <td><button class="btn-small btn-delete" onclick="deleteFinancialRow(this)">ì‚­ì œ</button></td>
          `;
          tbody.appendChild(newRow);
        });
      }
    });
    
    // Restore glamping table
    if(data.glampingTable) {
      const glampingRows = document.querySelectorAll('#glampingTable tbody tr');
      data.glampingTable.forEach((rowData, idx) => {
        if(glampingRows[idx]) {
          const inputs = glampingRows[idx].querySelectorAll('input');
          rowData.forEach((val, i) => {
            if(inputs[i]) inputs[i].value = val;
          });
        }
      });
    }
    
    // Restore occupancy settings
    if(data.occupancy) {
      Object.keys(data.occupancy).forEach(key => {
        const el = document.getElementById('occ_' + key);
        if(el && data.occupancy[key]) el.value = data.occupancy[key];
      });
    }
    
    // Restore weight
    if(data.weight) {
      const gWeightEl = document.getElementById('gWeight');
      if(gWeightEl) gWeightEl.value = data.weight;
      document.querySelectorAll('.weightHeader input').forEach(inp => {
        inp.value = data.weight;
      });
    }
    
    // Update additional revenue sum after loading
    updateAdditionalRevenueSum();
    
    return true;
  } catch(e) {
    console.error('Failed to load data:', e);
    return false;
  }
}

function resetAllFinancialData() {
  if(!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  localStorage.removeItem('glampingFinancialData');
  showToast('ì´ˆê¸°í™” ì™„ë£Œ! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.', 'success');
  setTimeout(() => location.reload(), 1000);
}

window.saveAllFinancialData = saveAllFinancialData;
window.loadAllFinancialData = loadAllFinancialData;
window.resetAllFinancialData = resetAllFinancialData;

function downloadHTMLFile() {
  // Update all input values in the DOM before downloading
  // This ensures that current values are reflected in the value attribute
  document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
    input.setAttribute('value', input.value);
  });
  
  // Update all select elements
  document.querySelectorAll('select').forEach(select => {
    Array.from(select.options).forEach(option => {
      if (option.selected) {
        option.setAttribute('selected', 'selected');
      } else {
        option.removeAttribute('selected');
      }
    });
  });
  
  // Update all textarea elements
  document.querySelectorAll('textarea').forEach(textarea => {
    textarea.textContent = textarea.value;
  });
  
  // Update all checkbox and radio inputs
  document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
    if (input.checked) {
      input.setAttribute('checked', 'checked');
    } else {
      input.removeAttribute('checked');
    }
  });
  
  // Get current HTML content after updating attributes
  let htmlContent = document.documentElement.outerHTML;
  
  // Create a blob with the current HTML
  const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
  
  // Create download link
  const link = document.createElement('a');
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
  link.href = URL.createObjectURL(blob);
  link.download = `glamping_dashboard_${timestamp}.html`;
  
  // Trigger download
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(link.href);
  
  showToast('HTML íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
}

window.downloadHTMLFile = downloadHTMLFile;

/* ê°œì„ ëœ IRR (binary search) */
function irr(cfs){
  let low=-0.9999, high=2, mid=0;
  for(let i=0;i<80;i++){
    mid=(low+high)/2;
    let npv=0;
    cfs.forEach((c,t)=>npv+=c/Math.pow(1+mid,t));
    if(npv>0) low=mid; else high=mid;
  }
  return mid;
}

/* ê°œë³„ ê³„ì‚° */
function computeFerry(){
  const fareAdj = Number(fare.value) * Number(fareSlider.value);
  fareRate.innerText = Math.round(Number(fareSlider.value)*100)+"%";
  const revenue = Number(days.value) * Number(passengers.value) * fareAdj / 1e8;
  const ebitda = revenue - Number(opex.value);
  const investWith = Number(shipPrice.value) - Number(subsidy.value);
  const investWithout = Number(shipPrice.value);
  const years = 20;
  const cfsWith = [-investWith].concat(Array(years).fill(ebitda));
  const cfsWithout = [-investWithout].concat(Array(years).fill(ebitda));
  const irrWith = irr(cfsWith);
  const irrWithout = irr(cfsWithout);
  const res = {revenue, ebitda, investWith, investWithout, irrWith, irrWithout, years};
  projects.ferry = res;
  ferrySummary.innerHTML = `ì—°ê°„ ë§¤ì¶œ: ${revenue.toFixed(1)} ì–µì›<br>ì—°ê°„ EBITDA: ${ebitda.toFixed(1)} ì–µì›<br>IRR(ë³´ì¡°ê¸ˆ ON): ${(irrWith*100).toFixed(2)}% / OFF: ${(irrWithout*100).toFixed(2)}%`;
  return res;
}

function computeGlamping(){
  const revenue = Number(rooms.value)*365*Number(occ.value)*Number(adr.value)/1e8;
  const ebitda = revenue - Number(gOpex.value);
  const invest = Number(gInvest.value);
  const years = 10;
  const cfs = [-invest].concat(Array(years).fill(ebitda));
  const irrVal = irr(cfs);
  const res = {revenue, ebitda, invest, irr: irrVal, years};
  projects.glamping = res;
  glampingSummary.innerHTML = `ì—°ê°„ ë§¤ì¶œ: ${revenue.toFixed(1)} ì–µì›<br>ì—°ê°„ EBITDA: ${ebitda.toFixed(1)} ì–µì›<br>IRR: ${(irrVal*100).toFixed(2)}%`;
  return res;
}

function computeVenture(){
  const invest = Number(vInvest.value);
  const ebitda = Number(vEbitda.value);
  const years = Number(vYears.value)||10;
  const cfs = [-invest].concat(Array(years).fill(ebitda));
  const irrVal = irr(cfs);
  const res = {revenue: ebitda, ebitda, invest, irr: irrVal, years};
  projects.venture = res;
  ventureSummary.innerHTML = `ì—°ê°„ EBITDA: ${ebitda.toFixed(2)} ì–µì›<br>IRR: ${(irrVal*100).toFixed(2)}%`;
  return res;
}

/* í†µí•© ë¶„ì„ */
function consolidateAnalysis(){
  if(!projects.ferry) computeFerry();
  if(!projects.glamping) computeGlamping();
  if(!projects.venture) computeVenture();

  const f = projects.ferry, g = projects.glamping, v = projects.venture;
  const totalRevenue = (f.revenue||0) + (g.revenue||0) + (v.revenue||0);
  const totalEbitda = (f.ebitda||0) + (g.ebitda||0) + (v.ebitda||0);

  const years = 10;
  const investOn = (f.investWith||0) + (g.invest||0) + (v.invest||0);
  const investOff = (f.investWithout||0) + (g.invest||0) + (v.invest||0);

  const cfsOn = [-investOn].concat(Array(years).fill(totalEbitda));
  const cfsOff = [-investOff].concat(Array(years).fill(totalEbitda));

  const irrOn = irr(cfsOn);
  const irrOff = irr(cfsOff);

  kRevenue.innerText = totalRevenue.toFixed(1)+" ì–µì›";
  kEbitda.innerText = totalEbitda.toFixed(1)+" ì–µì›";
  kIrr.innerText = (irrOn*100).toFixed(2)+" %";

  aggregatedSummary.innerHTML = `ì´ ë§¤ì¶œ(ì—°ê°„ í•©ê³„): ${totalRevenue.toFixed(1)} ì–µì›<br>ì´ EBITDA(ì—°ê°„ í•©ê³„): ${totalEbitda.toFixed(1)} ì–µì›<br>í†µí•© IRR(ë³´ì¡°ê¸ˆ ON): ${(irrOn*100).toFixed(2)}% / OFF: ${(irrOff*100).toFixed(2)}%`;

  if(compareChart) compareChart.destroy();
  const labels=["ì—¬ê°ì„ ","ê¸€ë¨í•‘","ë²¤ì²˜","í†µí•©"];
  const data=[(f.ebitda||0),(g.ebitda||0),(v.ebitda||0), totalEbitda];
  compareChart = new Chart(compareChartEl,{type:"bar",data:{labels, datasets:[{data}]}});

  if(subsidyChart) subsidyChart.destroy();
  subsidyChart = new Chart(subsidyChartEl,{type:"line",data:{labels:["OFF","ON"], datasets:[{data:[irrOff*100, irrOn*100]}]}});
}

/* ì´ë²¤íŠ¸ ë°”ì¸ë”© */
fareSlider.oninput = ()=> fareRate.innerText = Math.round(Number(fareSlider.value)*100)+"%";
ferryAnalyze.onclick = computeFerry;
glampingAnalyze.onclick = computeGlamping;
ventureAnalyze.onclick = computeVenture;
consolidateBtn.onclick = consolidateAnalysis;

// Show/hide the static scenario tables
function showScenarioTable(id){
  ['positive','neutral','negative'].forEach(k=>{
    const el = document.getElementById('scenario_'+k);
    if(el) el.style.display = (k===id)?'':'none';
  });
}

// bind radios
document.querySelectorAll('input[name="scenario"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    const sel = document.querySelector('input[name="scenario"]:checked')?.value || 'positive';
    showScenarioTable(sel);
    updateKPIIndicators(); // Update KPI when scenario changes
  });
});

// bind glamping units selector and caravan checkbox
const kpiUnitsSelect = document.getElementById('kpi_glamping_units');
if(kpiUnitsSelect) {
  kpiUnitsSelect.addEventListener('change', ()=>{
    updateKPIIndicators(); // Update KPI when units change
  });
}

const kpiCaravanCheckbox = document.getElementById('kpi_include_caravan');
if(kpiCaravanCheckbox) {
  kpiCaravanCheckbox.addEventListener('change', ()=>{
    updateKPIIndicators(); // Update KPI when caravan option changes
  });
}
// init visibility on load
window.addEventListener('load', ()=>{
  // Load saved data first
  const dataLoaded = loadAllFinancialData();
  
  // í† ì§€ë¹„ìš© ì´ˆê¸° ê³„ì‚°
  calculateLandCost();
  
  // í† ì§€ë¹„ìš© ìƒì„¸ ê³„ì‚° ì˜ì—­ì„ ê¸°ë³¸ì ìœ¼ë¡œ ì ‘ì–´ë‘ 
  const landCalcDetails = document.getElementById('landCalcDetails');
  const landCalcIcon = document.getElementById('landCalcToggleIcon');
  if (landCalcDetails) {
    landCalcDetails.style.display = 'none';
  }
  if (landCalcIcon) {
    landCalcIcon.style.transform = 'rotate(-90deg)';
    landCalcIcon.textContent = 'â–¶';
  }
  
  // ê°ê°€ìƒê°ë¹„ ì´ˆê¸° ê³„ì‚°
  calculateDepreciation();
  
  // ê°ê°€ìƒê°ë¹„ ìƒì„¸ ê³„ì‚° ì˜ì—­ì„ ê¸°ë³¸ì ìœ¼ë¡œ ì ‘ì–´ë‘ 
  const depreciationDetails = document.getElementById('depreciationDetails');
  const depreciationIcon = document.getElementById('depreciationToggleIcon');
  if (depreciationDetails) {
    depreciationDetails.style.display = 'none';
  }
  if (depreciationIcon) {
    depreciationIcon.style.transform = 'rotate(-90deg)';
    depreciationIcon.textContent = 'â–¶';
  }
  
  // populate ê¸ì •/ë¶€ì • í‘œ from ì¤‘ë¦½ì•ˆ (only do this once on initial load, not on tab switches)
  // This should only be called at startup to ensure scenario tables have proper structure
  const posTable = document.getElementById('scenario_positive_table');
  const neuTable = document.getElementById('scenario_neutral_table');
  const negTable = document.getElementById('scenario_negative_table');
  
  // Only create/sync if tables appear to be empty
  if(neuTable && neuTable.querySelectorAll('tbody tr').length === 0){
    createScenarioTableSingle();
  }
  
  // ensure neutral/negative follow the positive table structure
  syncTablesFromPositive();
  // Per user request: show only the ê¸ì •ì•ˆ table by default
  setOnlyPositiveScenarioVisible();
  // bind input events and initialize the ì„ëŒ€ë£Œ column in all scenario tables
  bindGlampingInputsToRentUpdate();
  updateAllScenariosRentFromInputs();
  // bind occupancy settings and apply them to all scenarios
  bindOccupancyInputs();
  updateScenarioOccupancyFromSettings();
  
  // ì´ˆê¸° ê³„ì‚° ì‹¤í–‰
  calculateLandCost();
  calculateDepreciation();
  calculateLoanInterest();
  updateAdditionalRevenueSum();
  updateFinancialSummaries();
  
  // Initialize calculations and chart after all tables are set up
  setTimeout(()=>{
    bindFinancialInputs();
    updateFinancialSummaries();
    updateAllScenarioCalculations();
    updateWeightHeader();
    updateGlampingUnitsChart();
    
    // Format all existing financial inputs with commas
    document.querySelectorAll('.financial-table tbody td:nth-child(2) input').forEach(inp => {
      formatNumberInput(inp);
    });
    
    // Format all existing operation table inputs with commas
    document.querySelectorAll('#glampingTable input[type="text"]').forEach(inp => {
      let val = removeCommas(inp.value);
      const num = parseFloat(val);
      if (!isNaN(num)) {
        inp.value = formatNumberWithCommas(Math.round(num));
      }
    });
    
    if(dataLoaded) {
      showToast('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
    }
  }, 100);
});

// ensure tab activation also shows the selected scenario
document.querySelectorAll('.tabs button').forEach(btn=>{
  const original = btn.onclick;
  btn.onclick = ()=>{
    original();
    if(btn.dataset.tab === 'glamping'){
      // refresh scenario tables when tab activated
      // Note: createScenarioTableSingle() should NOT be called here as it will reset values
      // Just ensure proper visibility and binding
      syncTablesFromPositive();
      // keep only ê¸ì •ì•ˆ visible and refresh ì„ëŒ€ë£Œ values after structural sync
      setOnlyPositiveScenarioVisible();
      bindGlampingInputsToRentUpdate();
      updateAllScenariosRentFromInputs();
      // bind occupancy settings and apply them to all scenarios
      bindOccupancyInputs();
      updateScenarioOccupancyFromSettings();
    }
  }
});

// Handle details (collapsible) open/close to preserve financial input values
document.querySelectorAll('.collapsible-section').forEach(details=>{
  // When a details element is toggled open, ensure all inputs are properly formatted
  details.addEventListener('toggle', ()=>{
    if(details.open){
      // Ensure financial inputs are visible and properly formatted
      setTimeout(()=>{
        const financialInputs = details.querySelectorAll('.financial-table tbody td:nth-child(2) input[type="number"]');
        financialInputs.forEach(inp=>{
          if(inp.value && inp.value.length > 0){
            // Value is already set - just ensure it's visible by triggering focus/blur
            const val = inp.value;
            inp.style.color = '#333';
            inp.style.backgroundColor = '#fff';
          }
        });
      }, 0);
    }
  });
});

// --- Helpers: keep only ê¸ì •ì•ˆ visible and update ì„ëŒ€ë£Œ from ìš´ì˜ ì…ë ¥í‘œ ---
let _glampingInputsBound = false;
function setOnlyPositiveScenarioVisible(){
  // hide neutral and negative scenario containers but do not alter table structure
  const pos = document.getElementById('scenario_positive'); if(pos) pos.style.display = '';
  const neu = document.getElementById('scenario_neutral'); if(neu) neu.style.display = 'none';
  const neg = document.getElementById('scenario_negative'); if(neg) neg.style.display = 'none';
  // select the positive radio so UI reflects the change
  const posRadio = document.querySelector('input[name="scenario"][value="positive"]');
  if(posRadio) posRadio.checked = true;
}

function getGlampingPrices(){
  const rows = Array.from(document.querySelectorAll('#glampingTable tbody tr'));
  // Expect rows: [ê¸°ì¤€2ì¸, ì¶”ê°€ì¸ì›(+1), ì¶”ê°€ì¸ì›(+2)] and columns: í‰ì¼, ì£¼ë§, ê³µíœ´ì¼
  const values = {weekday:null, weekend:null, holiday:null};
  if(rows.length>=1){
    const cells = rows[0].querySelectorAll('input');
    values.weekday = Number(removeCommas(cells[0]?.value || '0'));
    values.weekend = Number(removeCommas(cells[1]?.value || '0'));
    values.holiday = Number(removeCommas(cells[2]?.value || '0'));
  }
  // Return values in ì›
  return values;
}

function updateAllScenariosRentFromInputs(){
  const prices = getGlampingPrices();
  if(prices.weekday==null) return;
  // convert to ì²œì› ë‹¨ìœ„ (round)
  const p_weekday = Math.round(prices.weekday/1000);
  const p_weekend = Math.round(prices.weekend/1000);
  const p_holiday = Math.round(prices.holiday/1000);

  const tableIds = ['scenario_positive_table','scenario_neutral_table','scenario_negative_table'];
  tableIds.forEach(tblId=>{
    const tbl = document.getElementById(tblId);
    if(!tbl) return;
    const rows = Array.from(tbl.querySelectorAll('tbody tr'));
    rows.forEach(tr=>{
      const cells = Array.from(tr.children);
      // skip rows that don't have at least 3 cells (e.g., total rows with colspan)
      if(cells.length < 3) return;
      const period = (cells[1]?.textContent || '').trim();
      // Update the ì„ëŒ€ë£Œ(ì›) column (index 2) for known periods
      if(period === 'ì„±ìˆ˜ê¸°'){
        // ê³µíœ´ì¼ì„ ì„±ìˆ˜ê¸°ì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
        cells[2].textContent = p_holiday;
      }else if(period === 'ì£¼ë§'){
        cells[2].textContent = p_weekend;
      }else if(period === 'í‰ì¼'){
        cells[2].textContent = p_weekday;
      }
    });
  });
}

// backward-compatible wrapper
function updateNegativeRentFromInputs(){
  updateAllScenariosRentFromInputs();
}

function bindGlampingInputsToRentUpdate(){
  if(_glampingInputsBound) return;
  const inputs = document.querySelectorAll('#glampingTable input[type="text"]');
  inputs.forEach(inp=>inp.addEventListener('input', ()=>{
    updateAllScenariosRentFromInputs();
  }));
  _glampingInputsBound = true;
}

// --- ì˜ˆìƒ ê°€ë™ë¥  ì„¤ì • helpers ---
let _occInputsBound = false;
function getOccupancySettings(){
  return {
    positive: { high: Number(document.getElementById('occ_pos_high')?.value||0), weekend: Number(document.getElementById('occ_pos_weekend')?.value||0), weekday: Number(document.getElementById('occ_pos_weekday')?.value||0) },
    neutral:  { high: Number(document.getElementById('occ_neu_high')?.value||0), weekend: Number(document.getElementById('occ_neu_weekend')?.value||0), weekday: Number(document.getElementById('occ_neu_weekday')?.value||0) },
    negative: { high: Number(document.getElementById('occ_neg_high')?.value||0), weekend: Number(document.getElementById('occ_neg_weekend')?.value||0), weekday: Number(document.getElementById('occ_neg_weekday')?.value||0) }
  };
}

function updateScenarioOccupancyFromSettings(){
  const occ = getOccupancySettings();
  const mapping = { 'ì„±ìˆ˜ê¸°': 'high', 'ì£¼ë§': 'weekend', 'í‰ì¼': 'weekday' };
  const tableMap = { positive: 'scenario_positive_table', neutral: 'scenario_neutral_table', negative: 'scenario_negative_table' };

  function formatPercentValue(v){
    const n = Number(v);
    if(!isFinite(n)) return '';
    // Preserve integers (e.g., 70 -> "70"), but trim unnecessary decimal zeros (e.g., 18.0 -> "18", 18.50 -> "18.5")
    let s = String(n);
    if(s.indexOf('.') >= 0){
      s = s.replace(/\.0+$|(?<=(?:\d)\d)0+$/,'');
      s = s.replace(/\.$/, '');
    }
    return s;
  }

  Object.keys(tableMap).forEach(scn=>{
    const tbl = document.getElementById(tableMap[scn]);
    if(!tbl) return;
    const rows = Array.from(tbl.querySelectorAll('tbody tr'));
    rows.forEach(tr=>{
      const cells = Array.from(tr.children);
      if(cells.length < 6) return; // skip subtotal/total rows
      const period = (cells[1]?.textContent || '').trim();
      const key = mapping[period];
      if(!key) return;
      const val = occ[scn][key];
      if(val===null || val===undefined) return;
      const formatted = formatPercentValue(val);
      if(formatted !== '') cells[5].textContent = formatted + "%";
    });
  });
}

function bindOccupancyInputs(){
  if(_occInputsBound) return;
  const inputs = document.querySelectorAll('#occSettings input[type="number"]');
  inputs.forEach(inp=>inp.addEventListener('input', ()=>{
    if(!validateOccupancyInputs()) return;
    updateScenarioOccupancyFromSettings();
    updateAllScenarioCalculations();
  }));
  _occInputsBound = true;
}

/* --- Toast helpers --- */
function showToast(message, type='error', timeout=3500){
  const container = document.getElementById('toastContainer');
  if(!container) return;
  const el = document.createElement('div');
  el.className = 'toast '+(type==='error'?'error':'success');
  el.textContent = message;
  container.appendChild(el);
  setTimeout(()=>{ el.style.opacity = '0'; setTimeout(()=>el.remove(),300); }, timeout);
}

/* --- Input validation --- */
function validateWeightInput(){
  const el = document.getElementById('gWeight');
  if(!el) return true;
  const v = Number(el.value);
  if(!isFinite(v) || v < 0){
    showToast('ê°€ì¤‘ì¹˜ëŠ” 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
    return false;
  }
  return true;
}

function formatWeightValue(v){
  const n = Number(v);
  if(!isFinite(n)) return '';
  let s = String(n);
  if(s.indexOf('.') >= 0){
    s = s.replace(/\.0+$/,'');
    s = s.replace(/(\.\d*?)0+$/,'$1');
    s = s.replace(/\.$/, '');
  }
  return s;
}

function updateWeightHeader(){
  const el = document.getElementById('gWeight');
  const s = formatWeightValue(el?.value);
  // Update all weight header inputs
  document.querySelectorAll('.weightHeader input').forEach(inp=>{
    if(inp.value !== s) inp.value = s;
  });
}

function updateWeightFromHeader(value){
  const gWeightEl = document.getElementById('gWeight');
  if(gWeightEl) {
    gWeightEl.value = value;
  }
  // Sync all weight header inputs across all scenarios
  document.querySelectorAll('.weightHeader input').forEach(inp=>{
    if(inp.value !== value) inp.value = value;
  });
  // Trigger calculation update
  if(!validateWeightInput()) return;
  updateAllScenarioCalculations();
}

window.updateWeightFromHeader = updateWeightFromHeader;

window.updateWeightFromHeader = updateWeightFromHeader; 

function validateGlampingInputs(){
  const inputs = document.querySelectorAll('#glampingTable input[type="text"]');
  for(const inp of inputs){
    const v = Number(removeCommas(inp.value));
    if(!isFinite(v) || v < 0){
      showToast('ê¸€ë¨í•‘ ìš´ì˜ ì…ë ¥ê°’ì€ 0 ì´ìƒì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
      return false;
    }
  }
  // validate weight as well
  if(!validateWeightInput()) return false;
  return true;
} 

function validateOccupancyInputs(){
  const inputs = document.querySelectorAll('#occSettings input[type="number"]');
  for(const inp of inputs){
    const v = Number(inp.value);
    if(!isFinite(v) || v < 0 || v > 100){
      showToast('ê°€ë™ë¥ ì€ 0~100 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
      return false;
    }
  }
  return true;
}

/* --- Core: calculate revenue / add-on columns for a scenario table --- */
function updateAllScenarioCalculations(){
  if(!validateGlampingInputs()) return;
  const prices = getGlampingPrices(); // in ì›
  // convert to ì²œì›
  const base = { weekday: Math.round(prices.weekday/1000), weekend: Math.round(prices.weekend/1000), holiday: Math.round(prices.holiday/1000) };
  // add-on prices total (full price for +1 and +2)
  const glRows = Array.from(document.querySelectorAll('#glampingTable tbody tr'));
  if(glRows.length < 3) return; // need base, +1, +2 rows
  const baseRowInputs = glRows[0].querySelectorAll('input');
  const add1RowInputs = glRows[1].querySelectorAll('input');
  const add2RowInputs = glRows[2].querySelectorAll('input');
  const addon = {
    weekday: { add1: Math.round((Number(removeCommas(add1RowInputs[0]?.value||'0')) - Number(removeCommas(baseRowInputs[0]?.value||'0'))) / 1000), add2: Math.round((Number(removeCommas(add2RowInputs[0]?.value||'0')) - Number(removeCommas(baseRowInputs[0]?.value||'0'))) / 1000) },
    weekend: { add1: Math.round((Number(removeCommas(add1RowInputs[1]?.value||'0')) - Number(removeCommas(baseRowInputs[1]?.value||'0'))) / 1000), add2: Math.round((Number(removeCommas(add2RowInputs[1]?.value||'0')) - Number(removeCommas(baseRowInputs[1]?.value||'0'))) / 1000) },
    holiday: { add1: Math.round((Number(removeCommas(add1RowInputs[2]?.value||'0')) - Number(removeCommas(baseRowInputs[2]?.value||'0'))) / 1000), add2: Math.round((Number(removeCommas(add2RowInputs[2]?.value||'0')) - Number(removeCommas(baseRowInputs[2]?.value||'0'))) / 1000) }
  };

  const mapping = { 'ì„±ìˆ˜ê¸°': 'holiday', 'ì£¼ë§': 'weekend', 'í‰ì¼': 'weekday' };
  ['scenario_positive_table','scenario_neutral_table','scenario_negative_table'].forEach(tblId=>{
    const tbl = document.getElementById(tblId);
    if(!tbl) return;
    const rows = Array.from(tbl.querySelectorAll('tbody tr'));
    let currentUnits = null;
    // determine scenario key from table id
    const scnKey = tblId.includes('positive')? 'positive' : tblId.includes('neutral')? 'neutral' : 'negative';
    const occSettings = getOccupancySettings()[scnKey];
    rows.forEach(tr=>{
      const cells = Array.from(tr.children);
      if(cells.length < 6) return; // skip subtotal/total rows
      const first = (cells[0]?.textContent || '').trim();
      const m = first.match(/\((\d+)\)/);
      if(m) currentUnits = Number(m[1]);
      if(currentUnits==null) return; // skip rows until we know units
      const period = (cells[1]?.textContent || '').trim();
      const key = mapping[period];
      if(!key) return;
      const daysVal = parseInt((cells[3]?.textContent||'').replace(/[^0-9]/g,'')) || 0;
      const occText = (cells[5]?.textContent||'').trim();
      let occNum = parsePercent(occText);
      if(occNum == null) occNum = occSettings[key];
      // normalize to decimal (0-1): if value appears as 0-100 percentage, divide by 100
      let occDecimal = (typeof occNum === 'number') ? (occNum > 1 ? occNum/100 : occNum) : 0;
      // rent in ì²œì›
      const rent_th = base[key];
      const rev = Math.round(currentUnits * rent_th * daysVal * occDecimal);
      cells[6].textContent = formatNumberWithCommas(rev);
      // add1/add2 totals
      const add1_total = Math.round(currentUnits * addon[key].add1 * daysVal * occDecimal);
      const add2_total = Math.round(currentUnits * addon[key].add2 * daysVal * occDecimal);
      cells[7].textContent = formatNumberWithCommas(add1_total);
      cells[8].textContent = formatNumberWithCommas(add2_total);
      // ê°€ì¤‘ì¹˜ ê³„ì‚°: (ì¶”ê°€ì¸ì›(1) + ì¶”ê°€ì¸ì›(2)) * ê°€ì¤‘ì¹˜ (gWeight), ê²°ê³¼ëŠ” ì²œì› ë‹¨ìœ„
      const weightInput = document.querySelector('.weightHeader input');
      const weightFactor = Number(weightInput?.value || document.getElementById('gWeight')?.value) || 0;
      const weightVal = Math.round((add1_total + add2_total) * weightFactor);
      cells[9].textContent = formatNumberWithCommas(weightVal);
    });
  });
  // update scenario summaries after table calculations
  updateScenarioSummaries();
}

// Bind existing input listeners to also recompute derived columns
(function bindAdditionalListeners(){
  // extend existing bindings
  const glInputs = document.querySelectorAll('#glampingTable input[type="text"]');
  glInputs.forEach(inp=>{
    inp.addEventListener('input', ()=>{
      if(!validateGlampingInputs()) return;
      updateAllScenariosRentFromInputs();
      updateAllScenarioCalculations();
    });
    
    // Add comma formatting on blur
    inp.addEventListener('blur', (e) => {
      let val = removeCommas(e.target.value);
      const num = parseFloat(val);
      if (!isNaN(num)) {
        e.target.value = formatNumberWithCommas(Math.round(num));
      }
      updateAllScenariosRentFromInputs();
      updateAllScenarioCalculations();
    });
    
    // Remove commas on focus
    inp.addEventListener('focus', (e) => {
      e.target.value = removeCommas(e.target.value);
    });
  });

  const occInputs = document.querySelectorAll('#occSettings input[type="number"]');
  occInputs.forEach(inp=>{
    inp.addEventListener('input', ()=>{
      if(!validateOccupancyInputs()) return;
      updateScenarioOccupancyFromSettings();
      updateAllScenarioCalculations();
    });
  });

  const weightEl = document.getElementById('gWeight');
  if(weightEl){
    weightEl.addEventListener('input', ()=>{
      if(!validateWeightInput()) return;
      updateWeightHeader();
      updateAllScenarioCalculations();
    });
    // initialize header to current value
    updateWeightHeader();
  }
})();

// Bind caravan checkbox to chart update
if(includeCaravanChart){
  includeCaravanChart.addEventListener('change', ()=>{
    updateGlampingUnitsChart();
  });
}

/* create ê¸ì •/ë¶€ì • variant tables by adjusting numeric cells (+/-10%) */
function formatNumberWithCommas(n){ return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }

function removeCommas(str) {
  return str.replace(/,/g, '');
}

function formatNumberInput(input) {
  let val = removeCommas(input.value);
  if (val === '' || val === '-') return;
  const num = parseFloat(val);
  if (!isNaN(num)) {
    // For input[type="number"], don't add commas (they don't support comma-formatted values)
    // For input[type="text"], add commas for readability
    if (input.type === 'number') {
      input.value = Math.round(num);
    } else {
      input.value = formatNumberWithCommas(Math.round(num));
    }
  }
}

function adjustTableNumbers(tableEl, factor){
  const t = tableEl.cloneNode(true);
  t.querySelectorAll('td').forEach(td=>{
    const txt = td.textContent.trim();
    if(!txt) return;
    if(txt.indexOf('%')>=0) return;
    // remove commas and non-numeric chars
    const num = Number(txt.replace(/,/g,'').replace(/[^\d.-]/g,''));
    if(!isFinite(num)) return;
    const adjusted = Math.round(num * factor);
    td.textContent = formatNumberWithCommas(adjusted);
  });
  return t;
}

// --- Scenario table parsing helpers (tables are in 'ì²œì›' units) ---
function parseTableNumberToWon(s){
  if(!s) return null;
  const cleaned = s.toString().replace(/,/g,'').replace(/[^\d.-]/g,'').trim();
  if(cleaned === '') return null;
  const asNum = Number(cleaned);
  if(!isFinite(asNum)) return null;
  // table numbers are in ì²œì› ë‹¨ìœ„, convert to ì›
  return asNum * 1000;
}

function parsePercent(s){
  if(!s) return null;
  const m = s.toString().match(/-?\d+(?:\.\d+)?/);
  return m ? Number(m[0]) : null;
}

function extractScenarioTable(id){
  const table = document.getElementById(id);
  if(!table) return [];
  const rows = Array.from(table.querySelectorAll('tbody tr'));
  return rows.map(tr=>{
    const cells = Array.from(tr.children);
    const getText = i => cells[i]?.textContent.trim() ?? '';
    return {
      raw: tr.textContent.trim(),
      col0: getText(0),
      facility: getText(1),
      rent_thousand: (function(n){ if(!n) return null; const v=Number(n.replace(/,/g,'')); return isFinite(v)? v : null; })(getText(2)),
      rent_won: parseTableNumberToWon(getText(2)),
      days: (function(n){ const v=parseInt(n); return isNaN(v)?null:v; })(getText(3)),
      annual_count: (function(n){ const v=parseInt(n); return isNaN(v)?null:v; })(getText(4)),
      occupancy_pct: parsePercent(getText(5)),
      revenue_won: parseTableNumberToWon(getText(6)),
      add1_won: parseTableNumberToWon(getText(7)),
      add2_won: parseTableNumberToWon(getText(8)),
      weight_raw: getText(9),
      weight: (function(n){ if(!n) return null; const p = parsePercent(n); if(p!==null) return p; const w = Number(n.replace(/,/g,'')); return isFinite(w)? w : null; })(getText(9)),
      note: getText(10)
    };
  });
}

window.extractScenarioTable = extractScenarioTable;
window.extractAllScenarios = ()=>({
  positive: extractScenarioTable('scenario_positive_table'),
  neutral: extractScenarioTable('scenario_neutral_table'),
  negative: extractScenarioTable('scenario_negative_table')
});

// --- Scenario summary helpers ---
function parseThousandNumber(s){
  if(!s) return 0;
  const cleaned = s.toString().replace(/,/g,'').replace(/[^0-9.-]/g,'').trim();
  if(cleaned === '') return 0;
  const n = Number(cleaned);
  return isFinite(n)? n : 0;
}

function sumRevenueForUnits(tblId, units, includeWeight = false){
  const tbl = document.getElementById(tblId);
  if(!tbl) return 0;
  const rows = Array.from(tbl.querySelectorAll('tbody tr'));
  let sum = 0;
  let inTargetUnit = false;
  
  rows.forEach(tr=>{
    const cells = Array.from(tr.children);
    const first = (cells[0]?.textContent||'').trim();
    const second = (cells[1]?.textContent||'').trim();
    
    // Check if this row starts a new unit section
    if(first.indexOf('('+units+')')>=0){
      inTargetUnit = true;
    } else if(first.indexOf('(')>=0 && first.indexOf(')')>=0){
      // This is a different unit section, stop accumulating
      inTargetUnit = false;
    }
    
    // If we're in the target unit section and this is a period row (ì„±ìˆ˜ê¸°, ì£¼ë§, í‰ì¼)
    if(inTargetUnit && (second === 'ì„±ìˆ˜ê¸°' || second === 'ì£¼ë§' || second === 'í‰ì¼')){
      const revText = cells[6]?.textContent || '';
      sum += parseThousandNumber(revText);
      if(includeWeight){
        const weightText = cells[9]?.textContent || '';
        sum += parseThousandNumber(weightText);
      }
    }
  });
  
  return sum;
}

function sumCaravan5(tblId, includeWeight = false){
  const tbl = document.getElementById(tblId);
  if(!tbl) return 0;
  const rows = Array.from(tbl.querySelectorAll('tbody tr'));
  let sum = 0;
  let inCaravan5 = false;
  
  rows.forEach(tr=>{
    const cells = Array.from(tr.children);
    const first = (cells[0]?.textContent||'').trim();
    const second = (cells[1]?.textContent||'').trim();
    
    // Check if this row starts the caravan 5 section
    if(first.indexOf('(5)')>=0){
      inCaravan5 = true;
    } else if(first.indexOf('(')>=0 && first.indexOf(')')>=0 && first.indexOf('(5)')<0){
      // This is a different section, stop accumulating
      inCaravan5 = false;
    }
    
    // If we're in the caravan 5 section and this is a period row
    if(inCaravan5 && (second === 'ì„±ìˆ˜ê¸°' || second === 'ì£¼ë§' || second === 'í‰ì¼')){
      const revText = cells[6]?.textContent || '';
      sum += parseThousandNumber(revText);
      if(includeWeight){
        const weightText = cells[9]?.textContent || '';
        sum += parseThousandNumber(weightText);
      }
    }
  });
  
  return sum;
}

function updateScenarioSummaries(){
  ['positive','neutral','negative'].forEach(scn=>{
    const tblId = 'scenario_'+scn+'_table';
    const gl10 = sumRevenueForUnits(tblId, 10, false);
    const gl10_w = sumRevenueForUnits(tblId, 10, true);
    const gl15 = sumRevenueForUnits(tblId, 15, false);
    const gl15_w = sumRevenueForUnits(tblId, 15, true);
    const gl30 = sumRevenueForUnits(tblId, 30, false);
    const gl30_w = sumRevenueForUnits(tblId, 30, true);
    const cv5 = sumCaravan5(tblId, false);
    const cv5_w = sumCaravan5(tblId, true);
    // set cells safely
    const setText = (sel, val)=>{ const el = document.querySelector(sel); if(el) el.textContent = val; };
    if(scn==='positive'){
      setText('.sp_10', formatNumberWithCommas(gl10));
      setText('.sp_10_w', formatNumberWithCommas(gl10_w));
      setText('.sp_10_p', formatNumberWithCommas(gl10 + cv5));
      setText('.sp_10_pw', formatNumberWithCommas(gl10_w + cv5_w));
      setText('.sp_15', formatNumberWithCommas(gl15));
      setText('.sp_15_w', formatNumberWithCommas(gl15_w));
      setText('.sp_15_p', formatNumberWithCommas(gl15 + cv5));
      setText('.sp_15_pw', formatNumberWithCommas(gl15_w + cv5_w));
      setText('.sp_30', formatNumberWithCommas(gl30));
      setText('.sp_30_w', formatNumberWithCommas(gl30_w));
      setText('.sp_30_p', formatNumberWithCommas(gl30 + cv5));
      setText('.sp_30_pw', formatNumberWithCommas(gl30_w + cv5_w));
    }else if(scn==='neutral'){
      setText('.sn_10', formatNumberWithCommas(gl10));
      setText('.sn_10_w', formatNumberWithCommas(gl10_w));
      setText('.sn_10_p', formatNumberWithCommas(gl10 + cv5));
      setText('.sn_10_pw', formatNumberWithCommas(gl10_w + cv5_w));
      setText('.sn_15', formatNumberWithCommas(gl15));
      setText('.sn_15_w', formatNumberWithCommas(gl15_w));
      setText('.sn_15_p', formatNumberWithCommas(gl15 + cv5));
      setText('.sn_15_pw', formatNumberWithCommas(gl15_w + cv5_w));
      setText('.sn_30', formatNumberWithCommas(gl30));
      setText('.sn_30_w', formatNumberWithCommas(gl30_w));
      setText('.sn_30_p', formatNumberWithCommas(gl30 + cv5));
      setText('.sn_30_pw', formatNumberWithCommas(gl30_w + cv5_w));
    }else{
      setText('.sg_10', formatNumberWithCommas(gl10));
      setText('.sg_10_w', formatNumberWithCommas(gl10_w));
      setText('.sg_10_p', formatNumberWithCommas(gl10 + cv5));
      setText('.sg_10_pw', formatNumberWithCommas(gl10_w + cv5_w));
      setText('.sg_15', formatNumberWithCommas(gl15));
      setText('.sg_15_w', formatNumberWithCommas(gl15_w));
      setText('.sg_15_p', formatNumberWithCommas(gl15 + cv5));
      setText('.sg_15_pw', formatNumberWithCommas(gl15_w + cv5_w));
      setText('.sg_30', formatNumberWithCommas(gl30));
      setText('.sg_30_w', formatNumberWithCommas(gl30_w));
      setText('.sg_30_p', formatNumberWithCommas(gl30 + cv5));
      setText('.sg_30_pw', formatNumberWithCommas(gl30_w + cv5_w));
    }
  });
  // Update glamping units chart after summaries are calculated
  updateGlampingUnitsChart();
  // Update KPI indicators
  updateKPIIndicators();
}

function updateGlampingUnitsChart(){
  if(!glampingUnitsChartEl) return;
  
  const includeCaravan = includeCaravanChart?.checked || false;
  
  // Collect data for all scenarios
  const scenarios = ['positive', 'neutral', 'negative'];
  const units = [10, 15, 30];
  const datasets = [];
  
  const colors = {
    positive: { border: 'rgb(46, 125, 50)', bg: 'rgba(46, 125, 50, 0.2)' },
    neutral: { border: 'rgb(66, 133, 244)', bg: 'rgba(66, 133, 244, 0.2)' },
    negative: { border: 'rgb(176, 0, 32)', bg: 'rgba(176, 0, 32, 0.2)' }
  };
  
  const lineStyles = {
    positive: [],
    neutral: [5, 5],
    negative: [10, 5]
  };
  
  const labels = { positive: 'ê¸ì •ì•ˆ', neutral: 'ì¤‘ë¦½ì•ˆ', negative: 'ë¶€ì •ì•ˆ' };
  
  // Build datasets for each scenario
  scenarios.forEach(scn => {
    const tblId = 'scenario_' + scn + '_table';
    const tbl = document.getElementById(tblId);
    
    // Check if table exists before processing
    if(!tbl) {
      console.warn('Table not found:', tblId);
      return;
    }
    
    const data = [];
    units.forEach(u => {
      let glampingWithWeight = sumRevenueForUnits(tblId, u, true);
      if(includeCaravan){
        const caravanWithWeight = sumCaravan5(tblId, true);
        glampingWithWeight += caravanWithWeight;
      }
      data.push(glampingWithWeight);
    });
    
    console.log(scn + ' data:', data); // Debug log
    
    datasets.push({
      label: labels[scn],
      data: data,
      borderColor: colors[scn].border,
      backgroundColor: colors[scn].bg,
      borderWidth: 3,
      borderDash: lineStyles[scn],
      tension: 0.3,
      fill: false,
      pointRadius: 6,
      pointHoverRadius: 8,
      pointBackgroundColor: colors[scn].border,
      pointBorderColor: '#fff',
      pointBorderWidth: 2
    });
  });
  
  console.log('Total datasets:', datasets.length); // Debug log
  
  if(glampingUnitsChart){
    glampingUnitsChart.destroy();
  }
  
  glampingUnitsChart = new Chart(glampingUnitsChartEl, {
    type: 'line',
    data: {
      labels: ['10ëŒ€', '15ëŒ€', '30ëŒ€'],
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        title: {
          display: true,
          text: 'ê¸€ë¨í•‘ ëŒ€ìˆ˜ë³„ í•©ì‚°ê¸ˆì•¡ ë¹„êµ' + (includeCaravan ? ' (ì¹´ë¼ë°˜ 5ëŒ€ í¬í•¨)' : '') + ' - ê°€ì¤‘ì¹˜ í¬í•¨ (ì²œì›)',
          font: { size: 16, weight: 'bold' }
        },
        legend: {
          display: true,
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 15,
            font: { size: 13 }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed.y !== null) {
                label += formatNumberWithCommas(context.parsed.y) + ' ì²œì›';
              }
              return label;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          grace: '5%',
          ticks: {
            callback: function(value) {
              return formatNumberWithCommas(value);
            },
            maxTicksLimit: 8
          },
          title: {
            display: true,
            text: 'í•©ì‚°ê¸ˆì•¡ (ì²œì›)',
            font: { size: 13, weight: 'bold' }
          }
        },
        x: {
          title: {
            display: true,
            text: 'ê¸€ë¨í•‘ ëŒ€ìˆ˜',
            font: { size: 13, weight: 'bold' }
          }
        }
      }
    }
  });
}

function createScenarioTableSingle(){
  // Copy HTML-only between scenario tables (no numeric adjustments)
  const pos = document.getElementById('scenario_positive_table');
  const neutral = document.getElementById('scenario_neutral_table');
  const neg = document.getElementById('scenario_negative_table');

  if(pos){
    if(neutral) neutral.innerHTML = pos.innerHTML.replace(/id="scenario_positive_table"/g, 'id="scenario_neutral_table"');
    if(neg) neg.innerHTML = pos.innerHTML.replace(/id="scenario_positive_table"/g, 'id="scenario_negative_table"');
    return;
  }

  if(neutral){
    // fallback: copy neutral into others
    if(pos) pos.innerHTML = neutral.innerHTML.replace(/id="scenario_neutral_table"/g, 'id="scenario_positive_table"');
    if(neg) neg.innerHTML = neutral.innerHTML.replace(/id="scenario_neutral_table"/g, 'id="scenario_negative_table"');
  }
}

// Sync neutral and negative tables to use the same structure as the positive table
function syncTablesFromPositive(){
  const pos = document.getElementById('scenario_positive_table');
  if(!pos) return;
  ['neutral','negative'].forEach(k=>{
    const dstId = 'scenario_'+k+'_table';
    const dst = document.getElementById(dstId);
    if(dst){
      // Clone the positive table structure into the destination table while keeping its id
      dst.innerHTML = pos.innerHTML.replace(/id="scenario_positive_table"/g, `id="${dstId}"`);
    }
  });
}

/* KPI ì‹œë‚˜ë¦¬ì˜¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ */
function updateKPIScenario() {
  // KPI ì§€í‘œë¥¼ í˜„ì¬ ì„ íƒëœ ì‹œë‚˜ë¦¬ì˜¤ì™€ ì„¤ì •ì— ë”°ë¼ ì—…ë°ì´íŠ¸
  updateKPIIndicators();
}

window.updateKPIScenario = updateKPIScenario;

/* PDF */
downloadPdf.onclick=async()=>{
  consolidateAnalysis();
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  const canvas=await html2canvas(document.body,{scale:2});
  const img=canvas.toDataURL("image/png");
  pdf.addImage(img,"PNG",0,0,210,canvas.height*210/canvas.width);
  pdf.save("Investment_Portfolio_Summary.pdf");
};
</script>



</body></html>